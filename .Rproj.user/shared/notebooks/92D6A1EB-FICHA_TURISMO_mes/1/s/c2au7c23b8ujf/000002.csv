"0","df_u_ <- cbind(data.frame(do.call('rbind', viajeros_lugar[[""data""]][[""dimCodes""]])), viajeros_lugar[[""data""]][[""Valor""]])"
"0","colnames(df_u_) <- c('ind', 'lugar', 'mun', 'periodo', 'valor')"
"0","df_u_$ind <- factor(df_u_$ind, levels=viajeros_lugar[[""categories""]][[""codes""]][[1]], labels=viajeros_lugar[[""categories""]][[""labels""]][[1]])"
"0","df_u_$lugar <- factor(df_u_$lugar, levels=viajeros_lugar[[""categories""]][[""codes""]][[2]], labels=viajeros_lugar[[""categories""]][[""labels""]][[2]])"
"0","df_u_$valor <- as.numeric(df_u_$valor)"
"0","df_u_ <- df_u_ %>% mutate(lugar = recode(lugar, "" TOTAL RESIDENTES EN ESPAÑA"" = ""España""))"
"0",""
"0","df_u_ <- df_u_ %>% filter(substring(periodo, 5,5) == ""M"")"
"0","df_u_$periodo <- paste0(substring(df_u_$periodo, 0,4), ""-"", substring(df_u_$periodo, 6,7))"
"0","df_u <- df_u_ %>% filter(lugar == ""TOTAL LUGARES DE RESIDENCIA"" & ind == ""Viajeros alojados"") %>% select(mun, periodo, valor)"
"0",""
"0","num_Canarias_total <- df_u %>% filter(mun == ""ES70"" & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()"
"0","num_Isla_total <- df_u %>% filter(mun == municipio_actual$id_isla & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()"
"0",""
"0","df_u <- df_u[with(df_u, order(periodo)), ]"
"0","df_u <- df_u %>%"
"0","  filter(substring(mun, 0,1) == ""3"") %>% "
"0","  arrange(periodo) %>% "
"0","  select(mun, periodo, valor)"
"0",""
"0","related_mun <- df_u %>% filter(periodo == mes_actual$code)"
"0","related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')"
"0",""
"0","leyenda.template <- ""<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Personas alojadas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"""
"0","leyenda.content <- ""<span class='sp-municipio'>%s</span><br/>Personas alojadas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"""
"0",""
"0","g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)"
"0",""
"0","df <- related_mun %>%"
"0","  select(mun, nombre) %>%"
"0","  left_join(df_u, by = ""mun"") %>%"
"0","  select(id = mun, periodo, nombre, valor) %>%"
"0","  left_join(df_CL_AREA_mun, by = ""id"") %>%"
"0","  select(id, code = periodo, nombre, valor) %>%"
"0","  left_join(mes, by = ""code"") %>%"
"0","  transform(tasa = ifelse(substring(code, 0,4) != min(substring(code, 0,4)), round(100*((valor / lag(valor, n = 12)) - 1), 1), NA)) %>% "
"0","  filter(order < mes_actual$order+1)"
"0",""
"0","if(substring(mes_actual$code, 0,4) != 2010){"
"0","  df <- df %>% filter(substring(code, 0,4) != 2009)"
"0","}"
"0",""
"0","año_min <- min(as.integer(substring(df$code, 0,4)))"
"0","año_max <- max(as.integer(substring(df$code, 0,4)))"
"0",""
"0","leyenda_poblacion <- df %>% filter(code == mes_actual$code) %>%"
"0","  mutate(valor = ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")),"
"0","         tasa = ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%""))) %>%"
"0","  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = ""nombre"")"
"0",""
"0","df <- df %>% mutate("
"0","    tooltip = ifelse(code == mes_actual$code,"
"0","                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")),"
"0","                             ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%""))),"
"0","                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")), ' (',periodo_formatted,')'),"
"0","                             ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%"")))"
"0","    )"
"0",")"
"0",""
"0","g_line <- ggplot(data = df, aes(x = reorder(code, order), y = valor, group = nombre, colour = nombre, text = tooltip)) +"
"0","  geom_line(size = 0.7) +"
"0","  theme_minimal() +"
"0","  theme(axis.title.x = element_blank(),"
"0","        axis.title.y = element_blank(),"
"0","        axis.text.x = element_text(),"
"0","        panel.grid.major.x = element_blank(),"
"0","        panel.grid.minor.x = element_blank(),"
"0","        legend.position = ""none"") +"
"0","  scale_colour_manual(values = g_line_colours) +"
"0","  scale_size_manual(values = c(1, 0.1, 0.1)) +"
"0","  scale_x_discrete(breaks = function(x){paste0(año_min:año_max, ""-01"") }, labels = function(x){substr(x, 0,4)}) +"
"0","  scale_y_continuous(labels = function(x){paste0(format(x/10^3, big.mark = ""."", decimal.mark = "",""), "" mil"")}, n.breaks = 5, limits = c(0, NA))"
"0",""
"0","g_line <- ggplotly(g_line, tooltip = ""text"") %>%"
"0","  config(displaylogo = FALSE, modeBarButtons = list(list(""zoom2d""),list(""pan2d""),list(""resetScale2d""),list(""toImage""))) %>%"
"0","  layout(hoverlabel = """", hovermode = 'x unified',"
"0","         xaxis = list(autorange = FALSE,"
"0","                      range = c(max(0.8, nrow(df[df$id == params$id_municipio, ]) - 5*12),"
"0","                                nrow(df[df$id == params$id_municipio, ])"
"0","                                ),"
"0","                      rangeslider = list(type = ""date"", thickness = 0.04))) %>%"
"0","  onRender("""
"0","    function(el) {"
"0","      var municipios = document.getElementsByClassName('sp-municipio');"
"0","      var contents = document.getElementsByClassName('sp-content');"
"0","      var init_contents = [];"
"0","      for (var i = 0; i < municipios.length; i++) {"
"0","        init_contents[i] = contents[i].innerHTML;"
"0","      }"
"0","      "
"0","      el.on('plotly_hover', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_unhover', function(d) {"
"0","        reset(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_click', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      function highlight(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = '<span class=\""sp-municipio\"">' + municipios[i].textContent + '</span>';"
"0","        }"
"0","        for (point in d.points) {"
"0","          for (var i = 0; i < municipios.length; i++) {"
"0","            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {"
"0","              var x = d.points[point].x;"
"0","              contents[i].innerHTML = d.points[point].text;"
"0","            }"
"0","          }"
"0","        }"
"0","      }"
"0","      "
"0","      function reset(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = init_contents[i];"
"0","        }"
"0","      }"
"0","    }"
"0","  "") "
