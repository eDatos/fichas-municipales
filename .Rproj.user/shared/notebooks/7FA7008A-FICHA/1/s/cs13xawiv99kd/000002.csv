"0","data_u <- fromJSON(params$url.habitantes)"
"0","df_u <- data.frame("
"0","  mun = rep(names(data_u[[""dimension""]][[""GEOGRAPHICAL""]][[""representation""]][[""index""]]),"
"0","                  each=data_u[[""dimension""]][[""TIME""]][[""representation""]][[""size""]] * data_u[[""dimension""]][[""MEASURE""]][[""representation""]][[""size""]]),"
"0","  año = rep(names(data_u[[""dimension""]][[""TIME""]][[""representation""]][[""index""]]),"
"0","            each=data_u[[""dimension""]][[""MEASURE""]][[""representation""]][[""size""]]),"
"0","  medida = names(data_u[[""dimension""]][[""MEASURE""]][[""representation""]][[""index""]]),"
"0","  valor = round(as.numeric(data_u[[""observation""]]), 1)) %>%"
"0","  arrange(año) %>%"
"0","  spread(medida, valor) %>%"
"0","  select(mun, año, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)"
"0","df_u$año <- as.integer(df_u$año)"
"0",""
"0","related_mun <- df_u %>% filter(año == params$año)"
"0","related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')"
"0",""
"0","df <- related_mun %>%"
"0","  select(mun, nombre) %>%"
"0","  left_join(df_u, by = ""mun"") %>%"
"0","  select(id = mun, año, nombre, valor, tasa) %>%"
"0","  left_join(df_CL_AREA_mun, by = ""id"") %>%"
"0","  select(mun = id, año, nombre, valor, tasa) "
"0",""
"0","if(params$año == 2001){"
"0","  df <- df %>% filter(año %in% c(2001,2002,2003))"
"0","  }else if(params$año == 2002){"
"0","    df <- df %>% filter(año <= params$año)"
"0","    }else{"
"0","      df <- df %>% filter(año != 2000 & año <= params$año)"
"0","    }"
"0",""
"0","g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)"
"0",""
"0","leyenda.template <- ""<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"""
"0","leyenda.content <- ""<span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"""
"0",""
"0","leyenda_poblacion <- df %>% filter(año == params$año) %>%"
"0","  mutate(valor = ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")),"
"0","         tasa = ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%""))) %>%"
"0","  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = ""nombre"")"
"0",""
"0","df <- df %>% mutate("
"0","    tooltip = ifelse(año == params$año,"
"0","                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")),"
"0","                             ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%""))),"
"0","                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), "" -"", format(valor, big.mark = ""."", decimal.mark = "","")), ' (',año,')'),"
"0","                             ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%"")))"
"0","    )"
"0",") "
"0",""
"0","g_line <- ggplot(data = df, "
"0","                 aes(x = año, y = valor, group = nombre, colour = nombre, text = tooltip)) +"
"0","  geom_line(size = 0.7) +"
"0","  theme_minimal() +"
"0","  theme(axis.title.x = element_blank(),"
"0","        axis.title.y = element_blank(),"
"0","        axis.text.x = element_text(),"
"0","        panel.grid.major.x = element_blank(),"
"0","        panel.grid.minor.x = element_blank(),"
"0","        legend.position = ""none"") +"
"0","  scale_colour_manual(values = g_line_colours) +"
"0","  scale_size_manual(values = c(1, 0.1, 0.1)) +"
"0","  scale_x_continuous(breaks = function(x){seq(from = max(max(df$año) - 18, min(df$año)), to = max(df$año), by = max(1, as.integer((max(df$año)-max(max(df$año) - 18, min(df$año)))/4)))}) +"
"0","  scale_y_continuous(labels = function(x){paste0(format(as.integer(x), big.mark = ""."", decimal.mark = "",""), """")}, n.breaks = 6, limits = c(0, NA))"
"0",""
"0","g_line <- ggplotly(g_line, tooltip = ""text"") %>%"
"0","  config(displaylogo = FALSE, modeBarButtons = list(list(""zoom2d""),list(""pan2d""),list(""resetScale2d""),list(""toImage""))) %>%"
"0","  layout(hoverlabel = """", hovermode = 'x unified',"
"0","         xaxis = list(autorange = FALSE,"
"0","                      range = c(max(max(df$año) - 18, min(df$año)), max(df$año)),"
"0","                      rangeslider = list(type = ""date"", thickness=0.04))) %>%"
"0","  onRender("""
"0","    function(el) {"
"0","      var municipios = document.getElementsByClassName('sp-municipio');"
"0","      var contents = document.getElementsByClassName('sp-content');"
"0","      var init_contents = [];"
"0","      for (var i = 0; i < municipios.length; i++) {"
"0","        init_contents[i] = contents[i].innerHTML;"
"0","      }"
"0","      "
"0","      el.on('plotly_hover', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_unhover', function(d) {"
"0","        reset(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_click', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      function highlight(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = '<span class=\""sp-municipio\"">' + municipios[i].textContent + '</span>';"
"0","        }"
"0","        for (point in d.points) {"
"0","          for (var i = 0; i < municipios.length; i++) {"
"0","            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {"
"0","              var x = d.points[point].x;"
"0","              contents[i].innerHTML = d.points[point].text;"
"0","            }"
"0","          }"
"0","        }"
"0","      }"
"0","      "
"0","      function reset(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = init_contents[i];"
"0","        }"
"0","      }"
"0","    }"
"0","  "") "
