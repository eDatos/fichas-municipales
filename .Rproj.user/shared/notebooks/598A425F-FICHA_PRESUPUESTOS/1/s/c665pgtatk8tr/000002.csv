"0","# Presupuesto inicial"
"0","data_I <- fromJSON(params$url.presupuesto_1_inicial)"
"0","dI <- length(rep(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]],"
"0","                 each = length(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]]) *"
"0","                        length(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[3]][[""code""]]))) -"
"0","      length(unlist(strsplit(data_I[[""data""]][[""observations""]], split = "" | "", fixed = TRUE)))"
"0",""
"0","###### Añadir aviso si la variable d_ es mayor que 0 ######"
"0",""
"0","df_I <- data.frame(año = rep(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]],"
"0","                             each = length(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]])),"
"0","                   mun = rep(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]],"
"0","                             times = length(data_I[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]])),"
"0","                   valor = c(unlist(strsplit(data_I[[""data""]][[""observations""]], split = "" | "", fixed = TRUE)), rep(NA, dI)))"
"0","df_I$valor <- as.numeric(df_I$valor)"
"0","df_I <- recode_Frontera(df_I)"
"1","Joining, by = c(""año"", ""mun"", ""valor"")
"
"0","df_I$mun <- recode_id_Frontera(df_I, 'mun')"
"0","df_I <- df_I[with(df_I, order(año)), ] %>%"
"0","  filter(mun == params$id_municipio) %>%"
"0","  mutate(valor_M = round(valor / 10^6, 1), año = as.integer(año)) %>%"
"0","  transform(mun = paste0(municipio_actual$municipio, ""_inicial"")) %>%"
"0","  filter(año <= params$año)"
"0",""
"0","# Liquidación del presupuesto consolidado de ingresos y gastos de las Entidades Locales según capítulos de la estructura económica y fases presupuestarias. Islas y municipios de Canarias por años 2002-2019 [tabla1]"
"0","data_u <- fromJSON(params$url.presupuesto_1)"
"0",""
"0","du <- length(rep(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]],"
"0","                 each = length(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]]))) -"
"0","      length(unlist(strsplit(data_u[[""data""]][[""observations""]], split = "" | "", fixed = TRUE)))"
"0",""
"0","###### Añadir aviso si la variable d_ es mayor que 0 ######"
"0",""
"0","df_u <- data.frame(año = rep(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]],"
"0","                             each = length(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]])),"
"0","                   mun = rep(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[2]][[""code""]],"
"0","                             times = length(data_u[[""data""]][[""dimensions""]][[""dimension""]][[""representations""]][[""representation""]][[1]][[""code""]])),"
"0","                   valor = c(unlist(strsplit(data_u[[""data""]][[""observations""]], split = "" | "", fixed = TRUE)), rep(NA, du)))"
"0","df_u$valor <- as.numeric(df_u$valor)"
"0","df_u <- recode_Frontera(df_u)"
"1","Joining, by = c(""año"", ""mun"", ""valor"")
"
"0","df_u$mun <- recode_id_Frontera(df_u, 'mun')"
"0","df_u <- df_u[with(df_u, order(año)), ] %>%"
"0","  mutate(valor_M = round(valor / 10^6, 1), año = as.integer(año))"
"0",""
"0","related_mun <- df_u %>% filter(año == params$año)"
"0","related_mun <- seleccion_mun(related_mun  %>% select(mun, valor), 'valor')"
"0",""
"0","leyenda.template_I <- ""<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Presupuesto inicial: <span class='sp-habitantes'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"""
"0","leyenda.template <- ""<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"""
"0","leyenda.content_I <- ""<span class='sp-municipio'>%s</span><br/>Presupuesto inicial: <span class='sp-habitantes'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"""
"0","leyenda.content <- ""<span class='sp-municipio'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"""
"0",""
"0","df <- related_mun %>%"
"0","  select(mun, nombre) %>%"
"0","  left_join(df_u, by = ""mun"") %>%"
"0","  select(id = mun, año, nombre, valor, valor_M) %>%"
"0","  left_join(df_CL_AREA_mun, by = ""id"") %>%"
"0","  select(año, mun = id, nombre, valor, valor_M) %>% "
"0","  mutate(tasa =  round(100*((valor / lag(valor)) - 1), 1), año = as.integer(año)) %>%"
"0","  filter(año != min(año) & año <= params$año)"
"0",""
"0","g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)"
"0",""
"0","df <- left_join(df, df_I %>% select(año, valor_inicial = valor_M), by = ""año"") %>% "
"0","  mutate(valor_inicial_l = ifelse(is.na(valor_inicial), "" -"", paste0(format(valor_inicial, big.mark = ""."", decimal.mark = "","", nsmall = 1), "" mill.€"")),"
"0","         valor_l = ifelse(is.na(valor_M), "" -"", paste0(format(valor_M, big.mark = ""."", decimal.mark = "","", nsmall = 1), "" mill.€"")),"
"0","         tasa_l = ifelse(is.na(tasa), "" -"", paste0(format(tasa, big.mark = ""."", decimal.mark = "","", nsmall = 1), ""%"")))"
"0",""
"0","leyenda_poblacion <- df %>% filter(año == params$año) %>%"
"0","  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = ""nombre"")"
"0",""
"0","df <- df %>%"
"0","  mutate("
"0","    tooltip = ifelse("
"0","      año == params$año,"
"0","      ifelse("
"0","        mun == params$id_municipio,"
"0","        sprintf(leyenda.content_I, nombre, valor_inicial_l, valor_l, tasa_l),"
"0","        sprintf(leyenda.content, nombre, valor_l, tasa_l)"
"0","        ),"
"0","      ifelse("
"0","        mun == params$id_municipio,"
"0","        sprintf(leyenda.content_I, nombre, paste0(valor_inicial_l, ' (',año,')'), valor_l, tasa_l),"
"0","        sprintf(leyenda.content, nombre, paste0(valor_l, ' (',año,')'), tasa_l)"
"0","        )"
"0","      )"
"0","    )"
"0",""
"0","g_line <- ggplot(data = df, aes(x = año)) +"
"0","  geom_line(size = 0.7, aes(y = valor_M, group = nombre, colour = nombre, text = tooltip)) +"
"0","  theme_minimal() +"
"0","  theme(axis.title.x = element_blank(),"
"0","        axis.title.y = element_blank(),"
"0","        axis.text.x = element_text(),"
"0","        panel.grid.major.x = element_blank(),"
"0","        panel.grid.minor.x = element_blank(),"
"0","        legend.position = ""none"") +"
"0","  scale_colour_manual(values = g_line_colours) +"
"0","  scale_x_continuous(breaks = function(x){seq(from = min(df$año), to = max(df$año), by = as.integer((max(df$año)-min(df$año))/3))}) +"
"0","  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ""."", decimal.mark = "",""), "" mill."")}, n.breaks = 5, limits = c(0, NA))"
"0",""
"0","g_line <- ggplotly(g_line, tooltip = ""text"") %>%"
"0","  config(displaylogo = FALSE, modeBarButtons = list(list(""zoom2d""),list(""pan2d""),list(""resetScale2d""),list(""toImage""))) %>%"
"0","  layout(hoverlabel = """", hovermode = 'x unified',"
"0","         xaxis = list(autorange = FALSE,"
"0","                      range = c(max(min(df$año), params$año - 18), params$año),"
"0","                      rangeslider = list(type = ""date"", thickness = 0.04))) %>%"
"0","  onRender("""
"0","    function(el) {"
"0","      var municipios = document.getElementsByClassName('sp-municipio');"
"0","      var contents = document.getElementsByClassName('sp-content');"
"0","      var init_contents = [];"
"0","      for (var i = 0; i < municipios.length; i++) {"
"0","        init_contents[i] = contents[i].innerHTML;"
"0","      }"
"0","      "
"0","      el.on('plotly_hover', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_unhover', function(d) {"
"0","        reset(d);"
"0","      });"
"0","      "
"0","      el.on('plotly_click', function(d) {"
"0","        highlight(d);"
"0","      });"
"0","      "
"0","      function highlight(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = '<span class=\""sp-municipio\"">' + municipios[i].textContent + '</span>';"
"0","        }"
"0","        for (point in d.points) {"
"0","          for (var i = 0; i < municipios.length; i++) {"
"0","            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {"
"0","              var x = d.points[point].x;"
"0","              contents[i].innerHTML = d.points[point].text;"
"0","            }"
"0","          }"
"0","        }"
"0","      }"
"0","      "
"0","      function reset(d) {"
"0","        for (var i = 0; i < municipios.length; i++) {"
"0","          contents[i].innerHTML = init_contents[i];"
"0","        }"
"0","      }"
"0","    }"
"0","  "")"
