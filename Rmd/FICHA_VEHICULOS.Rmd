---
title: ''
params:
  id_municipio: 38002
  año: 2021
  mes: 1
  url.mes: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/MATRICULA_VEHICULOS
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.matricula: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/MATRICULA_VEHICULOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BREGIONS%7CMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.matricula_tur: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/MATRICULA_VEHICULOS_TURISMOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.parque: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BREGIONS%7CMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.parque_tur: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS_TURISMOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.parque_hab: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS_HABITANTE/data?granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.parque_hab_tur: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS_TURISMOS_HABITANTE/data?representation=representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.tipos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=9019908a-7837-4af4-bef0-b4cfa226cb15
  url.matr_tipos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=71de0bba-9447-4c77-8ba5-3e660f535233
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)
```

```{r funciones, include=FALSE}
signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")

get_nombre <- function(nombre) {
  string_list <- str_split(nombre, pattern = " ")[[1]]
  result <- ""
  line.char <- 0
  for(word.index in 1:length(string_list)) {
    if((line.char + nchar(string_list[word.index])) < 17) {
      result <- paste0(result, " ", string_list[word.index])
      line.char <- line.char + 1 + nchar(string_list[word.index])
    } else {
      result <- paste0(result, "<br>", string_list[word.index])
      line.char <- nchar(string_list[word.index])
    }
  }
  trimws(result)
}
```

```{r Mes}
data_mes <- fromJSON(params$url.mes)

mes <- data.frame(code = data_mes[["dimension"]][["TIME"]][["representation"]][["code"]],
                  periodo = data_mes[["dimension"]][["TIME"]][["representation"]][["title"]][["es"]],
                  granularidad = data_mes[["dimension"]][["TIME"]][["representation"]][["granularityCode"]]) %>% 
  filter(granularidad == "MONTHLY") %>% select(!granularidad)

mes <- mes %>% 
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1)))) %>% 
  mutate(order = as.integer(order(mes$code, decreasing = FALSE)))
mes_actual <- mes %>% filter(substring(code, 0,4) == params$año & as.numeric(substring(code, 6,8)) == params$mes)
mes_tva <- mes[mes$order == mes[mes_actual$code == mes$code, ]$order - 12, ]
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>% 
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>%
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Pinar de El Hierro, El", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
palette <- c('#8CD2EA', '#005980')

mapa_Canarias <- st_read(params$url.mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% 
  select(-c(notas, utm_x_capi, utm_y_capi, long_capi, lati_capi)) %>%
  st_sf

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)

mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla) %>% select(geocode, col)

mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)

mapa_comarca <- filter(mapa_Canarias, mapa_Canarias$geocode %in% (df_CL_AREA_mun[df_CL_AREA_mun$id_comarca == municipio_actual$id_comarca,]$id)) %>% select(geocode, col)

mapa_comarca_plot <- tm_shape(mapa_comarca) + 
                     tm_borders() + 
                     tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                     tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                     tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución}
# Número de vehículos en circulación según datos del parque de vehículos elaborados por la Dirección General de Tráfico. La fecha de referencia es el último día de cada mes.
data_u <- fromJSON(params$url.parque)

df_u <- data.frame(
  mun = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_u[["dimension"]][["TIME"]][["representation"]][["size"]] * data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  mes = rep(names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = round(as.numeric(data_u[["observation"]]), 1)) %>%
  spread(medida, valor) %>%
  select(mun, mes, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)

año_min <- min(df_u$mes) %>% substring(0,4) %>% as.numeric()
año_max <- max(df_u$mes) %>% substring(0,4) %>% as.numeric()

related_mun <- df_u %>% filter(mes == mes_actual$code & mun != "ES70")
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

df <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, mes, nombre, valor, tasa) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(id, code = mes, nombre, valor, tasa) %>%
  left_join(mes, by = "code")

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Número de vehículos: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Número de vehículos: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

leyenda_poblacion <- df %>% filter(code == mes_actual$code) %>%
  mutate(valor = ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))) %>%
  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "nombre")

df <- df %>% mutate(
    tooltip = ifelse(code == mes_actual$code,
                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")), ' (',periodo_formatted,')'),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
    )
)

g_line <- ggplot(data = df, 
                 aes(x = reorder(code, order), y = valor, group = nombre, colour = nombre, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_discrete(breaks = function(x) {paste0(año_min:año_max,"-01")}, labels = function(x){substr(x, 0, 4)}) +
  scale_y_continuous(labels = function(x) {paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(0.8, nrow(df[df$nombre == municipio_actual$municipio, ]) - 5*12),
                                nrow(df[df$nombre == municipio_actual$municipio, ])
                                ),
                      rangeslider = list(type = "date", thickness = 0.04))) %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) { highlight(d); });
      el.on('plotly_unhover', function(d) { reset(d); });
      el.on('plotly_click', function(d) { highlight(d); });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 
```

```{r Indicadores}
df_lv <- df_u %>% filter(mun == params$id_municipio & mes == mes_actual$code)

Num_Vehiculos <- df_lv %>% select(valor) %>% as.numeric()
Num_Veh_Parque <- df_lv %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Variacion_Porcentual_Veh_Parque <- df_lv %>% select(tasa) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Imagen_Variacion <- ifelse(signo(Variacion_Porcentual_Veh_Parque) == "más", './img/up.png', './img/down.png')

# Número de turismos en circulación según datos del parque de vehículos elaborado por la Dirección General de Tráfico. La fecha de referencia es el último día de cada mes.
data_Tur_Parque <- fromJSON(params$url.parque_tur)

df_Tur_Parque <- data.frame(
  mun = rep(names(data_Tur_Parque[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_Tur_Parque[["dimension"]][["TIME"]][["representation"]][["size"]] * data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  mes = rep(names(data_Tur_Parque[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = as.numeric(data_Tur_Parque[["observation"]]))
df_Tur_Parque$valor <- as.numeric(df_Tur_Parque$valor)

Num_Tur_Parque_num <- df_Tur_Parque %>% filter(mun == params$id_municipio & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric()
Num_Tur_Parque <- df_Tur_Parque %>% filter(mun == params$id_municipio & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric() %>% round(0) %>% 
  format(big.mark = ".", decimal.mark = ",", nsmall = 0)
Percent_Tur_Parque <- round(Num_Tur_Parque_num / Num_Vehiculos * 100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Rankings}
df_ranking <- df_u %>%
  select(id = mun, mes, valor) %>%
  filter(mes == mes_actual$code & !is.na(valor)) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

Num_vehiculos_Canarias <- df_u %>% filter(mun == "ES70" & mes == mes_actual$code) %>% select(valor) %>% as.numeric()

rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_ranking[which(df_ranking$id==params$id_municipio),]$valor / Num_vehiculos_Canarias * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_ranking_isla <- df_ranking %>% filter(isla == municipio_actual$isla)
rk_isla <- grep(params$id_municipio, df_ranking_isla$id)
num_mun_isla <- nrow(df_ranking_isla)
percent_isla <- format(round(df_ranking_isla[which(df_ranking_isla$id==params$id_municipio),]$valor / sum(df_ranking_isla$valor) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_ranking_comarca <- df_ranking %>% filter(comarca == municipio_actual$comarca)
rk_comarca <- grep(params$id_municipio, df_ranking_comarca$id)
num_mun_comarca <- nrow(df_ranking_comarca)
percent_comarca <- format(round(df_ranking_comarca[which(df_ranking_comarca$id==params$id_municipio),]$valor / sum(df_ranking_comarca$valor) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Tipos de vehículo y tipos de combustible}
data_tipos <- fromJSON(params$url.tipos)

df_tipos <- cbind(data.frame(do.call('rbind', data_tipos[["data"]][["dimCodes"]])), data_tipos[["data"]][["Valor"]])
colnames(df_tipos) <- c('veh', 'combustible', 'mun', 'periodo', 'valor')
df_tipos$veh <- factor(df_tipos$veh, levels=data_tipos[["categories"]][["codes"]][[1]], labels=data_tipos[["categories"]][["labels"]][[1]])
df_tipos$combustible <- factor(df_tipos$combustible, levels=data_tipos[["categories"]][["codes"]][[2]], labels=data_tipos[["categories"]][["labels"]][[2]])
df_tipos$mun <- factor(df_tipos$mun, levels=data_tipos[["categories"]][["codes"]][[3]], labels=data_tipos[["categories"]][["labels"]][[3]])
df_tipos$periodo <- factor(df_tipos$periodo, levels=data_tipos[["categories"]][["codes"]][[4]],
                           labels=paste0(substring(data_tipos[["categories"]][["codes"]][[4]], 0,4), "-", substring(data_tipos[["categories"]][["codes"]][[4]], 6,7)))
df_tipos$valor <- as.numeric(df_tipos$valor)
df_tipos$mun <- recode_mun(df_tipos, 'mun')
```

```{r Barras Tipos de vehículo}
rk_vehiculos_mun <- df_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & combustible == "TOTAL" & veh != "TOTAL" & substring(veh, 0,1) != " ") %>%
  arrange(desc(veh)) %>%
  arrange(valor) %>%
  select(veh, valor)
rk_vehiculos_mun$veh <- ordered(rk_vehiculos_mun$veh, levels = rk_vehiculos_mun$veh)
rk_vehiculos_mun <- rk_vehiculos_mun %>% 
  mutate(order = as.integer(rk_vehiculos_mun$valor, decreasing = FALSE))

df_vehiculos_mun <- df_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & combustible == "TOTAL" & veh != "TOTAL" & substring(veh, 0,1) != " ") %>% 
  select(veh, valor)

df_vehiculos_C <- df_tipos %>%
  filter(mun == "CANARIAS" & periodo == mes_actual$code & combustible == "TOTAL" & veh != "TOTAL" & substring(veh, 0,1) != " ") %>% 
  select(veh, valor)
df_vehiculos_mun <- df_vehiculos_mun %>%
  mutate(porcentaje = df_vehiculos_mun$valor / Num_Vehiculos * 100,
         valor_Canarias = df_vehiculos_C$valor,
         porcentaje_Canarias = df_vehiculos_C$valor / Num_vehiculos_Canarias * 100)

df_vehiculos_plot <- df_vehiculos_mun %>%
  mutate(label = "|")
df_vehiculos_plot$veh <- ordered(df_vehiculos_plot$veh, levels = rk_vehiculos_mun$veh)

df_vehiculos_plot <- df_vehiculos_plot %>%
  left_join(rk_vehiculos_mun, by = c("veh", "valor")) %>% 
  arrange(desc(order))

df_vehiculos_plot <- df_vehiculos_plot %>% transform(hovertext = paste0(
  "<b>", trimws(veh), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_vehiculos_plot$name_veh <- ""
for(i in 1:nrow(df_vehiculos_plot)) {
  df_vehiculos_plot$name_veh[i] <- get_nombre(paste0(df_vehiculos_plot$veh[i]))
}

df_vehiculos_0 <- df_vehiculos_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_vehiculos_plot <- rbind(df_vehiculos_plot, df_vehiculos_0)

col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")

g_vehiculos <- ggplot(data = df_vehiculos_plot, aes(y = reorder(veh, order), fill = veh, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.7, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = col) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')}) +
  scale_y_discrete(labels = df_vehiculos_plot$name_veh[(nrow(df_vehiculos_plot)/2):1])

g_vehiculos <- ggplotly(g_vehiculos, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c((nrow(df_vehiculos_plot)/2+1):nrow(df_vehiculos_plot)))
```

```{r Progress-bar Tipos de combustible}
rk_combustibles_mun <- df_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & combustible != "TOTAL" & veh == "TOTAL" & substring(veh, 0,1) != " ") %>%
  arrange(valor) %>%
  select(combustible, valor)
rk_combustibles_mun <- rk_combustibles_mun %>% mutate(porcentaje = rk_combustibles_mun$valor/ Num_Vehiculos * 100)
rk_combustibles_mun$combustible <- ordered(rk_combustibles_mun$combustible, levels = rk_combustibles_mun$combustible)

df_combustibles_mun <- df_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & combustible != "TOTAL" & veh == "TOTAL" & substring(veh, 0,1) != " ") %>%
  select(combustible, valor)

df_combustibles_mun <- df_combustibles_mun %>%
  mutate(porcentaje = df_combustibles_mun$valor / Num_Vehiculos * 100)

porc_gasolina <- df_combustibles_mun$porcentaje[which(df_combustibles_mun$combustible == "Gasolina")]
porc_diesel <- df_combustibles_mun$porcentaje[which(df_combustibles_mun$combustible == "Diésel")]
porc_gasolina_diesel <- porc_gasolina + porc_diesel
porc_electrico <- df_combustibles_mun$porcentaje[which(df_combustibles_mun$combustible == "Eléctrico")]
porc_otros <- 100 - porc_gasolina - porc_diesel - porc_electrico

porc_gasolina_l <- round(porc_gasolina, 1) %>% as.numeric
porc_diesel_l <- round(porc_diesel, 1) %>% as.numeric
porc_gasolina_diesel_l <- round(porc_gasolina_diesel, 1) %>% as.numeric
porc_electrico_l <- round(porc_electrico, 1) %>% as.numeric
porc_otros_l <- round(porc_otros, 1) %>% as.numeric
```

```{r Progress-bar Otros tipos de combustible}
df_combustibles_otros <- df_combustibles_mun %>%
  filter(combustible %notin% c("Gasolina", "Diésel", "Eléctrico", "Otros")) %>%
  top_n(4) %>% 
  arrange(-valor)

# if(length(df_combustibles_otros$combustible) > 4){
  # df_combustibles_otros <- df_combustibles_otros %>% filter(valor != min(df_combustibles_otros$valor))
# }

df_combustibles_otros <- df_combustibles_otros %>%
  mutate(porcentaje_barra = df_combustibles_otros$valor / sum(df_combustibles_otros$valor) * 100,
         porcentaje = df_combustibles_otros$valor / Num_Vehiculos * 100)

tipo_1 <- df_combustibles_otros$combustible[1]
tipo_2 <- df_combustibles_otros$combustible[2]
tipo_3 <- df_combustibles_otros$combustible[3]
tipo_4 <- df_combustibles_otros$combustible[4]

porc_1 <- df_combustibles_otros$porcentaje_barra[1]
porc_2 <- df_combustibles_otros$porcentaje_barra[2]
porc_3 <- df_combustibles_otros$porcentaje_barra[3]
porc_4 <- df_combustibles_otros$porcentaje_barra[4]
porc_o <- 100 - porc_1 - porc_2 - porc_3 - porc_4

porc_1_l <- round(df_combustibles_otros$porcentaje[1], 1) %>% as.numeric
porc_2_l <- round(df_combustibles_otros$porcentaje[2], 1) %>% as.numeric
porc_3_l <- round(df_combustibles_otros$porcentaje[3], 1) %>% as.numeric
porc_4_l <- round(df_combustibles_otros$porcentaje[4], 1) %>% as.numeric
porc_o_l <- round(porc_otros_l - porc_1_l - porc_2_l - porc_3_l - porc_4_l, 1) %>% as.numeric
```

```{r Matriculaciones}
# Número de vehículos matriculados durante el periodo de referencia.
data_matr <- fromJSON(params$url.matricula)

df_matr <- data.frame(
  mun = rep(names(data_matr[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_matr[["dimension"]][["TIME"]][["representation"]][["size"]] * data_matr[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  mes = rep(names(data_matr[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_matr[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_matr[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = round(as.numeric(data_matr[["observation"]]), 1))
df_matr$valor <- as.numeric(df_matr$valor)

Num_Matriculaciones_num <- df_matr %>% filter(mun == params$id_municipio & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric()
Num_Matriculaciones <- df_matr %>% filter(mun == params$id_municipio & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric() %>%
  format(big.mark = ".", decimal.mark = ",")

# Número de turismos matriculados durante el periodo de referencia.
data_matr_turismos <- fromJSON(params$url.matricula_tur)

df_matr_turismos <- data.frame(
  mun = rep(names(data_matr_turismos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_matr_turismos[["dimension"]][["TIME"]][["representation"]][["size"]] * data_matr_turismos[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  mes = rep(names(data_matr_turismos[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_matr_turismos[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_matr_turismos[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = round(as.numeric(data_matr_turismos[["observation"]]), 1))
df_matr_turismos$valor <- as.numeric(df_matr_turismos$valor)

Num_Matr_turismos <- df_matr_turismos %>% filter(mun == params$id_municipio & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric() %>%
  format(big.mark = ".", decimal.mark = ",")
```

```{r Matriculaciones Tipos}
data_matr_tipos <- fromJSON(params$url.matr_tipos)

df_matr_tipos <- cbind(data.frame(do.call('rbind', data_matr_tipos[["data"]][["dimCodes"]])), data_matr_tipos[["data"]][["Valor"]])
colnames(df_matr_tipos) <- c('veh', 'mun', 'periodo', 'valor')
df_matr_tipos$veh <- factor(df_matr_tipos$veh, levels=data_matr_tipos[["categories"]][["codes"]][[1]], labels=data_matr_tipos[["categories"]][["labels"]][[1]])
df_matr_tipos$mun <- factor(df_matr_tipos$mun, levels=data_matr_tipos[["categories"]][["codes"]][[2]], labels=data_matr_tipos[["categories"]][["labels"]][[2]])
df_matr_tipos$periodo <- factor(df_matr_tipos$periodo, levels=data_matr_tipos[["categories"]][["codes"]][[3]],
                                labels=paste0(substring(data_matr_tipos[["categories"]][["codes"]][[3]], 0,4), "-", substring(data_matr_tipos[["categories"]][["codes"]][[3]], 6,7)))
df_matr_tipos$valor <- as.numeric(df_matr_tipos$valor)
df_matr_tipos$mun <- recode_mun(df_matr_tipos, 'mun')
df_matr_tipos <- df_matr_tipos %>% filter(veh %notin% c("TOTAL", " TOTAL DE AUTOMÓVILES")) %>% 
  mutate(veh = trimws(veh),
         veh = paste0(substring(veh, 0,1), tolower(substring(veh, 2,100))))

rk_matr_tipos_mun <- df_matr_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code) %>%
  arrange(desc(veh)) %>%
  arrange(valor) %>%
  select(veh, valor)
rk_matr_tipos_mun$veh <- ordered(rk_matr_tipos_mun$veh, levels = rk_matr_tipos_mun$veh)

rk_matr_tipos_mun <- rk_matr_tipos_mun %>%
  mutate(order = as.integer(order(rk_matr_tipos_mun$valor, decreasing = FALSE)))

Num_Matriculaciones_C <- df_matr %>% filter(mun == "ES70" & mes == mes_actual$code & medida == "ABSOLUTE") %>% select(valor) %>% as.numeric()
df_matr_tipos_mun <- df_matr_tipos %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code) %>% select(!c(mun, periodo))
df_matr_tipos_C <- df_matr_tipos %>%
  filter(mun == "CANARIAS" & periodo == mes_actual$code) %>% 
  select(veh, valor)
df_matr_tipos_mun <- df_matr_tipos_mun %>%
  mutate(porcentaje = df_matr_tipos_mun$valor / Num_Matriculaciones_num * 100,
         valor_Canarias = df_matr_tipos_C$valor,
         porcentaje_Canarias = df_matr_tipos_C$valor / Num_Matriculaciones_C * 100)

df_matr_tipos_plot <- df_matr_tipos_mun %>%
  mutate(label = "|")
df_matr_tipos_plot$veh <- ordered(df_matr_tipos_plot$veh, levels = rk_matr_tipos_mun$veh)

df_matr_tipos_plot <- df_matr_tipos_plot %>%
  left_join(rk_matr_tipos_mun, by = c("veh", "valor")) %>% 
  arrange(desc(order))

df_matr_tipos_plot <- df_matr_tipos_plot %>% transform(hovertext = paste0(
  "<b>", trimws(veh), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_matr_tipos_plot$name_veh <- ""
for(i in 1:nrow(df_matr_tipos_plot)) {
  df_matr_tipos_plot$name_veh[i] <- get_nombre(paste0(df_matr_tipos_plot$veh[i]))
}

df_matr_tipos_0 <- df_matr_tipos_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_matr_tipos_plot <- rbind(df_matr_tipos_plot, df_matr_tipos_0)

col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0083C4", "#0072A2", "#005980", "#00405B")

g_matr_tipos <- ggplot(data = df_matr_tipos_plot, aes(y = reorder(veh, order), fill = veh, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.7, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = col) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')}) +
  scale_y_discrete(labels = df_matr_tipos_plot$name_veh[(nrow(df_matr_tipos_plot)/2):1])

g_matr_tipos <- ggplotly(g_matr_tipos, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = -5, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c((nrow(df_matr_tipos_plot)/2+1):nrow(df_matr_tipos_plot)))
```


```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r mes_actual$periodo_formatted`</h3>
<h2 style="color: #666; margin: 0;">Parque de vehículos</h2>
<hr>

```{r espacio leyenda, results='asis'}
margin_b <- ifelse(nchar(leyenda_poblacion$nombre[1]) > 26, 48, 15)
```
<div class="linechart-placeholder" style="margin-bottom: `r paste0(margin_b, 'px')`;">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Veh_Parque` vehículos</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$nombre[i], leyenda_poblacion$valor[i], leyenda_poblacion$tasa[i]))
}
```
</div>
</div>

<div class="row">
```{r indicadores principales, results='asis'}
if(Variacion_Porcentual_Veh_Parque == "NA"){
  cat(paste0(
    "<div class='column-3-ind'>", get_indicator2(paste0('Turismos</br></p><p class="label" style="color: #999;">', paste0(Percent_Tur_Parque, '%')), Num_Tur_Parque, './img/family.png'), "</div><div class='column-3-ind'>", get_indicator2("Gasolina<br>+ diesel", paste0(format(porc_gasolina_diesel_l, big.mark = ".", decimal.mark = ",", nsmall = 1), '%'), "./img/female.png"), "</div><div class='column-3-ind'>", get_indicator2("Eléctricos", paste0(format(porc_electrico_l, big.mark = ".", decimal.mark = ",", nsmall = 1), '%'), "./img/male.png"), "</div>"))
}else{
  cat(paste0(
    "<div class='column-4'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual_Veh_Parque, '%'), Imagen_Variacion), "</div><div class='column-4'>", get_indicator2(paste0('Turismos</br></p><p class="label" style="color: #999;">', paste0(Percent_Tur_Parque, '%')), Num_Tur_Parque, './img/family.png'), "</div><div class='column-4'>", get_indicator2("Gasolina<br>+ diesel", paste0(format(porc_gasolina_diesel_l, big.mark = ".", decimal.mark = ",", nsmall = 1), '%'), "./img/female.png"), "</div><div class='column-4'>", get_indicator2("Eléctricos", paste0(format(porc_electrico_l, big.mark = ".", decimal.mark = ",", nsmall = 1), '%'), "./img/male.png"), "</div>"))
}
```
</div>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map">
  <div class="image map-canarias">
```{r}
mapa_Canarias_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_isla_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_comarca_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_comarca`º </span>en la comarca</p>
  <p class="label2">de `r num_mun_comarca` municipios (`r percent_comarca`%)</p>
  </div>
</div>
</div>
</div>

<div class="indicator-title-row">
  <h3>Tipos de vehículos</h3>
</div>

<div class="row">
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Parque</h3>
</div>
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Matriculaciones</h3>
</div>
</div>

<div class="row">
<div class="column highlight" style="padding-top: 40px;">
<div class="piramide" style="height: 320px;">
  `r g_vehiculos`
</div>

<div class="progressbar-legend-container" style="margin: 37px 0;">
  <div class="progressbar-legend">
  <div class="progress-bar-C-a">|</div><div class="sp-content">Canarias</div></div>
</div>
</div>

<div class="column highlight">
<div class="piramide" style="height: 390px;">
  `r g_matr_tipos`
</div>

<div class="progressbar-legend-container" style="margin: 20px 0;">
<div class="progressbar-legend">
<div class="progress-bar-C-a">|</div><div class="sp-content">Canarias</div></div>
</div>

</div>
</div>

<div class="indicator-title-row">
  <h3>Tipos de combustible</h3>
</div>

<div class="row">
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Total</h3>
</div>
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Resto de tipos</h3>
</div>
</div>

<div class="row">
<div class="column highlight" style="height: 210px;">
<div class="progress-bar-container">

```{r, results='asis'}
if(porc_diesel_l == 0 & porc_electrico_l == 0 & porc_otros_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_gasolina, "%'>"))
}else if(porc_electrico_l == 0 & porc_otros_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_gasolina, "%'></div><div class='progress-bar-blue6' style='width:", porc_diesel, "%'>"))
}else if(porc_otros_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_gasolina, "%'></div><div class='progress-bar-blue3' style='width:", porc_diesel, "%'></div><div class='progress-bar-blue6' style='width:", porc_electrico, "%'>"))
}else if(porc_electrico_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_gasolina, "%'></div><div class='progress-bar-blue3' style='width:", porc_diesel, "%'></div><div class='progress-bar-blue6' style='width:", porc_otros, "%'>"))
}else{
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_gasolina, "%'></div><div class='progress-bar-blue3' style='width:", porc_diesel, "%'></div><div class='progress-bar-blue4' style='width:", porc_electrico, "%'></div><div class='progress-bar-blue6' style='width:", porc_otros, "%'>"))
}
```
  </div>
</div>

<div class="legend-vertical-container" style="margin-top: 60px;">
```{r, results='asis'}
if(porc_diesel_l == 0 & porc_electrico_l == 0 & porc_otros_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Gasolina (", format(porc_gasolina_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_electrico_l == 0 & porc_otros_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Gasolina (", format(porc_gasolina_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Diésel (", format(porc_diesel_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_otros_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Gasolina (", format(porc_gasolina_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>Diésel (", format(porc_diesel_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Eléctrico (", format(porc_electrico_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_electrico_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Gasolina (", format(porc_gasolina_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>Diésel (", format(porc_diesel_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Resto de tipos de combustible (", format(porc_otros_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else{
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Gasolina (", format(porc_gasolina_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>Diésel (", format(porc_diesel_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue4'></div><div class='sp-content'>Eléctrico (", format(porc_electrico_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Resto de tipos de combustible (", format(porc_otros_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}
```
  </div></div>
</div>
</div>

<div class="column highlight" style="height: 210px;">
<div class="progress-bar-container">

```{r, results='asis'}
if(porc_2_l == 0 & porc_3_l == 0 & porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_1, "%'>"))
}else if(porc_3_l == 0 & porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_1, "%'></div><div class='progress-bar-blue6' style='width:", porc_2, "%'>"))
}else if(porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_1, "%'></div><div class='progress-bar-blue3' style='width:", porc_2, "%'></div><div class='progress-bar-blue6' style='width:", porc_3, "%'>"))
}else if(porc_o_l == 0){
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_1, "%'></div><div class='progress-bar-blue3' style='width:", porc_2, "%'></div><div class='progress-bar-blue4' style='width:", porc_3, "%'></div><div class='progress-bar-blue6' style='width:", porc_4, "%'>"))
}else{
  cat(paste0(
    "<div class='progress-bar-blue1' style='width:", porc_1, "%'></div><div class='progress-bar-blue3' style='width:", porc_2, "%'></div><div class='progress-bar-blue4' style='width:", porc_3, "%'></div><div class='progress-bar-blue5' style='width:", porc_4, "%'></div><div class='progress-bar-blue6' style='width:", porc_o, "%'>"))
}
```
  </div>
</div>

<div class="legend-vertical-container" style="margin-top: 60px;">
```{r, results='asis'}
if(porc_2_l == 0 & porc_3_l == 0 & porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>", tipo_1, " (", format(porc_1_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_3_l == 0 & porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>", tipo_1, " (", format(porc_1_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>", tipo_2, " (", format(porc_2_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_4_l == 0 & porc_o_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>", tipo_1, " (", format(porc_1_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>", tipo_2, " (", format(porc_2_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>", tipo_3, " (", format(porc_3_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else if(porc_o_l == 0){
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>", tipo_1, " (", format(porc_1_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>", tipo_2, " (", format(porc_2_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue4'></div><div class='sp-content'>", tipo_3, " (", format(porc_3_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>", tipo_4, " (", format(porc_4_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}else{
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>", tipo_1, " (", format(porc_1_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue3'></div><div class='sp-content'>", tipo_2, " (", format(porc_2_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue4'></div><div class='sp-content'>", tipo_3, " (", format(porc_3_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue5'></div><div class='sp-content'>", tipo_4, " (", format(porc_4_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)</div></div><div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Resto de tipos de combustible (", format(porc_o_l, big.mark = '.', decimal.mark = ',', nsmall = 1), "%)"))
}
```
  </div></div>
</div>
</div>

</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

