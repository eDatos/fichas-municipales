---
title: ''
params:
  id_municipio: 35034
  año: 2020
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mun_turisticos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/ALOJATUR_VIAJEROS_ENTRADOS
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.piramide_t: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=1b5cca0a-e5b4-4380-b2fe-41cfa0ab55a6
  url.estancia: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=367e2066-b73c-4ce7-beac-89350e1971c2
  url.sl_aloj: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=9b2e3158-2035-447e-9156-2825a6a999e4
  # url.educacion: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=01946875-8fb5-4cc6-a1ed-0f6ebd135030
  url.ingresos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=75e76f79-d3c1-433b-b3ac-0bafe7a19f04
  # url.motivacion: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=850cd29b-039e-4a55-9588-8f827c4f8333
  url.proposito: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=3f1290db-cfcd-4728-b040-2ee149e3bce5
  url.visitas: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=bb9d27e9-5465-40f8-99e9-25d7c700e29a
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías}
library(jsonlite)
library(ggplot2)
library(knitr)
library(data.table)
library(plotly)
library(plyr)
library(dplyr)
library(scales)
library(htmlwidgets)
library(sf)
library(fuzzyjoin)
library(xml2)
library(XML)
library(tidyverse)
library(tmap)
library(magrittr)
library(ggpol)
library(reshape2)

signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

# Municipios turísticos
mun_turisticos <- fromJSON(params$url.mun_turisticos)
df_CL_AREA_mun_tur <- df_CL_AREA_mun %>% filter(id %in% mun_turisticos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]])

municipio_actual <- df_CL_AREA_mun_tur[df_CL_AREA_mun_tur$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
mapa_Canarias <- st_read(params$url.mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% st_sf

palette <- c('#8CD2EA', '#005980')
mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla)

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)


mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución de la población turística}
# Turistas según grupos de edades y sexos por países de residencia. Municipios turísticos de Canarias y periodos. 2018 a 2020.
piramide <- fromJSON(params$url.piramide_t)
df_u_ <- cbind(data.frame(do.call('rbind', piramide[["data"]][["dimCodes"]])), piramide[["data"]][["Valor"]])
colnames(df_u_) <- c('gredad', 'sexo', 'pais', 'mun', 'año', 'Valor')
df_u_$gredad <- ordered(df_u_$gredad, levels=piramide[["categories"]][["codes"]][[1]], labels=piramide[["categories"]][["labels"]][[1]])
df_u_$sexo <- factor(df_u_$sexo, levels=piramide[["categories"]][["codes"]][[2]], labels=piramide[["categories"]][["labels"]][[2]])
df_u_$pais <- factor(df_u_$pais, levels=piramide[["categories"]][["codes"]][[3]], labels=piramide[["categories"]][["labels"]][[3]])
df_u_$año <- as.integer(df_u_$año)
df_u_$Valor <- as.numeric(df_u_$Valor)

num_Canarias_total <- df_u_ %>% filter(mun == "ES70" & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "AMBOS SEXOS" & pais == "TOTAL" & año == params$año) %>% 
  select(Valor) %>% as.numeric()
num_Isla_total <- df_u_ %>% filter(mun == municipio_actual$id_isla & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "AMBOS SEXOS" & pais == "TOTAL" & año == params$año) %>%
  select(Valor) %>% as.numeric()

df_u <- df_u_ %>% filter(gredad == "TOTAL GRUPOS DE EDADES" & sexo == "AMBOS SEXOS" & pais == "TOTAL" & substring(mun, 6,7) == "_3") %>%
  transform(mun = substr(mun, 7, 12)) %>% 
  select(c('mun','año', 'Valor'))
df_u <- df_u[with(df_u, order(año)), ]

related_mun <- df_u %>% filter(año == params$año)
related_mun <- seleccion_mun(related_mun %>% select(mun, Valor), 'Valor')

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Turistas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Turistas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

df <- related_mun %>%
  select("mun") %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, año, Valor) %>%
  left_join(df_CL_AREA_mun_tur, by = "id") %>%
  mutate(Tasa = ifelse(año == min(año), NA, round(100*((Valor / lag(Valor)) - 1), 1))) %>% 
  filter(año <= params$año)

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)

df <- df %>%
  mutate(Valor_l = ifelse(is.na(Valor), " -", format(Valor, big.mark = ".", decimal.mark = ",")),
         Tasa_l = ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ","), "%")))

leyenda_poblacion <- df %>% filter(año == params$año) %>%
  left_join(data.frame(cbind(municipio = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "municipio")

df <- df %>% mutate(
  tooltip = ifelse(año == params$año,
                   sprintf(leyenda.content, municipio, Valor_l, Tasa_l),
                   sprintf(leyenda.content, municipio, paste0(Valor_l, ' (',año,')'), Tasa_l)
                   )
  )

g_line <- ggplot(data = df, aes(x = año, y = Valor, group = municipio, colour = municipio, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_continuous(breaks = c(2018:2020), labels = c(2018:2020)) +
  scale_y_continuous(labels = function(x){paste0(format(x/10^3, big.mark = ".", decimal.mark = ","), " mil")}, n.breaks = 5, limits = c(0, NA))


g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(min(df$año), params$año - 6), params$año),
                      rangeslider = list(type = "date", thickness = 0.04))) %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) {
        console.log(d);
        highlight(d);
      });
      
      el.on('plotly_unhover', function(d) {
        reset(d);
      });
      
      el.on('plotly_click', function(d) {
        highlight(d);
      });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 
```

```{r Indicador evolución de los turistas}
ind_turistas <- df %>% filter(municipio == municipio_actual$municipio & año %in% c(params$año, params$año-1))

Num_Turistas_num <- ind_turistas %>% filter(municipio == municipio_actual$municipio & año == params$año) %>% select(Valor) %>% as.numeric()
Num_Turistas <- Num_Turistas_num %>% format(big.mark = ".", decimal.mark = ",")
Imagen_Variacion <- ifelse(is.na(ind_turistas %>% filter(municipio == municipio_actual$municipio & año == params$año-1) %>% select(Valor) %>% as.numeric()),
                           "NA",
                           ifelse(signo(ind_turistas %>% filter(municipio == municipio_actual$municipio & año == params$año) %>% select(Tasa) %>% as.numeric()) == "más",
                                  './img/up.png', './img/down.png')
                           )
Variacion_Porcentual_Turistas <- ind_turistas %>% filter(municipio == municipio_actual$municipio & año == params$año) %>% select(Tasa) %>% as.numeric() %>%
                                 format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Indicador Estancia media}
# Estancia media según niveles de ingresos. Municipios turísticos de Canarias y periodos. 2018 a 2020.
turismo_estancia <- fromJSON(params$url.estancia)
df_turismo_estancia <- cbind(data.frame(do.call('rbind', turismo_estancia[["data"]][["dimCodes"]])), turismo_estancia[["data"]][["Valor"]])
colnames(df_turismo_estancia) <- c('nivel', 'mun', 'periodo', 'valor')
df_turismo_estancia$nivel <- factor(df_turismo_estancia$nivel, levels=turismo_estancia[["categories"]][["codes"]][[1]], labels=turismo_estancia[["categories"]][["labels"]][[1]])
df_turismo_estancia$mun <- factor(df_turismo_estancia$mun, levels=turismo_estancia[["categories"]][["codes"]][[2]], labels=turismo_estancia[["categories"]][["labels"]][[2]])
df_turismo_estancia$periodo <- as.numeric(df_turismo_estancia$periodo)
df_turismo_estancia$valor <- as.numeric(df_turismo_estancia$valor)
df_turismo_estancia$mun <- recode_mun(df_turismo_estancia, 'mun')

Num_estancia_media <- df_turismo_estancia %>%
  filter(nivel == "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% 
  select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Rankings}
df_ranking <- df_u %>%
  select(id = mun, año, Valor) %>%
  filter(año == params$año) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(Valor))

df_tur_mun <- df_ranking[which(df_ranking$id==params$id_municipio),]
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_tur_mun$Valor / num_Canarias_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_tur_isla <- df_ranking %>% filter(isla == df_tur_mun$isla)
rk_isla <- grep(params$id_municipio, df_tur_isla$id)
num_mun_isla <- nrow(df_tur_isla)
percent_isla <- format(round(df_tur_mun$Valor / num_Isla_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Grupos de edad}
# Turistas según grupos de edades y sexos por países de residencia. Municipios turísticos de Canarias y periodos. 2018 a 2020.
df_piramide <- cbind(data.frame(do.call('rbind', piramide[["data"]][["dimCodes"]])), piramide[["data"]][["Valor"]])
colnames(df_piramide) <- c('gredad', 'sexo', 'pais', 'mun', 'año', 'valor')
df_piramide$gredad <- ordered(df_piramide$gredad, levels=piramide[["categories"]][["codes"]][[1]], labels=piramide[["categories"]][["labels"]][[1]])
df_piramide$sexo <- factor(df_piramide$sexo, levels=piramide[["categories"]][["codes"]][[2]], labels=piramide[["categories"]][["labels"]][[2]])
df_piramide$pais <- factor(df_piramide$pais, levels=piramide[["categories"]][["codes"]][[3]], labels=piramide[["categories"]][["labels"]][[3]])
df_piramide$mun <- factor(df_piramide$mun, levels=piramide[["categories"]][["codes"]][[4]], labels=piramide[["categories"]][["labels"]][[4]])
df_piramide$año <- as.integer(df_piramide$año)
df_piramide$valor <- as.numeric(df_piramide$valor)
df_piramide$mun <- recode_mun(df_piramide, 'mun')

df_turismo_gedad <- df_piramide %>%
  filter(mun == municipio_actual$municipio & gredad != "TOTAL GRUPOS DE EDADES" & sexo == "AMBOS SEXOS" & pais == "TOTAL" & año == params$año) %>% 
  select(c(gredad, valor))
df_turismo_gedad <- df_turismo_gedad %>% mutate(porcentaje = df_turismo_gedad$valor/ Num_Turistas_num * 100)

Percent_Turistas_menos44 <- df_turismo_gedad$porcentaje[which(df_turismo_gedad$gredad == "De 16 a 44 años")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Percent_Turistas_mas44 <- (100 - df_turismo_gedad$porcentaje[which(df_turismo_gedad$gredad == "De 16 a 44 años")] %>% round(1)) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)

df_turismo_gedad_C <- df_piramide %>%
  filter(mun == "CANARIAS" & gredad != "TOTAL GRUPOS DE EDADES" & sexo == "AMBOS SEXOS" & pais == "TOTAL" & año == params$año) %>% 
  select(c(gredad, valor))
df_turismo_gedad_C <- df_turismo_gedad_C %>% mutate(porcentaje = df_turismo_gedad_C$valor/ num_Canarias_total * 100)

Percent_Turistas_menos44_C <- df_turismo_gedad_C$porcentaje[which(df_turismo_gedad_C$gredad == "De 16 a 44 años")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Percent_Turistas_mas44_C <- (100 - df_turismo_gedad_C$porcentaje[which(df_turismo_gedad_C$gredad == "De 16 a 44 años")] %>% round(1)) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Número de mujeres y hombres}
Percent_Mujeres <- round((
  df_piramide %>%
    filter(mun == municipio_actual$municipio & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "Mujeres" & pais == "TOTAL" & año == params$año) %>%
    subset(select = "valor") %>% as.numeric) / Num_Turistas_num *100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Percent_Hombres <- round((
  df_piramide %>%
    filter(mun == municipio_actual$municipio & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "Hombres" & pais == "TOTAL" & año == params$año) %>%
    subset(select = "valor") %>% as.numeric) / Num_Turistas_num *100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)

Num_Mujeres <- df_piramide %>%
  filter(mun == municipio_actual$municipio & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "Mujeres" & pais == "TOTAL" & año == params$año) %>% 
  subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",")
Num_Hombres <- df_piramide %>%
  filter(mun == municipio_actual$municipio & gredad == "TOTAL GRUPOS DE EDADES" & sexo == "Hombres" & pais == "TOTAL" & año == params$año) %>%
  subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Barras países por sexo}
# Turistas según grupos de edades y sexos por países de residencia. Municipios turísticos de Canarias y periodos. 2018 a 2020.
df_turismo_pais <- cbind(data.frame(do.call('rbind', piramide[["data"]][["dimCodes"]])), piramide[["data"]][["Valor"]])
colnames(df_turismo_pais) <- c('ge', 'sexo', 'pais', 'mun', 'periodo', 'valor')
df_turismo_pais$ge <- factor(df_turismo_pais$ge, levels=piramide[["categories"]][["codes"]][[1]], labels=piramide[["categories"]][["labels"]][[1]])
df_turismo_pais$sexo <- factor(df_turismo_pais$sexo, levels=piramide[["categories"]][["codes"]][[2]], labels=piramide[["categories"]][["labels"]][[2]])
df_turismo_pais$pais <- factor(df_turismo_pais$pais, levels=piramide[["categories"]][["codes"]][[3]], labels=piramide[["categories"]][["labels"]][[3]])
df_turismo_pais$mun <- factor(df_turismo_pais$mun, levels=piramide[["categories"]][["codes"]][[4]], labels=piramide[["categories"]][["labels"]][[4]])
df_turismo_pais$periodo <- as.numeric(df_turismo_pais$periodo)
df_turismo_pais$valor <- as.numeric(df_turismo_pais$valor)
df_turismo_pais$mun <- recode_mun(df_turismo_pais, 'mun')
df_turismo_pais <- df_turismo_pais %>% transform(pais = gsub("Otros países", "Otros", pais))

rk_turismo_pais_mun <- df_turismo_pais %>%
  filter(ge == "TOTAL GRUPOS DE EDADES"  & sexo == "AMBOS SEXOS" & pais != "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% arrange(valor) %>%
  select(c(pais, valor))
rk_turismo_pais_mun <- rk_turismo_pais_mun %>% mutate(porcentaje = rk_turismo_pais_mun$valor/ Num_Turistas_num * 100)
rk_turismo_pais_mun$pais <- ordered(rk_turismo_pais_mun$pais, levels = rk_turismo_pais_mun$pais)

df_turismo_pais_mun <- df_turismo_pais %>%
  filter(ge == "TOTAL GRUPOS DE EDADES"  & sexo != "AMBOS SEXOS" & pais != "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>%
  select(c(sexo, pais, valor))
df_turismo_pais_Canarias <- df_turismo_pais %>%
  filter(ge == "TOTAL GRUPOS DE EDADES"  & sexo != "AMBOS SEXOS" & pais != "TOTAL" & mun == "CANARIAS" & periodo == params$año) %>%
  select(c(sexo, pais, valor))

df_turismo_pais_mun <- df_turismo_pais_mun %>%
  mutate(porcentaje = df_turismo_pais_mun$valor / Num_Turistas_num * 100,
         valor_Canarias = df_turismo_pais_Canarias$valor, porcentaje_Canarias = df_turismo_pais_Canarias$valor / num_Canarias_total * 100)
df_turismo_pais_mun$pais <- ordered(df_turismo_pais_mun$pais, levels = rk_turismo_pais_mun$pais)

df_turismo_pais_mun <- df_turismo_pais_mun %>% transform(hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", trimws(pais), "</b><br>"), ""),
    "<b>", sexo, "</b>",
    "<br>",trimws(format(valor, big.mark = ".", decimal.mark = ",")), 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
    "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
    " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

g_turismo_pais <- ggplot(df_turismo_pais_mun, aes(y = pais, fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", width = 0.6, alpha = 0.8, position = position_stack(reverse = TRUE), aes(x = porcentaje)) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_turismo_pais <- ggplotly(g_turismo_pais, tooltip = c("text")) %>%
  layout(hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Tipos de alojamiento}
# Turistas según tipos de alojamiento por países de residencia. Municipios turísticos de Canarias y periodos. 2018 a 2020.
turismo_sl_aloj <- fromJSON(params$url.sl_aloj)
df_turismo_sl_aloj <- cbind(data.frame(do.call('rbind', turismo_sl_aloj[["data"]][["dimCodes"]])), turismo_sl_aloj[["data"]][["Valor"]])
colnames(df_turismo_sl_aloj) <- c('sl', 'tipo', 'mun', 'periodo', 'valor')
df_turismo_sl_aloj$sl <- factor(df_turismo_sl_aloj$sl, levels=turismo_sl_aloj[["categories"]][["codes"]][[1]], labels=turismo_sl_aloj[["categories"]][["labels"]][[1]])
df_turismo_sl_aloj$tipo <- factor(df_turismo_sl_aloj$tipo, levels=turismo_sl_aloj[["categories"]][["codes"]][[2]], labels=turismo_sl_aloj[["categories"]][["labels"]][[2]])
df_turismo_sl_aloj$mun <- factor(df_turismo_sl_aloj$mun, levels=turismo_sl_aloj[["categories"]][["codes"]][[3]], labels=turismo_sl_aloj[["categories"]][["labels"]][[3]])
df_turismo_sl_aloj$periodo <- as.numeric(df_turismo_sl_aloj$periodo)
df_turismo_sl_aloj$valor <- as.numeric(df_turismo_sl_aloj$valor)
df_turismo_sl_aloj$mun <- recode_mun(df_turismo_sl_aloj, 'mun')

df_turismo_aloj_mun <- df_turismo_sl_aloj %>%
  filter(tipo != "TOTAL" & sl == "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% 
  select(c(tipo, valor))
df_turismo_aloj_C <- df_turismo_sl_aloj %>%
  filter(mun == "CANARIAS" & tipo != "TOTAL" & sl == "TOTAL" & periodo == params$año) %>% 
  select(c(tipo, valor))
df_turismo_aloj_mun <- df_turismo_aloj_mun %>%
  mutate(porcentaje = df_turismo_aloj_mun$valor / Num_Turistas_num * 100,
         valor_Canarias = df_turismo_aloj_C$valor,
         porcentaje_Canarias = df_turismo_aloj_C$valor / num_Canarias_total * 100)

df_turismo_aloj_plot <- df_turismo_aloj_mun %>%
  mutate(label = "|")
df_turismo_aloj_plot$tipo <- ordered(df_turismo_aloj_plot$tipo, levels = df_turismo_aloj_plot$tipo[5:1])
df_turismo_aloj_plot <- df_turismo_aloj_plot %>% mutate(tipo = recode(tipo, "Vivienda privada propia o de terceros" = "Vivienda<br>privada"),
                                                        tipo = recode(tipo, "Otros alojamientos colectivos" = "Otros"))

df_turismo_aloj_plot <- df_turismo_aloj_plot %>% transform(hovertext = paste0(
  "<b>", trimws(tipo), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

df_turismo_aloj_0 <- df_turismo_aloj_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_turismo_aloj_plot <- rbind(df_turismo_aloj_plot, df_turismo_aloj_0)

g_turismo_aloj <- ggplot(df_turismo_aloj_plot, aes(y = tipo, fill = tipo, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#2CBCE2", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_turismo_aloj <- ggplotly(g_turismo_aloj, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(5:8))
```

```{r Niveles de ingresos}
# Turistas según niveles de ingresos por países de residencia. Municipios turísticos de Canarias y periodos. 2018 a 2020.
turismo_ingresos <- fromJSON(params$url.ingresos)
df_turismo_ingresos <- cbind(data.frame(do.call('rbind', turismo_ingresos[["data"]][["dimCodes"]])), turismo_ingresos[["data"]][["Valor"]])
colnames(df_turismo_ingresos) <- c('nivel', 'pais', 'mun', 'periodo', 'valor')
df_turismo_ingresos$nivel <- factor(df_turismo_ingresos$nivel, levels=turismo_ingresos[["categories"]][["codes"]][[1]], labels=turismo_ingresos[["categories"]][["labels"]][[1]])
df_turismo_ingresos$pais <- factor(df_turismo_ingresos$pais, levels=turismo_ingresos[["categories"]][["codes"]][[2]], labels=turismo_ingresos[["categories"]][["labels"]][[2]])
df_turismo_ingresos$mun <- factor(df_turismo_ingresos$mun, levels=turismo_ingresos[["categories"]][["codes"]][[3]], labels=turismo_ingresos[["categories"]][["labels"]][[3]])
df_turismo_ingresos$periodo <- as.numeric(df_turismo_ingresos$periodo)
df_turismo_ingresos$valor <- as.numeric(df_turismo_ingresos$valor)
df_turismo_ingresos$mun <- recode_mun(df_turismo_ingresos, 'mun')

df_turismo_ingresos_C <- df_turismo_ingresos %>%
  filter(nivel != "TOTAL" & pais == "TOTAL" & mun == "CANARIAS" & periodo == params$año) %>% 
  select(c(nivel, valor))
df_turismo_ingresos_C <- df_turismo_ingresos_C %>% mutate(porcentaje = df_turismo_ingresos_C$valor/ num_Canarias_total * 100)

porc_Turistas_menos50_C <- df_turismo_ingresos_C$porcentaje[which(df_turismo_ingresos_C$nivel == "Menos de 50.000€")]
porc_Turistas_mas50_C <- 100 - df_turismo_ingresos_C$porcentaje[which(df_turismo_ingresos_C$nivel == "Menos de 50.000€")]
porc_Turistas_menos50_C_l <- round(porc_Turistas_menos50_C, 1) %>% as.numeric
porc_Turistas_mas50_C_l <- round(porc_Turistas_mas50_C, 1) %>% as.numeric

df_turismo_ingresos <- df_turismo_ingresos %>%
  filter(nivel != "TOTAL" & pais == "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% 
  select(c(nivel, valor))
df_turismo_ingresos <- df_turismo_ingresos %>% mutate(porcentaje = df_turismo_ingresos$valor/ Num_Turistas_num * 100)

porc_Turistas_menos50 <- df_turismo_ingresos$porcentaje[which(df_turismo_ingresos$nivel == "Menos de 50.000€")]
porc_Turistas_mas50 <- 100 - df_turismo_ingresos$porcentaje[which(df_turismo_ingresos$nivel == "Menos de 50.000€")]
porc_Turistas_menos50_l <- round(porc_Turistas_menos50, 1) %>% as.numeric
porc_Turistas_mas50_l <- round(porc_Turistas_mas50, 1) %>% as.numeric
```

```{r Propósito principal}
# Turistas según el propósito principal del viaje por tipos de alojamiento. Municipios turísticos de Canarias y periodos. 2018 a 2020.
turismo_proposito <- fromJSON(params$url.proposito)
df_turismo_proposito <- cbind(data.frame(do.call('rbind', turismo_proposito[["data"]][["dimCodes"]])), turismo_proposito[["data"]][["Valor"]])
colnames(df_turismo_proposito) <- c('proposito', 'tipo', 'mun', 'periodo', 'valor')
df_turismo_proposito$proposito <- factor(df_turismo_proposito$proposito, levels=turismo_proposito[["categories"]][["codes"]][[1]],
                                         labels=turismo_proposito[["categories"]][["labels"]][[1]])
df_turismo_proposito$tipo <- factor(df_turismo_proposito$tipo, levels=turismo_proposito[["categories"]][["codes"]][[2]], labels=turismo_proposito[["categories"]][["labels"]][[2]])
df_turismo_proposito$mun <- factor(df_turismo_proposito$mun, levels=turismo_proposito[["categories"]][["codes"]][[3]], labels=turismo_proposito[["categories"]][["labels"]][[3]])
df_turismo_proposito$periodo <- as.numeric(df_turismo_proposito$periodo)
df_turismo_proposito$valor <- as.numeric(df_turismo_proposito$valor)
df_turismo_proposito$mun <- recode_mun(df_turismo_proposito, 'mun')

df_turismo_proposito <- df_turismo_proposito %>%
  filter(proposito != "TOTAL" & tipo == "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% 
  select(c(proposito, valor))
df_turismo_proposito <- df_turismo_proposito %>% mutate(porcentaje = df_turismo_proposito$valor/ Num_Turistas_num * 100)

Percent_Vacaciones <- df_turismo_proposito$porcentaje[which(df_turismo_proposito$proposito == "Vacaciones")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Visitas previas}
# Turistas según el número de visitas previas a Canarias por tipos de alojamiento. Municipios turísticos de Canarias y periodos. 2018 a 2020.
turismo_visitas <- fromJSON(params$url.visitas)
df_turismo_visitas <- cbind(data.frame(do.call('rbind', turismo_visitas[["data"]][["dimCodes"]])), turismo_visitas[["data"]][["Valor"]])
colnames(df_turismo_visitas) <- c('N_visitas', 'tipo', 'mun', 'periodo', 'valor')
df_turismo_visitas$N_visitas <- factor(df_turismo_visitas$N_visitas, levels=turismo_visitas[["categories"]][["codes"]][[1]], labels=turismo_visitas[["categories"]][["labels"]][[1]])
df_turismo_visitas$tipo <- factor(df_turismo_visitas$tipo, levels=turismo_visitas[["categories"]][["codes"]][[2]], labels=turismo_visitas[["categories"]][["labels"]][[2]])
df_turismo_visitas$mun <- factor(df_turismo_visitas$mun, levels=turismo_visitas[["categories"]][["codes"]][[3]], labels=turismo_visitas[["categories"]][["labels"]][[3]])
df_turismo_visitas$periodo <- as.numeric(df_turismo_visitas$periodo)
df_turismo_visitas$valor <- as.numeric(df_turismo_visitas$valor)
df_turismo_visitas$mun <- recode_mun(df_turismo_visitas, 'mun')

df_turismo_visitas_mun <- df_turismo_visitas %>%
  filter(N_visitas != "TOTAL" & tipo == "TOTAL" & mun == municipio_actual$municipio & periodo == params$año) %>% 
  select(c(N_visitas, valor))
df_turismo_visitas_C <- df_turismo_visitas %>%
  filter(N_visitas != "TOTAL" & tipo == "TOTAL" & mun == "CANARIAS" & periodo == params$año) %>% 
  select(c(N_visitas, valor))
df_turismo_visitas_mun <- df_turismo_visitas_mun %>%
  mutate(porcentaje = df_turismo_visitas_mun$valor / Num_Turistas_num * 100,
         valor_Canarias = df_turismo_visitas_C$valor,
         porcentaje_Canarias = df_turismo_visitas_C$valor / num_Canarias_total * 100)

df_turismo_visitas_plot <- df_turismo_visitas_mun %>%
  mutate(label = "|")
df_turismo_visitas_plot <- df_turismo_visitas_plot %>% 
  mutate(N_visitas = recode(N_visitas, "Ninguna" = "0"),
         N_visitas = recode(N_visitas, "Una o dos visitas" = "1 - 2"),
         N_visitas = recode(N_visitas, "Tres o más visitas" = "> 2"))

df_turismo_visitas_plot <- df_turismo_visitas_plot %>% transform(hovertext = paste0(
  "<b>", trimws(N_visitas), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

df_turismo_visitas_0 <- df_turismo_visitas_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_turismo_visitas_plot <- rbind(df_turismo_visitas_plot, df_turismo_visitas_0)

g_turismo_visitas <- ggplot(df_turismo_visitas_plot, aes(y = N_visitas, fill = N_visitas, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_turismo_visitas <- ggplotly(g_turismo_visitas, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(4:6))
```

```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator2b = function(label, value, image) {
  return(sprintf("<div class='indicator2b'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator4s = function(title, label, value) {
  return(sprintf("<div class='indicator4s'><div class='title'>%s</div><hr class='separator'><p class='value'>%s</p><p class='label'>%s</p><p class='label2'>Canarias</p></div>", title, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r params$año`</h3>
<h2 style="color: #666; margin: 0;">Perfil del turista</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Turistas` turistas</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$municipio[i], leyenda_poblacion$Valor_l[i], leyenda_poblacion$Tasa_l[i]))
}
```
</div>
</div>

<div class="row">
```{r, results='asis'}
if(Variacion_Porcentual_Turistas == "NA"){
  cat(paste0(
    "<div class='column-3'>", get_indicator2('Estancia</br>media', Num_estancia_media, './img/cama.png'), "</div><div class='column-3'>", get_indicator2(paste0('Mujeres</p><p class="label" style="color: #999;">', Num_Mujeres), paste0(Percent_Mujeres, '%'), './img/female.png'), "</div><div class='column-3'>", get_indicator2(paste0('Hombres</p><p class="label" style="color: #999;">', Num_Hombres), paste0(Percent_Hombres, '%'), './img/male.png'), "</div>"))
}else{
  cat(paste0(
    "<div class='column-4'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual_Turistas, '%'), Imagen_Variacion), "</div><div class='column-4'>", get_indicator2('Estancia</br>media', Num_estancia_media, './img/cama.png'), "</div><div class='column-4'>", get_indicator2(paste0('Mujeres</p><p class="label" style="color: #999;">', Num_Mujeres), paste0(Percent_Mujeres, '%'), './img/female.png'), "</div><div class='column-4'>", get_indicator2(paste0('Hombres</p><p class="label" style="color: #999;">', Num_Hombres), paste0(Percent_Hombres, '%'), './img/male.png'), "</div>"))
}
```
</div>

<div class="row" style="margin-top: 10px;">
<div class="column-3">
  <div class="indicator-map map-canarias">
  <div class="image" style="height: 160px;">
```{r} 
mapa_Canarias_plot
```
</div>
  <div class="indicator-content" style="padding: 8px;">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image" style="height: 160px;">
```{r} 
mapa_isla_plot
```
</div>
  <div class="indicator-content" style="padding: 8px;">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="column" style="width: 100% !important;">
<div class="row highlight" style="width: 100% !important; margin-top: -5px; padding: 3px; padding-bottom: 0;">
  <h3>Grupos de edad</h3>
  <hr class='separator'>
  <div class="column-2">`r get_indicator4s("16 - 44", paste0(Percent_Turistas_menos44_C, "%"), paste0(Percent_Turistas_menos44, "%"))`</div>
  <div class="column-2">`r get_indicator4s("&gt; 44", paste0(Percent_Turistas_mas44_C, "%"), paste0(Percent_Turistas_mas44, "%"))`</div>
</div>
<div class="row highlight" style="width: 100% !important; padding-left: 0; margin-top: 12px;">
  <div style= "margin-left: 50px;">`r get_indicator2b("Vacaciones", paste0(Percent_Vacaciones, "%"),"./img/vacaciones.png")`</div>
</div>
</div>
</div>

</div>

<div class="row">
<div class="column indicator-title">
  <h3>Nacionalidades y sexos</h3>
</div>
<div class="column indicator-title">
  <h3>Tipos de alojamientos</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
<div class="piramide" style="height: 190px">
  `r g_turismo_pais`
</div>
<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3'></div><div class='sp-content'>Mujeres</div></div>
</div>
</div>

<div class="column highlight">
<div class="piramide" style="height: 190px">
  `r g_turismo_aloj`
</div>
<div class="progressbar-legend-container">
<div class='progressbar-legend'>
<div class='progress-bar-8' style="padding-left: 6px; margin-top: -6px; color: #59656E; font-weight: 600;">|</div><div class='sp-content'>Canarias</div></div>
</div>
</div>

</div>


<div class="row">
<div class="column indicator-title">
  <h3>Visitas previas</h3>
</div>
<div class="column indicator-title">
  <h3>Niveles de ingresos</h3>
</div>
</div>

<div class="row">
<div class="column highlight" style="padding: 10px;">
<div class="piramide" style="height: 152px">
  `r g_turismo_visitas`
</div>
<div class="progressbar-legend-container">
<div class='progressbar-legend'>
<div class='progress-bar-8' style="padding-left: 6px; margin-top: -6px; color: #59656E; font-weight: 600;">|</div><div class='sp-content'>Canarias</div></div>
</div>
</div>

<div class="column highlight" style="padding: 5px;">
<div class="progress-bar-container">
  <div class="progress-bar-1" style="width:`r porc_Turistas_menos50`%"></div>
  <div class="progress-bar-3" style="width:`r porc_Turistas_mas50`%"></div>
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1'></div><div class='sp-content'>&lt; 50.000€<br>`r format(porc_Turistas_menos50_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3'></div><div class='sp-content'>&ge; 50.000€<br>`r format(porc_Turistas_mas50_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
</div>

<div class="row">
<p style="margin: 4px 16px -10px;">Canarias</p>

<div class="progress-bar-container" style="height: 20px;">
  <div class="progress-bar-1-C" style="width:`r porc_Turistas_menos50_C`%"></div>
  <div class="progress-bar-3-C" style="width:`r porc_Turistas_mas50_C`%"></div>
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1-C'></div><div class='sp-content'>&lt; 50.000€<br>`r format(porc_Turistas_menos50_C_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3-C'></div><div class='sp-content'>&ge; 50.000€<br>`r format(porc_Turistas_mas50_C_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
</div>
</div>

</div>

</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

