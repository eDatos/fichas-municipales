---
title: ''
params:
  id_municipio: 35024
  año: 2021
  mes: 6
  url.mes_t: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/5ac41241-1008-4495-bc24-04d478deac2a
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.viajeros_lugar: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=d7482433-d3db-4228-bbf0-0196a02d0f48
  url.estancia_m: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/ALOJATUR_ESTANCIAS_MEDIAS/data?representation=MEASURE[ABSOLUTE]&granularity=TIME[MONTHLY]
  url.tasa_ocupacion: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/ac286c1a-f70a-4888-9679-bd973250c824/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.ADR: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=d17b4953-73fe-4dcb-91e2-b63890eecd9f
  url.aloj_isla: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=b4de650c-10d8-4202-b678-58f597b1b040
  url.hotel: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=2457b2ce-c6c1-46d5-9c85-59cd4b9b076d
  url.extrahoteleros: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=76147e33-158b-4df0-ac5d-447de68ad3ef
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
    self_contained: false
    lib_dir: libs
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)

signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")
```

```{r Mes}
data_mes <- fromJSON(params$url.mes_t)

mes <- data.frame(code = data_mes[["dimension"]][["TIME"]][["representation"]][["code"]],
                  periodo = data_mes[["dimension"]][["TIME"]][["representation"]][["title"]][["es"]])

mes <- mes %>% 
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1)))) %>% 
  mutate(order = as.integer(order(mes$code, decreasing = FALSE)))
mes_actual <- mes %>% filter(substring(code, 0,4) == params$año & as.numeric(substring(code, 6,8)) == params$mes)
mes_tva <- mes[mes$order == mes[mes_actual$code == mes$code, ]$order - 12, ]
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
mapa_Canarias <- st_read(params$url.mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% st_sf

palette <- c('#8CD2EA', '#005980')
mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla)

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)


mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución de la población turística}
# Pernoctaciones, viajeros entrados y viajeros alojados según lugares de residencia por municipios de alojamiento de Canarias y periodos. 2009M01 a 2021M__.
viajeros_lugar <- fromJSON(params$url.viajeros_lugar)
df_u_ <- cbind(data.frame(do.call('rbind', viajeros_lugar[["data"]][["dimCodes"]])), viajeros_lugar[["data"]][["Valor"]])
colnames(df_u_) <- c('ind', 'lugar', 'mun', 'periodo', 'valor')
df_u_$ind <- factor(df_u_$ind, levels=viajeros_lugar[["categories"]][["codes"]][[1]], labels=viajeros_lugar[["categories"]][["labels"]][[1]])
df_u_$lugar <- factor(df_u_$lugar, levels=viajeros_lugar[["categories"]][["codes"]][[2]], labels=viajeros_lugar[["categories"]][["labels"]][[2]])
df_u_$valor <- as.numeric(df_u_$valor)
df_u_ <- df_u_ %>% mutate(lugar = recode(lugar, " TOTAL RESIDENTES EN ESPAÑA" = "España"))

df_u_ <- df_u_ %>% filter(substring(periodo, 5,5) == "M")
df_u_$periodo <- paste0(substring(df_u_$periodo, 0,4), "-", substring(df_u_$periodo, 6,7))
df_u <- df_u_ %>% filter(lugar == "TOTAL LUGARES DE RESIDENCIA" & ind == "Viajeros alojados") %>% select(mun, periodo, valor)

num_Canarias_total <- df_u %>% filter(mun == "ES70" & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()
num_Isla_total <- df_u %>% filter(mun == municipio_actual$id_isla & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()

df_u <- df_u[with(df_u, order(periodo)), ]
df_u <- df_u %>%
  filter(substring(mun, 0,1) == "3") %>% 
  arrange(periodo) %>% 
  select(mun, periodo, valor)

related_mun <- df_u %>% filter(periodo == mes_actual$code)
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Personas alojadas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Personas alojadas: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)

df <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, periodo, nombre, valor) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(id, code = periodo, nombre, valor) %>%
  left_join(mes, by = "code") %>%
  transform(tasa = ifelse(substring(code, 0,4) != min(substring(code, 0,4)), round(100*((valor / lag(valor, n = 12)) - 1), 1), NA)) %>% 
  filter(order < mes_actual$order+1)

if(substring(mes_actual$code, 0,4) != 2010){
  df <- df %>% filter(substring(code, 0,4) != 2009)
}

año_min <- min(as.integer(substring(df$code, 0,4)))
año_max <- max(as.integer(substring(df$code, 0,4)))

leyenda_poblacion <- df %>% filter(code == mes_actual$code) %>%
  mutate(valor = ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))) %>%
  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "nombre")

df <- df %>% mutate(
    tooltip = ifelse(code == mes_actual$code,
                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")), ' (',periodo_formatted,')'),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
    )
)

g_line <- ggplot(data = df, aes(x = reorder(code, order), y = valor, group = nombre, colour = nombre, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_discrete(breaks = function(x){paste0(año_min:año_max, "-01") }, labels = function(x){substr(x, 0,4)}) +
  scale_y_continuous(labels = function(x){paste0(format(x/10^3, big.mark = ".", decimal.mark = ","), " mil")}, n.breaks = 5, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(0.8, nrow(df[df$id == params$id_municipio, ]) - 5*12),
                                nrow(df[df$id == params$id_municipio, ])
                                ),
                      rangeslider = list(type = "date", thickness = 0.04))) %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');
      var init_contents = [];
      for (var i = 0; i < municipios.length; i++) {
        init_contents[i] = contents[i].innerHTML;
      }
      
      el.on('plotly_hover', function(d) {
        highlight(d);
      });
      
      el.on('plotly_unhover', function(d) {
        reset(d);
      });
      
      el.on('plotly_click', function(d) {
        highlight(d);
      });
      
      function highlight(d) {
        for (var i = 0; i < municipios.length; i++) {
          contents[i].innerHTML = '<span class=\"sp-municipio\">' + municipios[i].textContent + '</span>';
        }
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (var i = 0; i < municipios.length; i++) {
          contents[i].innerHTML = init_contents[i];
        }
      }
    }
  ") 
```

```{r Indicador evolución de los viajeros}
## Viajeros entrados en alojamientos turísticos. 2009
ind_viaj <- df %>% filter(id == params$id_municipio & code %in% c(mes_actual$code, mes_tva$code))

Num_Viajeros_num <- ind_viaj %>% filter(id == params$id_municipio & code == mes_actual$code) %>% select(valor) %>% as.numeric()
Num_Viajeros <- Num_Viajeros_num %>% format(big.mark = ".", decimal.mark = ",")
Variacion_Porcentual <- ind_viaj %>% filter(id == params$id_municipio & code == mes_actual$code) %>% select(tasa) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Imagen_Variacion <- ifelse(signo(Variacion_Porcentual) == "más", './img/up.png', './img/down.png')
```

```{r Indicador Estancia Media}
# Estancia media de los viajeros en hoteles y apartamentos turísticos. 2021-M_.
estancia_media <- fromJSON(params$url.estancia_m)

df_estancia_media <- data.frame(
  mun = rep(names(estancia_media[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                     each=length(estancia_media[["dimension"]][["TIME"]][["representation"]][["index"]])),
  mes = rep(names(estancia_media[["dimension"]][["TIME"]][["representation"]][["index"]]),
            times=length(estancia_media[["dimension"]][["MEASURE"]][["representation"]][["index"]])),
  valor = estancia_media[["observation"]])
df_estancia_media$valor <- as.numeric(df_estancia_media$valor)

Num_estancia_media <- df_estancia_media %>% filter(mes == mes_actual$code & mun == params$id_municipio) %>% select(valor) %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
```

```{r Indicador Tasa de Ocupación}
# Tasa de ocupación por plazas en hoteles y apartamentos turísticos. 2009-M01 a 2021-M_.
tasa_ocupacion <- fromJSON(params$url.tasa_ocupacion)

df_tasa_ocupacion <- data.frame(
  mun = rep(names(tasa_ocupacion[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
            
                     each=length(tasa_ocupacion[["dimension"]][["TIME"]][["representation"]][["index"]])),
  mes = rep(names(tasa_ocupacion[["dimension"]][["TIME"]][["representation"]][["index"]]),
            times=length(tasa_ocupacion[["dimension"]][["MEASURE"]][["representation"]][["index"]])),
  valor = tasa_ocupacion[["observation"]])
df_tasa_ocupacion$valor <- as.numeric(df_tasa_ocupacion$valor)

Tasa_ocupacion <- df_tasa_ocupacion %>% filter(mes == mes_actual$code & mun == params$id_municipio) %>% select(valor) %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
```

```{r Indicador ADR}
# Tarifa media diaria (ADR), ingresos por habitación disponible (RevPAR) e ingresos totales por municipios de alojamiento de Canarias y periodos. 2009M01 a 2021M04.
ADR <- fromJSON(params$url.ADR)
df_ADR <- cbind(data.frame(do.call('rbind', ADR[["data"]][["dimCodes"]])), ADR[["data"]][["Valor"]])
colnames(df_ADR) <- c('ind', 'mun', 'periodo', 'valor')
df_ADR$ind <- factor(df_ADR$ind, levels=ADR[["categories"]][["codes"]][[1]], labels=ADR[["categories"]][["labels"]][[1]])
df_ADR$mun <- factor(df_ADR$mun, levels=ADR[["categories"]][["codes"]][[2]], labels=ADR[["categories"]][["labels"]][[2]])
df_ADR$periodo <- factor(df_ADR$periodo, levels=ADR[["categories"]][["codes"]][[3]], labels=ADR[["categories"]][["labels"]][[3]])
df_ADR$valor <- as.numeric(df_ADR$valor)
df_ADR$mun <- recode_mun(df_ADR, 'mun')

df_ADR_mun <- df_ADR %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$periodo) %>% 
  select(ind, valor)

ADR <- df_ADR_mun$valor[which(df_ADR_mun$ind == "Tarifa media por habitación mensual (ADR)")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Rankings}
df_ranking <- df_u %>%
  select(id = mun, periodo, valor) %>%
  filter(periodo == mes_actual$code) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

df_tur_mun <- df_ranking[which(df_ranking$id==params$id_municipio),]
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_tur_mun$valor / num_Canarias_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_tur_isla <- df_ranking %>% filter(isla == df_tur_mun$isla)
rk_isla <- grep(params$id_municipio, df_tur_isla$id)
num_mun_isla <- nrow(df_tur_isla)
percent_isla <- format(round(df_tur_mun$valor / num_Isla_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Barras Lugar}
df_viajeros_lugar <- df_u_ %>% 
  filter(periodo == mes_actual$code & ind == "Viajeros alojados" & 
         lugar %notin% c("TOTAL LUGARES DE RESIDENCIA", " TOTAL RESIDENTES EN EL EXTRANJERO", "  Canarias", "  Residentes en España excepto Canarias")) %>%
  select(mun, lugar, valor)

df_viajeros_lugar_mun <- df_viajeros_lugar %>% filter(mun == params$id_municipio)

rk_viajeros_lugar_mun <- df_viajeros_lugar_mun %>%
  arrange(valor) %>%
  select(lugar, valor)
rk_viajeros_lugar_mun <- rk_viajeros_lugar_mun %>% mutate(porcentaje = rk_viajeros_lugar_mun$valor/ Num_Viajeros_num * 100)
rk_viajeros_lugar_mun$lugar <- ordered(rk_viajeros_lugar_mun$lugar, levels = rk_viajeros_lugar_mun$lugar)

df_viajeros_lugar_C <- df_viajeros_lugar %>%
  filter(mun == "ES70") %>%
  select(lugar, valor)
df_viajeros_lugar_mun <- df_viajeros_lugar_mun %>%
  mutate(porcentaje = df_viajeros_lugar_mun$valor / Num_Viajeros_num * 100,
         valor_Canarias = df_viajeros_lugar_C$valor,
         porcentaje_Canarias = df_viajeros_lugar_C$valor / num_Canarias_total * 100)

df_viajeros_lugar_plot <- df_viajeros_lugar_mun %>%
  mutate(label = "|")
df_viajeros_lugar_plot$lugar <- ordered(df_viajeros_lugar_plot$lugar, levels = rk_viajeros_lugar_mun$lugar)

df_viajeros_lugar_plot <- df_viajeros_lugar_plot %>% transform(hovertext = paste0(
  "<b>", trimws(lugar), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_viajeros_lugar_0 <- df_viajeros_lugar_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_viajeros_lugar_plot <- rbind(df_viajeros_lugar_plot, df_viajeros_lugar_0)

g_viajeros_lugar <- ggplot(df_viajeros_lugar_plot, aes(y = lugar, fill = lugar, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  scale_fill_manual(values = c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_viajeros_lugar <- ggplotly(g_viajeros_lugar, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(9:17))
```

```{r Indicadores Lugar/Islas}
df_mun <- df_u_ %>%
  filter(mun == params$id_municipio & periodo == mes_actual$code & ind == "Viajeros alojados") %>%
  select(lugar, valor)
df_viajeros_nacionalidad_mun <- df_mun %>%
  filter(lugar %in% c("España", " TOTAL RESIDENTES EN EL EXTRANJERO"))
df_viajeros_nacionalidad_mun <- df_viajeros_nacionalidad_mun %>%
  mutate(porcentaje = df_viajeros_nacionalidad_mun$valor / Num_Viajeros_num * 100)

peso_española <- df_viajeros_nacionalidad_mun$porcentaje[which(df_viajeros_nacionalidad_mun$lugar == "España")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
peso_extranjera <- df_viajeros_nacionalidad_mun$porcentaje[which(df_viajeros_nacionalidad_mun$lugar == " TOTAL RESIDENTES EN EL EXTRANJERO")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()

df_viajeros_canarios_mun <- df_mun %>%
  filter(lugar %in% c("  Canarias", "España", "TOTAL LUGARES DE RESIDENCIA"))
df_viajeros_canarios_mun <- df_viajeros_canarios_mun %>%
  mutate(porcentaje = df_viajeros_canarios_mun$valor[which(df_viajeros_canarios_mun$lugar == "  Canarias")] / df_viajeros_canarios_mun$valor * 100)

peso_Canarias_Esp <- df_viajeros_canarios_mun$porcentaje[which(df_viajeros_canarios_mun$lugar == "España")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
peso_Canarias_Tot <- df_viajeros_canarios_mun$porcentaje[which(df_viajeros_canarios_mun$lugar == "TOTAL LUGARES DE RESIDENCIA")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
```

```{r Barras Islas}
# Pernoctaciones, viajeros entrados y viajeros alojados según islas de residencia de Canarias por municipios de alojamiento de Canarias y periodos
aloj_isla <- fromJSON(params$url.aloj_isla)
df_aloj_isla <- cbind(data.frame(do.call('rbind', aloj_isla[["data"]][["dimCodes"]])), aloj_isla[["data"]][["Valor"]])
colnames(df_aloj_isla) <- c('ind', 'lugar', 'mun', 'periodo', 'valor')
df_aloj_isla$ind <- factor(df_aloj_isla$ind, levels=aloj_isla[["categories"]][["codes"]][[1]], labels=aloj_isla[["categories"]][["labels"]][[1]])
df_aloj_isla$lugar <- factor(df_aloj_isla$lugar, levels=aloj_isla[["categories"]][["codes"]][[2]], labels=aloj_isla[["categories"]][["labels"]][[2]])
df_aloj_isla$mun <- factor(df_aloj_isla$mun, levels=aloj_isla[["categories"]][["codes"]][[3]], labels=aloj_isla[["categories"]][["labels"]][[3]])
df_aloj_isla$periodo <- paste0(substring(df_aloj_isla$periodo, 0,4), "-", substring(df_aloj_isla$periodo, 6,7))
df_aloj_isla$valor <- as.numeric(df_aloj_isla$valor)
df_aloj_isla$mun <- recode_mun(df_aloj_isla, 'mun')
df_aloj_isla <- df_aloj_isla %>% transform(lugar = gsub("Residencia en ", "", lugar))

num_viajeros_islas_mun <- df_u_ %>%
  filter(mun == params$id_municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar == "  Canarias") %>% select(valor) %>% as.numeric()
num_viajeros_islas_C <- df_u_ %>%
  filter(mun == "ES70" & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar == "  Canarias") %>% select(valor) %>% as.numeric()

rk_aloj_isla_mun <- df_aloj_isla %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>%
  arrange(valor) %>%
  select(lugar, valor)
rk_aloj_isla_mun <- rk_aloj_isla_mun %>% mutate(porcentaje = rk_aloj_isla_mun$valor/ num_viajeros_islas_mun * 100)
rk_aloj_isla_mun$lugar <- ordered(rk_aloj_isla_mun$lugar, levels = rk_aloj_isla_mun$lugar)

df_aloj_isla_mun <- df_aloj_isla %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>% select(lugar, valor)
df_aloj_isla_C <- df_aloj_isla %>%
filter(mun == "CANARIAS" & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>% select(lugar, valor)
df_aloj_isla_mun <- df_aloj_isla_mun %>%
  mutate(porcentaje = df_aloj_isla_mun$valor / num_viajeros_islas_mun * 100,
         valor_Canarias = df_aloj_isla_C$valor,
         porcentaje_Canarias = df_aloj_isla_C$valor / num_viajeros_islas_C * 100)

df_aloj_isla_plot <- df_aloj_isla_mun %>%
  mutate(label = "|")
df_aloj_isla_plot$lugar <- ordered(df_aloj_isla_plot$lugar, levels = rk_aloj_isla_mun$lugar)

df_aloj_isla_plot <- df_aloj_isla_plot %>% transform(hovertext = paste0(
  "<b>", trimws(lugar), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_aloj_isla_0 <- df_aloj_isla_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_aloj_isla_plot <- rbind(df_aloj_isla_plot, df_aloj_isla_0)

g_aloj_isla <- ggplot(data = df_aloj_isla_plot, aes(y = lugar, fill = lugar, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_aloj_isla <- ggplotly(g_aloj_isla, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(8:14))
```

```{r Tipos de alojamiento}
# Establecimientos hoteleros abiertos, plazas ofertadas y habitaciones disponibles según categorías por municipios de alojamiento de Canarias y periodos. 2009M01 a 2021M04.
hoteles <- fromJSON(params$url.hotel)
df_hoteles <- cbind(data.frame(do.call('rbind', hoteles[["data"]][["dimCodes"]])), hoteles[["data"]][["Valor"]])
colnames(df_hoteles) <- c('ind', 'cat', 'mun', 'periodo', 'valor')
df_hoteles$ind <- factor(df_hoteles$ind, levels=hoteles[["categories"]][["codes"]][[1]], labels=hoteles[["categories"]][["labels"]][[1]])
df_hoteles$cat <- factor(df_hoteles$cat, levels=hoteles[["categories"]][["codes"]][[2]], labels=hoteles[["categories"]][["labels"]][[2]])
df_hoteles$mun <- factor(df_hoteles$mun, levels=hoteles[["categories"]][["codes"]][[3]], labels=hoteles[["categories"]][["labels"]][[3]])
df_hoteles$periodo <- factor(df_hoteles$periodo, levels=hoteles[["categories"]][["codes"]][[4]], labels=hoteles[["categories"]][["labels"]][[4]])
df_hoteles$valor <- as.numeric(df_hoteles$valor)
df_hoteles$mun <- recode_mun(df_hoteles, 'mun')
df_hoteles <- df_hoteles %>% mutate(ind = recode(ind, "Establecimientos hoteleros abiertos" = "Establecimientos"),
                                    ind = recode(ind, "Plazas ofertadas" = "Plazas"),
                                    ind = recode(ind, "Habitaciones disponibles" = "Habitaciones/Apartamentos"))

df_hoteles_mun <- df_hoteles %>%
  filter(cat == "TOTAL CATEGORÍAS" & mun == municipio_actual$municipio & periodo == mes_actual$periodo) %>% 
  select(ind, valor_hoteles = valor)

# Establecimientos extrahoteleros abiertos, plazas ofertadas y habitaciones disponibles según categorías por municipios de alojamiento de Canarias y periodos. 2009M01 a 2021M04.
extrahoteleros <- fromJSON(params$url.extrahoteleros)
df_extrahoteleros <- cbind(data.frame(do.call('rbind', extrahoteleros[["data"]][["dimCodes"]])), extrahoteleros[["data"]][["Valor"]])
colnames(df_extrahoteleros) <- c('ind', 'cat', 'mun', 'periodo', 'valor')
df_extrahoteleros$ind <- factor(df_extrahoteleros$ind, levels=extrahoteleros[["categories"]][["codes"]][[1]], labels=extrahoteleros[["categories"]][["labels"]][[1]])
df_extrahoteleros$cat <- factor(df_extrahoteleros$cat, levels=extrahoteleros[["categories"]][["codes"]][[2]], labels=extrahoteleros[["categories"]][["labels"]][[2]])
df_extrahoteleros$mun <- factor(df_extrahoteleros$mun, levels=extrahoteleros[["categories"]][["codes"]][[3]], labels=extrahoteleros[["categories"]][["labels"]][[3]])
df_extrahoteleros$periodo <- factor(df_extrahoteleros$periodo, levels=extrahoteleros[["categories"]][["codes"]][[4]], labels=extrahoteleros[["categories"]][["labels"]][[4]])
df_extrahoteleros$valor <- as.numeric(df_extrahoteleros$valor)
df_extrahoteleros$mun <- recode_mun(df_extrahoteleros, 'mun')
df_extrahoteleros <- df_extrahoteleros %>% mutate(ind = recode(ind, "Establecimientos abiertos" = "Establecimientos"),
                                                  ind = recode(ind, "Plazas ofertadas" = "Plazas"),
                                                  ind = recode(ind, "Apartamentos disponibles" = "Habitaciones/Apartamentos"))

df_extrahoteleros_mun <- df_extrahoteleros %>%
  filter(cat == "TOTAL CATEGORÍAS" & mun == municipio_actual$municipio & periodo == mes_actual$periodo) %>% 
  select(ind, valor_extrahoteleros = valor)

df_establecimientos_mun <- df_hoteles_mun %>% 
  left_join(df_extrahoteleros_mun, by = "ind")

Num_Hoteles <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Establecimientos")] %>% format(big.mark = ".", decimal.mark = ",")
Plazas_Hoteles <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Plazas")] %>% format(big.mark = ".", decimal.mark = ",")
Num_Habitaciones <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Habitaciones/Apartamentos")] %>% format(big.mark = ".", decimal.mark = ",")
Num_extrahoteleros <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Establecimientos")] %>% format(big.mark = ".", decimal.mark = ",")
Plazas_extrahoteleros <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Plazas")] %>% format(big.mark = ".", decimal.mark = ",")
Num_Apartamentos <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Habitaciones/Apartamentos")] %>% format(big.mark = ".", decimal.mark = ",")
```


```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator3 = function(label, value, image) {
  return(sprintf("<div class='indicator3'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator3s = function(label, value) {
  return(sprintf("<div class='indicator3'><div class='indicator-content'><p class='value'>%s</p><hr class='separator'><p class='label'>%s</p></div></div>", value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r mes_actual$periodo_formatted`</h3>
<h2 style="color: #666; margin: 0;">Indicadores de alojamientos turísticos</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Viajeros` personas alojadas</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$nombre[i], leyenda_poblacion$valor[i], leyenda_poblacion$tasa[i]))
}
```
</div>
</div>

<div class="row">
```{r Indicadores principales, results='asis'}
if(Variacion_Porcentual == "NA"){
  cat(paste0(
    "<div class='column-3-ind'>", get_indicator2('Estancia</br>media', Num_estancia_media, './img/cama.png'), "</div><div class='column-3-ind'>", get_indicator2('Tasa de<br>ocupación', Tasa_ocupacion,'./img/percent-blue.png'), "</div><div class='column-3-ind'>", get_indicator2('Tarifa media<br>diaria', ADR, './img/euro.png'), "</div>"))
}else{
  cat(paste0(
    "<div class='column-4'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual, '%'), Imagen_Variacion), "</div><div class='column-4'>", get_indicator2('Estancia</br>media', Num_estancia_media, './img/cama.png'), "</div><div class='column-4'>", get_indicator2('Tasa de<br>ocupación', Tasa_ocupacion,'./img/percent-blue.png'), "</div><div class='column-4'>", get_indicator2('Tarifa media<br>diaria', ADR, './img/euro.png'), "</div>"))
}
```
</div>

```{r funciones mapa}
get_map_box_before = function(column_number, aditional_classes = '') {
  return(sprintf('<div class="column-%s"><div class="indicator-map %s"><div class="image">', column_number, aditional_classes))
}
get_map_box_after = function(rank, territorio, n_municipios, percent) {
  return(sprintf('</div><div class="indicator-content"><p class="label"><span class="value">%s </span>en %s</p><p class="label2">de %s municipios (%s)</p></div></div></div>', rank, territorio, n_municipios, percent))
}
```

<div class="row" style="margin-top:10px;">
`r if_else(Plazas_Hoteles == "NA" & Plazas_extrahoteleros == "NA", get_map_box_before(2, 'map-canarias'), get_map_box_before(3, 'map-canarias'))`
```{r}
mapa_Canarias_plot
```
`r get_map_box_after(paste0(rk_canarias, 'º'), 'Canarias', num_mun_canarias, paste0(percent_canarias, '%'))`

`r if_else(Plazas_Hoteles == "NA" & Plazas_extrahoteleros == "NA", get_map_box_before(2), get_map_box_before(3))`
```{r}
mapa_isla_plot
```
`r get_map_box_after(paste0(rk_isla, 'º'),  municipio_actual$isla, num_mun_isla, paste0(percent_isla, '%'))`

```{r Indicadores tipo alojamiento, results='asis'}
if(Plazas_Hoteles == "NA" & Plazas_extrahoteleros != "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 38px;"><div class="row"><p class="label"><span class="value">', Num_extrahoteleros,' </span> Apartamentos</p></div><div class="row"><p class="label2" style="margin-top: 31px;"><span class="value2">', Plazas_extrahoteleros,' </span>plazas</p></div><div class="row"><p class="label2" style="margin-top: 10px;"><span class="value2">', Num_Apartamentos,' </span>apartamentos</p></div></div></div></div></div>'))
}else if(Plazas_Hoteles != "NA" & Plazas_extrahoteleros == "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 38px;"><div class="row"><p class="label"><span class="value">', Num_Hoteles,' </span> Hoteles</p></div><div class="row"><p class="label2" style="margin-top: 31px;"><span class="value2">', Plazas_Hoteles,' </span>plazas</p></div><div class="row"><p class="label2" style="margin-top: 10px;"><span class="value2">', Num_Habitaciones,' </span>habitaciones</p></div></div></div></div></div>'))
}else if(Plazas_Hoteles != "NA" & Plazas_extrahoteleros != "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 8px;"><div class="row"><p class="label"><span class="value">', Num_Hoteles,' </span> Hoteles</p></div><div class="row"><p class="label2" style="margin-top: 12px;"><span class="value2">', Plazas_Hoteles,' </span>plazas en <span class="value2">', Num_Habitaciones,' </span>habitaciones</p></div></div></div><div class="indicator-map" style="margin-top: 14px;"><div class="indicator-content" style="margin-top: -10px; padding: 8px;"><div class="row"><p class="label"><span class="value">', Num_extrahoteleros,' </span> Apartamentos</p></div><div class="row"><p class="label2" style="margin-top: 12px;"><span class="value2">', Plazas_extrahoteleros,' </span>plazas en <span class="value2">', Num_Apartamentos,' </span>apartamentos</p></div></div></div></div></div>'))
}
```

</div>

<div class="row">
<div class="column indicator-title">
  <h3>Nacionalidades</h3>
</div>
<div class="column indicator-title">
  <h3>Islas de residencia</h3>
</div>
</div>

<div class="row">

<div class="column highlight">

<div class="piramide" style="height: 330px;">
  `r g_viajeros_lugar`
</div>

<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
  <div class='progress-bar-C-a'>|</div><div class='sp-content-b'>Canarias</div></div>
</div>

<div class="row" style="margin: 24px 0 20px;">
  <div class="column-2">`r get_indicator3('España', paste0(peso_española, '%'), './img/spain2.png')`</div>
  <div class="column-2">`r get_indicator3('Extranjero', paste0(peso_extranjera, '%'), './img/world.png')`</div>
</div>

</div>

<div class="column highlight">

<div class="piramide" style="height: 330px;">
  `r g_aloj_isla`
</div>
<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
  <div class='progress-bar-C-a'>|</div><div class='sp-content-b'>Canarias</div></div>
</div>

<div class="row" style="margin: 14px 0 6px;">
  <div class="column-2">`r get_indicator3s('Canarias respecto</br>a España', paste0(peso_Canarias_Esp, "%"))`</div>
  <div class="column-2">`r get_indicator3s('Canarias respecto</br>al total', paste0(peso_Canarias_Tot, "%"))`</div>
</div>
</div>

</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

