---
title: ''
params:
  id_municipio: 35017
  año: 2018
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.presupuesto_1: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000001/1.1?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:INGRESOS:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901&lang=es
  url.presupuesto_1_inicial: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000001/1.1?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_INICIAL:PRESUPUESTO_PARTIDA:INGRESOS:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901&lang=es
  url.ingresos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/3a8ca845-4811-4f93-a23c-9e8480173d25/data?representation=MEASURE%5BABSOLUTE%5D
  url.gastos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/64d29481-fe6d-4919-a9de-5ab096c61680/data?representation=MEASURE%5BABSOLUTE%5D
  url.presupuesto_1_porcent: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000001/1.1?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO_PORCENTAJE:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_1|G_2|G_3|G_4|G_5|G_6|G_7|G_8|G_9|I_1|I_2|I_3|I_4|I_5|I_6|I_7|I_8|I_9:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901&lang=es
  url.presupuesto_2: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000002/1.0?dim=TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_PARTIDA:GASTOS:PRESUPUESTO_PROGRAMA_GASTOS:0|1|2|3|4|9&lang=es
  url.presupuesto_3: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000003/1.0?dim=TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901:MEDIDAS:AHORRO_BRUTO|AHORRO_BRUTO_PORCENTAJE|AHORRO_NETO|AHORRO_NETO_PORCENTAJE|CARGA_FINANCIERA|CARGA_FINANCIERA_PORCENTAJE&lang=es
  
  url.presupuesto_4_2010: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000004/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2011: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000005/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2012: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000006/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2013: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000007/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2014: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000008/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2015: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000009/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2016: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000010/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2017: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000011/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2018: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000012/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2019: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000013/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.presupuesto_4_2020: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000014/1.0?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:G_60|G_61|G_62|G_63|G_64|G_65|G_68|G_69|G_72|G_73|G_74|G_75|G_76|G_77|G_78|G_79|G_10|G_11|G_12|G_13|G_14|G_15|G_16|G_20|G_21|G_22|G_23|G_24|G_25|G_26|G_27|G_30|G_31|G_32|G_33|G_34|G_35|G_42|G_43|G_44|G_45|G_46|G_47|G_48|G_49|G_50|I_60|I_61|I_68|I_72|I_73|I_74|I_75|I_76|I_77|I_78|I_79|I_7T|I_10|I_11|I_13|I_17|I_18|I_19|I_22|I_28|I_29|I_30|I_31|I_32|I_33|I_34|I_35|I_36|I_38|I_39|I_42|I_43|I_44|I_45|I_46|I_47|I_48|I_49|I_4T|I_50|I_51|I_52|I_53|I_54|I_55|I_59:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.partida_codes: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_PPTOS_ES_EELL_ESTRUCTURA_ECONOMICA/01.000/codes?limit=100000
  

output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías}
library(jsonlite)
library(ggplot2)
library(knitr)
library(data.table)
library(plotly)
library(plyr)
library(dplyr)
library(scales)
library(htmlwidgets)
library(sf)
library(fuzzyjoin)
library(xml2)
library(XML)
library(tidyverse)
library(tmap)
library(magrittr)
library(ggpol)
library(reshape2)
library(kableExtra)

signo <- function(value) { ifelse(value > 0, "más", "menos") }

"%notin%" <- Negate("%in%")
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>% # x) { df_CL_AREA["name"][[c(1,x)]][[2]]}) %>% 
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
mapa_Canarias <- st_read(params$url.mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% st_sf

palette <- c('#8CD2EA', '#005980')
mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla)
mapa_comarca <- filter(mapa_Canarias, mapa_Canarias$geocode %in% (df_CL_AREA_mun[df_CL_AREA_mun$id_comarca == municipio_actual$id_comarca,]$id))

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0)


mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA)

mapa_comarca_plot <- tm_shape(mapa_comarca) + 
                     tm_borders() + 
                     tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                     tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_localizacion, df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución del presupuesto}
# Presupuesto inicial
data_I <- fromJSON(params$url.presupuesto_1_inicial)
df_I <- data.frame(Año = rep(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                             each = length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
                   Municipio = rep(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                                   times = length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
                   Valor = unlist(c(strsplit(data_I[["data"]][["observations"]], split = " | ", fixed = TRUE), NA)))
df_I$Valor <- as.numeric(df_I$Valor)
df_I <- df_I[with(df_I, order(Año)), ] %>% filter(Municipio == params$id_municipio) %>% mutate(Valor_M = round(Valor / 10^6, 1)) %>%
  transform(Municipio = paste0(municipio_actual$municipio, "_inicial")) %>% filter(Año != min(Año) & Año <= params$año)


# Liquidación del presupuesto consolidado de ingresos y gastos de las Entidades Locales según capítulos de la estructura económica y fases presupuestarias. Islas y municipios de Canarias por años 2002-2019 [tabla1]
data_u <- fromJSON(params$url.presupuesto_1)

df_u <- data.frame(Año = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                             each = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
                   Municipio = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                                   times = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
                   Valor = unlist(c(strsplit(data_u[["data"]][["observations"]], split = " | ", fixed = TRUE), NA)))
df_u$Valor <- as.numeric(df_u$Valor)
df_u <- df_u[with(df_u, order(Año)), ] %>% mutate(Valor_M = round(Valor / 10^6, 1))

related_mun <- df_u %>% filter(Año == params$año)
related_mun <- seleccion_mun(df_localizacion, related_mun  %>% select(mun = Municipio, Valor), 'Valor')

leyenda.template_I <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Presupuesto inicial: <span class='sp-habitantes'>%s mill. €</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s mill. €</span><br/>Tasa de crecimiento: <span class='sp-tasa'>%s&percnt;</span></div></div>"
leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s mill. €</span><br/>Tasa de crecimiento: <span class='sp-tasa'>%s&percnt;</span></div></div>"
leyenda.content_I <- "<span class='sp-municipio'>%s</span><br/>Presupuesto inicial: <span class='sp-habitantes'>%s mill. €</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s mill. €</span><br/>Tasa de crecimiento: <span class='sp-tasa'>%s&percnt;</span>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Presupuesto ejecutado: <span class='sp-habitantes'>%s</span><br/>Tasa de crecimiento: <span class='sp-tasa'>%s&percnt;</span>"

df <- related_mun %>%
  select(Municipio = "mun") %>%
  left_join(df_u, by = "Municipio") %>%
  select(id = Municipio, Año, Valor, Valor_M) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(Año, Municipio = municipio, Valor, Valor_M) %>% 
  mutate(Tasa =  round(100*((Valor / lag(Valor)) - 1), 1), Año = as.numeric(Año)) %>%
  # left_join(rep(df_I, 3), by = "Año") %>%
  # filter(!is.na(Tasa)) %>% 
  filter(Año != min(Año) & Año <= params$año)

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)',
                             'rgba(0, 139, 208, 0.8)',
                             'rgba(140, 210, 234, 0.8)'
                             )[1:(nrow(related_mun))],
                           related_mun$nombre)

df <- as.data.frame(cbind(df, Valor_inicial = df_I$Valor_M))

leyenda_poblacion <- df %>% filter(Año == params$año) %>%
  mutate(Valor_inicial = format(Valor_inicial, big.mark = ".", decimal.mark = ",")) %>%
  mutate(Valor_M = format(Valor_M, big.mark = ".", decimal.mark = ",")) %>%
  mutate(Tasa = format(Tasa, big.mark = ".", decimal.mark = ",")) %>%
  left_join(data.frame(cbind(Municipio = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "Municipio")

df <- df %>%
  mutate(
    tooltip = ifelse(
      Municipio == municipio_actual$municipio,
      sprintf(leyenda.content_I, Municipio, format(Valor_inicial, big.mark = ".", decimal.mark = ","), format(Valor_M, big.mark = ".", decimal.mark = ","),
              format(Tasa, big.mark = ".", decimal.mark = ",")),
      sprintf(leyenda.content, Municipio, paste0(format(Valor_M, big.mark = ".", decimal.mark = ","), ' mill. € (',Año,')'), format(Tasa, big.mark = ".", decimal.mark = ","))
              )
  )

g_line <- ggplot(data = df, aes(x = Año)) +
  geom_line(size = 0.7, aes(y = Valor_M, group = Municipio, colour = Municipio, text = tooltip)) +
  # geom_line(linetype = "dashed", colour = 'rgba(0, 89, 128, 0.8)', aes(y = Valor_inicial, text = "")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  # scale_linetype_manual(values = g_line_type) +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1))+
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), " mill.")}, n.breaks = 6) #+
  # labs(colour = " ", caption = paste0("<b>Municipio: ", df$Municipio, "<br>Gasto por habitante: ", format(df$Valor, big.mark = ".", decimal.mark = ","), "</b>"))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified') %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) {
        console.log(d);
        highlight(d);
      });
      
      el.on('plotly_unhover', function(d) {
        reset(d);
      });
      
      el.on('plotly_click', function(d) {
        highlight(d);
      });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ")
```

```{r Indicador evolución del presupuesto}
df_lv <- df %>% 
  filter(Municipio == municipio_actual$municipio & Año %in% c(params$año, params$año-1))

Num_Presupuesto <-  format(round(df_lv$Valor_M[df_lv$Año == params$año], 1), big.mark = ".", decimal.mark = ",")
Variacion_Presupuesto <- format(round(abs(df_lv$Valor_M[df_lv$Año == params$año] - df_lv$Valor_M[df_lv$Año == params$año-1]), 1), big.mark=".",decimal.mark = ",")
Signo_Variacion <- signo(df_lv$Valor_M[df_lv$Año == params$año] - df_lv$Valor_M[df_lv$Año == params$año-1])
Imagen_Variacion <- ifelse(Signo_Variacion == "más", './img/up.png', './img/down.png')
Variacion_Porcentual_Presupuesto <- format(df_lv$Tasa[df_lv$Año == params$año], big.mark =".", decimal.mark = ",")
```

```{r Rankings}
data_Presupuesto_ranking <- data_u

df_Presupuesto_ranking <- data.frame(año = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                                               each = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
                                     id = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                                              times = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
                                     valor = as.numeric(unlist(c(strsplit(data_u[["data"]][["observations"]], split = " | ", fixed = TRUE), NA)))) %>%
  filter(año == params$año) %>%
  inner_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))
#df_Presupuesto_ranking$valor <- df_Presupuesto_ranking$valor %>% as.numeric()

rk_Presupuesto_canarias <- grep(params$id_municipio, df_Presupuesto_ranking$id)
num_mun_canarias <- nrow(df_Presupuesto_ranking)
percent_canarias <- format(round(df_Presupuesto_ranking[which(df_Presupuesto_ranking$id==params$id_municipio),]$valor / sum(df_Presupuesto_ranking$valor) * 100, 1),
                           big.mark=".",decimal.mark = ",")

rk_Presupuesto_isla <- df_Presupuesto_ranking %>% filter(isla == municipio_actual$isla)
rk_isla <- grep(params$id_municipio, rk_Presupuesto_isla$id)
num_mun_isla <- nrow(rk_Presupuesto_isla)
percent_isla <- format(round(rk_Presupuesto_isla[which(rk_Presupuesto_isla$id==params$id_municipio),]$valor / sum(rk_Presupuesto_isla$valor) * 100, 1), big.mark=".",decimal.mark = ",")

rk_Presupuesto_comarca <- df_Presupuesto_ranking %>% filter(comarca == municipio_actual$comarca)
rk_comarca <- grep(params$id_municipio, rk_Presupuesto_comarca$id)
num_mun_comarca <- nrow(rk_Presupuesto_comarca)
percent_comarca <- format(round(rk_Presupuesto_comarca[which(rk_Presupuesto_comarca$id==params$id_municipio),]$valor / sum(rk_Presupuesto_comarca$valor) * 100, 1),
                          big.mark=".",decimal.mark = ",")
```

```{r Ingresos por habitante}
# Presupuesto liquidado. Ingresos por habitante. Ayuntamientos. 2002-2019
ind_Ingresos <- fromJSON(params$url.ingresos)

df_ind_Ingresos <- data.frame(id_municipio = rep(names(ind_Ingresos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                                                 each=ind_Ingresos[["dimension"]][["TIME"]][["representation"]][["size"]]),
                              año = names(ind_Ingresos[["dimension"]][["TIME"]][["representation"]][["index"]]),
                              valor = as.numeric(ind_Ingresos[["observation"]]))

Num_Ingresos_hab <- df_ind_Ingresos %>% filter(id_municipio == params$id_municipio & año == params$año) %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
```

```{r Gastos por habitante}
# Presupuesto liquidado. Gastos por habitante. Ayuntamientos. 2002-2019
ind_Gastos <- fromJSON(params$url.gastos)

df_ind_Gastos <- data.frame(id_municipio = rep(names(ind_Gastos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                                               each=ind_Gastos[["dimension"]][["TIME"]][["representation"]][["size"]]),
                            año = names(ind_Gastos[["dimension"]][["TIME"]][["representation"]][["index"]]),
                            valor = as.numeric(ind_Gastos[["observation"]]))

Num_Gastos_hab <- df_ind_Gastos %>% filter(id_municipio == params$id_municipio & año == params$año) %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
```

```{r Diferencia entre el presupuesto ejecutado y el incial}
GAP <- format(round(((df_lv$Valor_M[df_lv$Año == params$año]) - (df_lv$Valor_inicial[df_lv$Año == params$año])), 1), big.mark = ".", decimal.mark = ",") %>% as.character()
```

```{r Estructura según partidas}
url_estr_partidas <- data.frame(cbind(
  año = c(2010:2020),
  url = c(params$url.presupuesto_4_2010, params$url.presupuesto_4_2011, params$url.presupuesto_4_2012, params$url.presupuesto_4_2013, params$url.presupuesto_4_2014,
          params$url.presupuesto_4_2015, params$url.presupuesto_4_2016, params$url.presupuesto_4_2017, params$url.presupuesto_4_2018, params$url.presupuesto_4_2019, 
          params$url.presupuesto_4_2020)))
url <- url_estr_partidas$url[which(url_estr_partidas$año == params$año)]
data_estr_partidas <- fromJSON(url)

df_estr_partidas <- data.frame(
  id_partida = rep(data_estr_partidas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
                each = length(data_estr_partidas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_municipio = rep(data_estr_partidas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                     times = length(data_estr_partidas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  valor = unlist(strsplit(data_estr_partidas[["data"]][["observations"]], split = " | ", fixed = TRUE)))
df_estr_partidas$valor <- as.numeric(df_estr_partidas$valor)
df_estr_partidas$valor[is.na(df_estr_partidas$valor)] <- 0

df_estr_partidas_mun <- df_estr_partidas %>% filter(id_municipio == params$id_municipio) %>% select(!id_municipio)
df_estr_partidas_mun <- df_estr_partidas_mun

CL_PARTIDA <- as_list(read_xml(params$url.partida_codes))

df_CL_PARTIDA <- tibble::as_tibble(CL_PARTIDA) %>% 
  unnest_wider('codes') %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_PARTIDA_dos <- df_CL_PARTIDA %>%
  select(id = code, partida = value, code = parent) %>%
  filter(nchar(id) == 4) %>%
  left_join(df_CL_PARTIDA, by = "code") %>%
  select(id_partida = id, partida, id_1 = code, name_1 = value) %>%
  mutate(tabla_partida = paste0(name_1, ": ", partida)) %>% 
  mutate(name_partida = paste0(name_1, ":<br>", partida))

df_estr_partidas_mun <- df_estr_partidas_mun %>% inner_join(df_CL_PARTIDA_dos, by = "id_partida") %>% select(!c(partida, id_1, name_1))
```

```{r Barras Estructura Gastos por partidas}
df_estr_part_gastos_mun <- df_estr_partidas_mun %>% filter(substring(id_partida, 0,1) == "G") %>% arrange(-valor) %>% top_n(5, valor)

df_otros_G <- df_estr_partidas_mun %>% filter(substring(id_partida, 0,1) == "G" & id_partida %notin% df_estr_part_gastos_mun$id_partida)

df_part_gastos_mun <- rbind(df_estr_part_gastos_mun, c("G_otros", sum(df_otros_G$valor), rep("Otros gastos", 2)))
df_part_gastos_mun$valor <- as.numeric(df_part_gastos_mun$valor)
df_part_gastos_mun <- df_part_gastos_mun %>%
  mutate(porcentaje = df_part_gastos_mun$valor / sum(df_part_gastos_mun$valor) * 100)

df_estr_partidas_C <- df_estr_partidas %>% 
  group_by(id_partida) %>% 
  summarise(valor = sum(valor)) %>%
  inner_join(df_CL_PARTIDA_dos, by = "id_partida") %>%
  select(c(id_partida, valor, tabla_partida, name_partida))

df_estr_part_gastos_C <- df_estr_partidas_C %>% filter(substring(id_partida, 0,1) == "G" & id_partida %in% df_estr_part_gastos_mun$id_partida)
 
df_otros_G <- df_estr_partidas_C %>% filter(substring(id_partida, 0,1) == "G" & id_partida %notin% df_estr_part_gastos_mun$id_partida)

df_part_gastos_C <- rbind(df_estr_part_gastos_C, c("G_otros", sum(df_otros_G$valor), rep("Otros gastos", 2)))
df_part_gastos_C$valor <- as.numeric(df_part_gastos_C$valor)
df_part_gastos_C <- df_part_gastos_C %>%
  mutate(porcentaje = df_part_gastos_C$valor / sum(df_part_gastos_C$valor) * 100)

df_part_gastos_mun <- df_part_gastos_mun %>% transform(hovertext = paste0(
    "<b>", name_partida,"</b><br>",
    trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

df_part_gastos_mun_0 <- df_part_gastos_mun %>%
  left_join(df_part_gastos_C, by = c("id_partida", "tabla_partida", "name_partida")) %>% 
  select(c(id_partida, valor = valor.y, tabla_partida, name_partida, porcentaje = porcentaje.y, hovertext))
df_part_gastos_mun <- rbind.data.frame(df_part_gastos_mun, df_part_gastos_mun_0)

df_part_gastos_mun$id_partida <- ordered(df_part_gastos_mun$id_partida, levels = c("G_otros", df_estr_part_gastos_mun$id_partida[5:1]))

df_part_gastos_C <- df_part_gastos_C %>% transform(hovertext = paste0(
    "Canarias: ", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

g_estr_part_gastos <- ggplot() +
  geom_line(data = df_part_gastos_mun,
            size = 2, alpha = 0.8, aes(x = id_partida, y = porcentaje, colour = id_partida, fill = id_partida, name = NULL, text = NULL)) +
  geom_point(data = df_part_gastos_mun,
             size = 4, aes(x = id_partida, y = porcentaje, colour = id_partida, fill = id_partida, name = NULL, text = hovertext)) +
  geom_point(data = df_part_gastos_C,
             size = 4, color = "#59656E", aes(x = id_partida, y = porcentaje, text = hovertext)) +
  scale_colour_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  scale_fill_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(n.breaks = 5, labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')}) +
  coord_flip()

g_estr_part_gastos <- ggplotly(g_estr_part_gastos, tooltip = c("text")) %>%
  layout(hovermode = "y unified", showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(1:6))
```

```{r Tabla Estructura Gastos por partidas}
tb_part_gastos <- df_part_gastos_mun[1:6,] %>%
  select(c(id_partida, tabla_partida)) %>% 
  kable(format = "html",
        col.names = c("Código", "Nombre de la partida de gastos")) %>%
  kable_styling(bootstrap_options = c("bordered", "condensed"),
                full_width = FALSE,
                position = "left") %>%
  column_spec(1, width = "20%") %>%
  column_spec(2, width = "80%")
```

```{r Barras Estructura Ingresos por partidas}
df_estr_part_ingresos_mun <- df_estr_partidas_mun %>% filter(substring(id_partida, 0,1) == "I") %>% arrange(-valor) %>% top_n(5, valor)

df_otros_I <- df_estr_partidas_mun %>% filter(substring(id_partida, 0,1) == "I" & id_partida %notin% df_estr_part_ingresos_mun$id_partida)

df_part_ingresos_mun <- rbind(df_estr_part_ingresos_mun, c("I_otros", sum(df_otros_I$valor), rep("Otros ingresos", 2)))
df_part_ingresos_mun$valor <- as.numeric(df_part_ingresos_mun$valor)
df_part_ingresos_mun <- df_part_ingresos_mun %>%
  mutate(porcentaje = df_part_ingresos_mun$valor / sum(df_part_ingresos_mun$valor) * 100,
         label = "|")

df_estr_part_ingresos_C <- df_estr_partidas_C %>% filter(substring(id_partida, 0,1) == "I" & id_partida %in% df_estr_part_ingresos_mun$id_partida)
 
df_otros_I <- df_estr_partidas_C %>% filter(substring(id_partida, 0,1) == "I" & id_partida %notin% df_estr_part_ingresos_mun$id_partida)

df_part_ingresos_C <- rbind(df_estr_part_ingresos_C, c("I_otros", sum(df_otros_I$valor), rep("Otros ingresos", 2)))
df_part_ingresos_C$valor <- as.numeric(df_part_ingresos_C$valor)
df_part_ingresos_C <- df_part_ingresos_C %>%
  mutate(porcentaje = df_part_ingresos_C$valor / sum(df_part_ingresos_C$valor) * 100,
         label = "|")

df_part_ingresos_mun <- df_part_ingresos_mun %>% transform(hovertext = paste0(
    "<b>", name_partida,"</b><br>",
    trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

df_part_ingresos_mun_0 <- df_part_ingresos_mun %>%
  left_join(df_part_ingresos_C, by = c("id_partida", "tabla_partida", "name_partida", "label")) %>% 
  select(c(id_partida, valor = valor.y, tabla_partida, name_partida, porcentaje = porcentaje.y, hovertext, label))
df_part_ingresos_mun <- rbind.data.frame(df_part_ingresos_mun, df_part_ingresos_mun_0)

df_part_ingresos_mun$id_partida <- ordered(df_part_ingresos_mun$id_partida, levels = c("I_otros", df_estr_part_ingresos_mun$id_partida[5:1]))

df_part_ingresos_C <- df_part_ingresos_C %>% transform(hovertext = paste0(
    "Canarias:<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

g_estr_part_ingresos <- ggplot() +
  geom_line(data = df_part_ingresos_mun,
            size = 4, alpha = 0.8, aes(x = id_partida, y = porcentaje, colour = id_partida, fill = id_partida, name = NULL, text = NULL)) +
  geom_text(data = df_part_ingresos_mun,
             size = 8, aes(x = id_partida, y = porcentaje, label = label, colour = id_partida, fill = id_partida, name = NULL, text = hovertext)) +
  geom_text(data = df_part_ingresos_C,
             size = 8, color = "#59656E", aes(x = id_partida, y = porcentaje, label = label, text = hovertext)) +
  scale_colour_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  scale_fill_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(n.breaks = 5, labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')}) +
  coord_flip()

g_estr_part_ingresos <- ggplotly(g_estr_part_ingresos, tooltip = c("text")) %>%
  layout(hovermode = "y unified", showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(1:6))
```

```{r Tabla Estructura Ingresos por partidas}
tb_part_ingresos <- df_part_ingresos_mun[1:6,] %>%
  select(c(id_partida, tabla_partida)) %>% 
  kable(format = "html",
        col.names = c("Código", "Nombre de la partida de ingresos")) %>%
  kable_styling(bootstrap_options = c("bordered", "condensed"),
                full_width = FALSE,
                position = "left") %>%
  column_spec(1, width = "20%") %>%
  column_spec(2, width = "80%")
```

```{r Barras Gastos por programas}
# Liquidación del presupuesto consolidado de gastos de las Entidades Locales según estructura funcional, capítulos de la estructura económica y fases presupuestarias. Islas y municipios de Canarias por años 2010-2020 [tabla2]
data_gastos_programas <- fromJSON(params$url.presupuesto_2)

df_programa <- data.frame(
  id = data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["id"]],
  name_programa = c(data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[1]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[2]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[3]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[4]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[5]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[6]][["value"]],
                    data_gastos_programas[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[6]][["name"]][["text"]][[7]][["value"]]),
  programa = c("Presupuesto de gastos", "Deuda Pública", "Servicios<br>públicos básicos", "Actuaciones de<br>protección y<br>promoción social",
               "Producción de<br>bienes públicos de<br>carácter preferente", "Actuaciones de<br>carácter económico", "Actuaciones de<br>carácter general"),
  id_programa = c("PG", "DP", "SPB", "APPS", "PBPCP", "ACE", "ACG"))

df_gastos_programas <- data.frame(
  año = rep(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) * length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]]) * length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[6]][["code"]])),
  id_municipio = rep(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
            each = length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]]) * length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[6]][["code"]])),
  partida = rep(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                each = length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[6]][["code"]])),
  name_programa = rep(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[6]][["code"]],
                      times = length(data_gastos_programas[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  valor = c(unlist(strsplit(data_gastos_programas[["data"]][["observations"]], split = " | ", fixed = TRUE)), 0))
df_gastos_programas$name_programa <- factor(
  df_gastos_programas$name_programa,
  levels = df_programa$id,
  labels = df_programa$name_programa)
df_gastos_programas$valor <- as.numeric(df_gastos_programas$valor)

df_gastos_programas_mun <- df_gastos_programas %>% filter(año == params$año & id_municipio == params$id_municipio) %>% arrange(valor) %>% select(c(name_programa, valor))

df_gastos_programas_C <- df_gastos_programas %>%
  filter(año == params$año & !is.na(valor)) %>% 
  group_by(name_programa) %>% 
  summarise(valor = sum(valor)) %>%
  select(c(name_programa, valor))

df_gastos_programas_mun <- df_gastos_programas_mun %>%
  # left_join(df_gastos_programas_C, by = "name_programa") %>% 
  left_join(df_programa, by = "name_programa") %>% 
  mutate(porcentaje = df_gastos_programas_mun$valor / sum(df_gastos_programas_mun$valor) * 100,
         label = "|")

df_gastos_programas_mun <- df_gastos_programas_mun %>% transform(hovertext = paste0(
    "<b>", programa, " </b>",
    "<br>",trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

df_gastos_programas_C <- df_gastos_programas_C %>%
  left_join(df_programa, by = "name_programa") %>%
  mutate(porcentaje = df_gastos_programas_C$valor / sum(df_gastos_programas_C$valor) * 100,
         label = "|")

df_gastos_programas_0 <- df_gastos_programas_mun %>%
  left_join(df_gastos_programas_C, by = c("name_programa", "id", "programa", "id_programa", "label")) %>% 
  select(c(name_programa, valor = valor.y, id, programa, id_programa, porcentaje = porcentaje.y, hovertext, label))
df_gastos_programas_mun_ <- rbind(df_gastos_programas_mun, df_gastos_programas_0)

df_gastos_programas_C <- df_gastos_programas_C %>%
  transform(hovertext = paste0(
    "Canarias:<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)"
    )
  )

df_gastos_programas_mun$name_programa <- ordered(df_gastos_programas_mun$name_programa, levels = df_gastos_programas_mun$name_programa)
df_gastos_programas_mun_$name_programa <- ordered(df_gastos_programas_mun_$name_programa, levels = df_gastos_programas_mun$name_programa)

g_gastos_programas <- ggplot() +
  geom_line(data = df_gastos_programas_mun_,
            size = 2, alpha = 0.8, aes(x = name_programa, y = porcentaje, colour = name_programa, fill = name_programa, name = NULL, text = NULL)) +
  geom_point(data = df_gastos_programas_mun,
             size = 4, aes(x = name_programa, y = porcentaje, colour = name_programa, fill = name_programa, name = NULL, text = hovertext)) +
  geom_text(data = df_gastos_programas_C, 
            size = 6, color = "#59656E", aes(x = name_programa, y = porcentaje, label = label, text = hovertext)) +
  scale_colour_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  scale_fill_manual(values = c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_discrete(labels = df_gastos_programas_mun$id_programa) +
  scale_y_continuous(n.breaks = 5, labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')}) +
  coord_flip()

g_gastos_programas <- ggplotly(g_gastos_programas, tooltip = c("text")) %>%
  layout(hovermode = "y unified", showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(1:6))
```

```{r Tabla Gastos por programas}
tb_gastos_programas <- df_gastos_programas_mun[1:6,] %>% 
  arrange(-valor) %>%
  select(c(id_programa, name_programa)) %>% 
  kable(format = "html",
        col.names = c("Código", "Nombre del programa")) %>%
  kable_styling(bootstrap_options = c("bordered", "condensed"),
                full_width = FALSE,
                position = "left") %>%
  column_spec(1, width = "20%") %>%
  column_spec(2, width = "80%")
```

```{r Salud financiera}
# Indicadores generales de los presupuestos consolidados de las Entidades Locales ejecutados. Islas y municipios de Canarias por años. 2002-2019
# Indicadores generales de la liquidación presupuestaria de las Entidades Locales de Canarias 2002-2019 [tabla3]
data_ind_presupuestos <- fromJSON(params$url.presupuesto_3)

df_presupuestos <- data.frame(
  año = rep(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) * length(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
  id_municipio = rep(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                     each = length(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
  medida = rep(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
               times = length(data_ind_presupuestos[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(c(strsplit(data_ind_presupuestos[["data"]][["observations"]], split = " | ", fixed = TRUE), NA)))
df_presupuestos$valor <- df_presupuestos$valor %>% as.numeric()

df_presupuestos_mun <- df_presupuestos %>% filter(año == params$año & id_municipio == params$id_municipio) %>% select(!c(año, id_municipio))

Percent_Ahorro_Bruto <- df_presupuestos_mun$valor[which(df_presupuestos_mun$medida == "AHORRO_BRUTO_PORCENTAJE")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
Percent_Ahorro_Neto <- df_presupuestos_mun$valor[which(df_presupuestos_mun$medida == "AHORRO_NETO_PORCENTAJE")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
Percent_Carga_Fin <- df_presupuestos_mun$valor[which(df_presupuestos_mun$medida == "CARGA_FINANCIERA_PORCENTAJE")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()

# En millones de €:
df_presupuestos_mill <- df_presupuestos_mun %>%
  filter(medida %in% c("AHORRO_BRUTO", "AHORRO_NETO", "CARGA_FINANCIERA")) %>% 
  mutate(valor_mill = valor / 10^6)
Num_Ahorro_Bruto <- df_presupuestos_mill$valor_mill[which(df_presupuestos_mill$medida == "AHORRO_BRUTO")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
Num_Ahorro_Neto <- df_presupuestos_mill$valor_mill[which(df_presupuestos_mill$medida == "AHORRO_NETO")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
Num_Carga_Fin <- df_presupuestos_mill$valor_mill[which(df_presupuestos_mill$medida == "CARGA_FINANCIERA")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
```


```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator3 = function(label, value, image) {
  return(sprintf("<div class='indicator3'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator4 = function(title, label, value) {
  return(sprintf("<div class='indicator4'><div class='title'>%s</div><hr class='separator'><p class='value'>%s</p><p class='label'>%s</p></div>", title, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r params$año`</h3>
<h2 style="color: #666; margin: 0;">Presupuesto ejecutado de ingresos y gastos</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Presupuesto` mill. €</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(ifelse(
    leyenda_poblacion$Municipio[i] == municipio_actual$municipio,
    sprintf(leyenda.template_I, i, leyenda_poblacion$color[i], leyenda_poblacion$Municipio[i], leyenda_poblacion$Valor_inicial[i], leyenda_poblacion$Valor_M[i], leyenda_poblacion$Tasa[i]),
    sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$Municipio[i], leyenda_poblacion$Valor_M[i], leyenda_poblacion$Tasa[i])
    )
  )
}
```
</div>
</div>

<div class="row" style="margin: 15px 0;">
<div class="column-4">`r get_indicator2(paste0(Variacion_Presupuesto, " mill. € ", Signo_Variacion, "</br>que en ", params$año-1), paste0(Variacion_Porcentual_Presupuesto, "%"), Imagen_Variacion)`</div>
<div class="column-4">`r get_indicator2("Ingresos<br>por habitante", paste0(Num_Ingresos_hab, " €"), "./img/ingresos.png")`</div>
<div class="column-4">`r get_indicator2("Gastos<br>por habitante", paste0(Num_Gastos_hab, " €"), "./img/gastos.png")`</div>
<div class="column-4">`r get_indicator2("<br><br>", paste0(GAP, " mill. €"), "./img/equilibrio-presupuestario.png")`</div>

</div>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map">
  <div class="image map-canarias">
```{r} 
mapa_Canarias_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_Presupuesto_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_isla_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_comarca_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_comarca`º </span>en la comarca</p>
  <p class="label2">de `r num_mun_comarca` municipios (`r percent_comarca`%)</p>
  </div>
</div>
</div>
</div>

<div class="indicator-title" style="width: 100% !important; margin-top: 10px; margin-left: 0">
  <h3>Distribución de gastos e ingresos</h3>
</div>

<div class="row highlight" style="width: 100% !important; margin-top: 10px;">
<div class="row">
<div class="column">
  <h4>Gastos</h4>
</div>
<div class="column">
  <h4>Ingresos</h4>
</div>
</div>

<div class="row">
<div class="piechart">`r g_estr_part_gastos`</div>
<div class="piechart">`r g_estr_part_ingresos`</div>
</div>

<div class="row">
<div class="piechart">`r tb_part_gastos`</div>
<div class="piechart">`r tb_part_ingresos`</div>
</div>

</div>


<div class="indicator-title" style="width: 100% !important; margin-top: 10px; margin-left: 0">
  <h3>Gastos por programas</h3>
</div>

<div class="row highlight" style="width: 100% !important; margin-top: 10px;">
<div class="piechart_P">`r g_gastos_programas`</div>
<div class="tablechart">`r tb_gastos_programas`</div>
</div>

<div class="indicator-title" style="width: 100% !important; margin-top: 10px; margin-left: 0">
  <h3>Salud financiera</h3>
</div>
<div class="row highlight" style="width: 100% !important; margin-top: 10px;">
  <div class="column-3">`r get_indicator4("Ahorro bruto", paste0(Percent_Ahorro_Bruto, " %"), paste0(Num_Ahorro_Bruto, " mill. €"))`</div>
  <div class="column-3">`r get_indicator4("Ahorro neto", paste0(Percent_Ahorro_Neto, " %"), paste0(Num_Ahorro_Neto, " mill. €"))`</div>
  <div class="column-3">`r get_indicator4("Carga financiera", paste0(Percent_Carga_Fin, " %"), paste0(Num_Carga_Fin, " mill. €"))`</div>
</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>
