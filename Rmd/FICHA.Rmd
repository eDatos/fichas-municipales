---
title: ''
params:
  id_municipio: 38001
  año: 2009
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.mapa_2007: https://datos.canarias.es/catalogos/estadisticas/dataset/03f5044c-6d40-4c09-84db-eaf9d6681b48/resource/d765c56b-a67d-46e2-800e-5c9a1e9138f0/download/municipios_20170101_antes2007.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.habitantes: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.ind_pobl: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%7CANNUAL_PUNTUAL_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.ranking: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.piramide: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=d619ecaa-319c-4d29-a789-b7708fbaf3be
  url.edad_media: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/87f99b2c-608f-44be-8d7e-2e26681d1b45/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.dependencia: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=7dcb25e5-f533-4ba1-a6aa-70fe8fc69db7
  url.defunciones: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=6a7b1c7f-f345-485c-b9de-e4b1477fe91b
  url.nacimientos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6879177d-dbe7-40f2-a02b-caa806cf064e/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.crec_veg: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=5012a489-2ef4-4ff2-b1bf-ebf6e4c5f2d2
  url.lugar: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=f0c5c903-5648-4822-80be-8da4d3927b98
  url.nacionalidad: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=3a0df911-8098-4b6b-8002-bbfffa892cbc
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías}
library(jsonlite)
library(ggplot2)
library(knitr)
library(data.table)
library(plotly)
library(plyr)
library(dplyr)
library(scales)
library(htmlwidgets)
library(sf)
library(fuzzyjoin)
library(xml2)
library(tidyverse)
library(tmap)
library(magrittr)

"%notin%" <- Negate("%in%")
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>% # x) { df_CL_AREA["name"][[c(1,x)]][[2]]}) %>% 
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  # transform(id = sub("\\_.*", "", id)) %>%
  transform(id = if_else(substring(id, 0,5) == "38013",  "38013", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Pinar de El Hierro, El", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
palette <- c('#8CD2EA', '#005980')

url_mapa <- ifelse(params$año < 2007, params$url.mapa_2007, params$url.mapa)
mapa_Canarias <- st_read(url_mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% 
  select(-c(notas, utm_x_capi, utm_y_capi, long_capi, lati_capi)) %>%
  st_sf

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)

mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla) %>% select(geocode, col)

mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)

mapa_comarca <- filter(mapa_Canarias, mapa_Canarias$geocode %in% (df_CL_AREA_mun[df_CL_AREA_mun$id_comarca == municipio_actual$id_comarca,]$id)) %>% select(geocode, col)

mapa_comarca_plot <- tm_shape(mapa_comarca) + 
                     tm_borders() + 
                     tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                     tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                     tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución de la población}
data_u <- fromJSON(params$url.habitantes)
df_u <- data.frame(Municipio = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                         each=data_u[["dimension"]][["TIME"]][["representation"]][["size"]]),
                   Año = as.numeric(names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]])), 
                   Valor = as.integer(data_u[["observation"]])) %>% 
        arrange(Año)

related_mun <- df_u %>% filter(Año == params$año)
related_mun <- seleccion_mun(related_mun %>% select(mun = Municipio, Valor), 'Valor')

df <- related_mun %>%
  select(Municipio = "mun") %>%
  left_join(df_u, by="Municipio") %>%
  select(id = Municipio, Año, Valor) %>%
  left_join(df_CL_AREA_mun, by="id") %>%
  select(Año, Valor, Municipio = municipio) %>%
  mutate(Tasa = ifelse(Año != min(Año), round(100*((Valor / lag(Valor)) - 1), 1), NA)) %>%
  filter(Año <= params$año & Año != min(Año))

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

df <- df %>% mutate(
    tooltip = ifelse(Año == params$año,
                     sprintf(leyenda.content, Municipio, ifelse(is.na(Valor), " -", format(Valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, Municipio, paste0(ifelse(is.na(Valor), " -", format(Valor, big.mark = ".", decimal.mark = ",")), ' (',Año,')'),
                             ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
    )
) 

g_line <- ggplot(data = df, 
                 aes(x = Año, y = Valor, group = Municipio, colour = Municipio, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_y_continuous(labels = function(x) {paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified') %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) { highlight(d); });
      el.on('plotly_unhover', function(d) { reset(d); });
      el.on('plotly_click', function(d) { highlight(d); });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 

leyenda_poblacion <- df %>% filter(Año == params$año) %>%
  mutate(Valor = ifelse(is.na(Valor), " -", format(Valor, big.mark = ".", decimal.mark = ",")),
         Tasa = ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))) %>%
  left_join(data.frame(cbind(Municipio = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "Municipio")
```

```{r Indicador evolución de la población}
ind_pobl <- fromJSON(params$url.ind_pobl)

df_lv <- data.frame(
  municipio = rep(names(ind_pobl[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
      each=ind_pobl[["dimension"]][["TIME"]][["representation"]][["size"]] * 
      ind_pobl[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  año = rep(names(ind_pobl[["dimension"]][["TIME"]][["representation"]][["index"]]),
      each=ind_pobl[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(ind_pobl[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = as.numeric(ind_pobl[["observation"]])) %>%
  filter(año == params$año & municipio == params$id_municipio)

signo <- function(value) { ifelse(value > 0, "más", "menos") }

Num_Pobl <-  format(df_lv[df_lv$medida == 'ABSOLUTE', ]$valor, big.mark = ".", decimal.mark = ",")
# Variacion_Pobl <- format(abs(df_lv[df_lv$medida == 'ANNUAL_PUNTUAL_RATE', ]$valor), big.mark = ".", decimal.mark = ",")
# Signo_Variacion <- signo(df_lv[df_lv$medida == 'ANNUAL_PUNTUAL_RATE', ]$valor)
Variacion_Pobl <- format(df_lv[df_lv$medida == 'ANNUAL_PUNTUAL_RATE', ]$valor, big.mark = ".", decimal.mark = ",")
Imagen_Variacion <- ifelse(signo(df_lv[df_lv$medida == 'ANNUAL_PUNTUAL_RATE', ]$valor) == "más", './img/up.png', './img/down.png')
Variacion_Porcentual_Pobl <- format(round(df_lv[df_lv$medida == 'ANNUAL_PERCENTAGE_RATE', ]$valor, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Pirámide por edad y sexo}
piramide <- fromJSON(params$url.piramide)
df_piramide <- cbind(data.frame(do.call('rbind', piramide[["data"]][["dimCodes"]])), piramide[["data"]][["Valor"]])
colnames(df_piramide) <- c('mun', 'gredad', 'año', 'sexo', 'valor')
df_piramide$sexo <- factor(df_piramide$sexo , levels=piramide[["categories"]][["codes"]][[4]], labels=piramide[["categories"]][["labels"]][[4]])
df_piramide$valor <- as.numeric(df_piramide$valor)
df_piramide$año <- as.numeric(df_piramide$año)
df_piramide$gredad <- ordered(df_piramide$gredad, levels = piramide[["categories"]][["codes"]][[2]])

Num_Pobl_Isla <- df_piramide %>% filter(mun == municipio_actual$id_isla & gredad == "T" & sexo == "AMBOS SEXOS" & año == params$año) %>% subset(select = "valor") %>%  as.numeric()
df_piramide$mun <- factor(df_piramide$mun , levels=piramide[["categories"]][["codes"]][[1]], labels=piramide[["categories"]][["labels"]][[1]])
df_piramide$mun <- recode_mun(df_piramide, 'mun')
Num_Pobl_num <- df_piramide %>% filter(mun == municipio_actual$municipio & gredad == "T" & sexo == "AMBOS SEXOS" & año == params$año) %>% subset(select = "valor") %>%  as.numeric()
Num_Pobl_Canarias <- df_piramide %>% filter(mun == "CANARIAS" & gredad == "T" & sexo == "AMBOS SEXOS" & año == params$año) %>% subset(select = "valor") %>%  as.numeric()

df_piramide_plot <- df_piramide %>% filter(gredad %notin% c("T","0 a 14","65 ó más","15 a 64") & sexo != "AMBOS SEXOS" & año == params$año) %>%
  subset(select = c("gredad", "sexo", "valor", "mun")) %>%
  transform(valor = if_else(sexo == "Hombres", -valor, valor), gredad = ifelse(grepl("ó", gredad, fixed = TRUE), gsub(" ó ", "-", gredad), gsub(" a ", "-", gredad))) %>%
  transform(order = as.numeric(unlist(lapply(strsplit(gredad, "-"), '[[', 1)))) %>% 
  transform(gredad = ifelse(gredad == "100-más",">99",gredad)) %>%
  arrange(desc(order))

df_Canarias <- df_piramide_plot %>% filter(mun == "CANARIAS")
df_mun <- df_piramide_plot %>% filter(mun == municipio_actual$municipio)
df_mun <- cbind(df_mun, porcentaje = df_mun$valor / Num_Pobl_num, valor_Canarias = df_Canarias$valor, porcentaje_Canarias = df_Canarias$valor / Num_Pobl_Canarias)

df_mun <- df_mun %>% transform(
  hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", gredad," años</b><br>"), ""),
    "<br><b>", sexo, "</b>",
    "<br>", format(abs(valor), big.mark = ".", decimal.mark = ","),
    " (", format(round(abs(porcentaje)*100, 1), big.mark = ".", decimal.mark = ","), "%)",
    "<br>Canarias: ", format(abs(valor_Canarias), big.mark = ".", decimal.mark = ","),
    " (", format(round(abs(porcentaje_Canarias)*100, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

g_piramide <- ggplot(data = df_mun, aes(x = reorder(gredad,order), fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.99, aes(y = porcentaje)) + 
  geom_bar(stat = "identity", color = "#59656E", alpha = 0, width = 0.99, size = 0.4, aes(y = porcentaje_Canarias, text = "")) +
  coord_flip() + 
  theme_minimal() +
  labs(x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(n.breaks = 7, labels = function(x) { paste0(format(abs(x) * 100, big.mark = '.', decimal.mark = ","), '%') },
                     limits = c(-1, 1)*max(abs(df_mun$porcentaje), abs(df_mun$porcentaje_Canarias)))
  
g_piramide <- ggplotly(g_piramide, tooltip = c("text")) %>%
              layout(margin = list(t=10), hovermode = "y unified") %>%
              config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
              style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Rankings}
df_Pobl <- data.frame(id = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                               each=data_u[["dimension"]][["TIME"]][["representation"]][["size"]]), 
                      año = names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]),
                      poblacion = as.numeric(data_u[["observation"]])) %>% 
  filter(substring(id, 0,2) != "ES") %>% 
  filter(año == params$año) %>%
  filter(!is.na(poblacion)) %>%
  left_join(df_CL_AREA_mun, by="id") %>% 
  arrange(desc(poblacion))

rk_canarias <- grep(params$id_municipio, df_Pobl$id)
num_mun_canarias <- nrow(df_Pobl)
percent_canarias <- format(round(df_Pobl[which(df_Pobl$id==params$id_municipio),]$poblacion / Num_Pobl_Canarias * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_Pobl_isla <- df_Pobl %>% filter(isla == municipio_actual$isla)
rk_isla <- grep(params$id_municipio, df_Pobl_isla$id)
num_mun_isla <- nrow(df_Pobl_isla)
percent_isla <- format(round(df_Pobl_isla[which(df_Pobl_isla$id==params$id_municipio),]$poblacion / Num_Pobl_Isla * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_Pobl_comarca <- df_Pobl %>% filter(comarca == municipio_actual$comarca)
rk_comarca <- grep(params$id_municipio, df_Pobl_comarca$id)
num_mun_comarca <- nrow(df_Pobl_comarca)
percent_comarca <- format(round(df_Pobl_comarca[which(df_Pobl_comarca$id==params$id_municipio),]$poblacion / sum(df_Pobl_comarca$poblacion) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Número de mujeres y hombres}
Num_Mujeres <- df_piramide %>% filter(mun == municipio_actual$municipio & gredad == "T" & sexo == "Mujeres" & año == params$año) %>% subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",")
Percent_Mujeres <- round(df_piramide %>% filter(mun == municipio_actual$municipio & gredad == "T" & sexo == "Mujeres" & año == params$año) %>% subset(select = "valor") / Num_Pobl_num *100, 1) %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Num_Hombres <- df_piramide %>% filter(mun == municipio_actual$municipio & gredad == "T" & sexo == "Hombres" & año == params$año) %>% subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",")
Percent_Hombres <- round(df_piramide %>% filter(mun == municipio_actual$municipio & gredad == "T" & sexo == "Hombres" & año == params$año) %>% subset(select = "valor") / Num_Pobl_num *100, 1) %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Edad media}
data_edadm <- fromJSON(params$url.edad_media)
df_edadm <- data.frame(
  Municipio = rep(names(data_edadm[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
      each=data_edadm[["dimension"]][["TIME"]][["representation"]][["size"]]),
  Año = names(data_edadm[["dimension"]][["TIME"]][["representation"]][["index"]]),
  Valor = as.numeric(data_edadm[["observation"]]))

edad_media <- df_edadm %>% filter(Municipio == params$id_municipio & Año == params$año) %>% subset(select = Valor) %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Índice de dependencia}
id_depen <- fromJSON(params$url.dependencia)

df_id_depen <- cbind(data.frame(do.call('rbind', id_depen[["data"]][["dimCodes"]])),id_depen[["data"]][["Valor"]])
colnames(df_id_depen) <- c('mun', 'año', 'valor')
# recodes
df_id_depen$mun <- factor(df_id_depen$mun , levels=id_depen[["categories"]][["codes"]][[1]], labels=id_depen[["categories"]][["labels"]][[1]])
df_id_depen$año <- as.numeric(df_id_depen$año)
df_id_depen$valor <- as.numeric(df_id_depen$valor)
levels(df_id_depen$mun) <- trimws(levels(df_id_depen$mun))
df_id_depen$mun <- recode_mun(df_id_depen, 'mun')

id_dep <- round(df_id_depen %>% filter(mun == municipio_actual$municipio & año == params$año) %>% subset(select = valor), 1) %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Defunciones}
data_defunciones <- fromJSON(params$url.defunciones)

df_defunciones <- cbind(data.frame(do.call('rbind', data_defunciones[["data"]][["dimCodes"]])), data_defunciones[["data"]][["Valor"]])
colnames(df_defunciones) <- c('año', 'mun', 'sexo', 'ind', 'valor')
df_defunciones$año <- as.numeric(df_defunciones$año)
df_defunciones$mun <- factor(df_defunciones$mun, levels=data_defunciones[["categories"]][["codes"]][[2]],
                             labels=data_defunciones[["categories"]][["labels"]][[2]])
df_defunciones$sexo <- factor(df_defunciones$sexo, levels=data_defunciones[["categories"]][["codes"]][[3]],
                              labels=data_defunciones[["categories"]][["labels"]][[3]])
df_defunciones$ind <- factor(df_defunciones$ind, levels=data_defunciones[["categories"]][["codes"]][[4]],
                             labels=data_defunciones[["categories"]][["labels"]][[4]])
df_defunciones$valor <- as.numeric(df_defunciones$valor)
df_defunciones$mun <- recode_mun(df_defunciones, 'mun')

tasa_año <- function(df){
  df <- df %>% filter(año <= params$año)
  if(max(df$año) == params$año){
    df_mun <- df %>% filter(año == params$año & mun == municipio_actual$municipio)
    }else{
      df_mun <- df %>% filter(año == params$año-1 & mun == municipio_actual$municipio)
    }
}

df_defunciones_mun <- tasa_año(df_defunciones)

# Tasas por mil habitantes con un decimal:
TBM <- df_defunciones_mun %>% filter(sexo =="AMBOS SEXOS" & ind == "Tasas brutas de mortalidad") %>% subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
emd_mujer <- df_defunciones_mun %>% filter(sexo =="Mujeres" & ind == "Edades medias de la defunción") %>% subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
emd_hombre <- df_defunciones_mun %>% filter(sexo =="Hombres" & ind == "Edades medias de la defunción") %>% subset(select = "valor") %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Natalidad}
## Tasa Bruta de Natalidad
data_nacimientos <- fromJSON(params$url.nacimientos)
df_nacimientos <- data.frame(
  id = rep(names(data_nacimientos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
            each=data_nacimientos[["dimension"]][["TIME"]][["representation"]][["size"]]),
  año = names(data_nacimientos[["dimension"]][["TIME"]][["representation"]][["index"]]),
  valor = as.numeric(data_nacimientos[["observation"]]))
df_nacimientos <- df_nacimientos %>% left_join(df_CL_AREA_mun, by = "id") %>% select(mun = municipio, año, valor)
df_nacimientos_mun <- tasa_año(df_nacimientos)

# Tasa por mil habitantes con dos decimales:
TBN <- format(round(df_nacimientos_mun$valor / Num_Pobl_num * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Crecimiento vegetativo}
# Crecimiento vegetativo. Municipios por islas de Canarias y años. De 1999 al 2019
data_crec_veg <- fromJSON(params$url.crec_veg)
df_crec_veg <- cbind(data.frame(do.call('rbind', data_crec_veg[["data"]][["dimCodes"]])), data_crec_veg[["data"]][["Valor"]])
colnames(df_crec_veg) <- c('mun', 'año', 'valor')
df_crec_veg$mun <- factor(df_crec_veg$mun, levels=data_crec_veg[["categories"]][["codes"]][[1]],
                                labels=data_crec_veg[["categories"]][["labels"]][[1]])
df_crec_veg$año <- as.numeric(df_crec_veg$año)
df_crec_veg$valor <- as.numeric(df_crec_veg$valor)
df_crec_veg$mun <- recode_mun(df_crec_veg, 'mun')
df_crec_veg_mun <- tasa_año(df_crec_veg)

Crec_veg <- df_crec_veg_mun$valor %>% as.numeric %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Lugares de nacimiento}
data_lugar <- fromJSON(params$url.lugar)
df_lugar <- cbind(data.frame(do.call('rbind', data_lugar[["data"]][["dimCodes"]])), data_lugar[["data"]][["Valor"]])
colnames(df_lugar) <- c('mun', 'lugar', 'año', 'sexo', 'valor')
df_lugar$mun <- factor(df_lugar$mun, levels=data_lugar[["categories"]][["codes"]][[1]], labels=data_lugar[["categories"]][["labels"]][[1]])
df_lugar$lugar <- factor(df_lugar$lugar, levels=data_lugar[["categories"]][["codes"]][[2]], labels=data_lugar[["categories"]][["labels"]][[2]])
df_lugar$año <- as.numeric(df_lugar$año)
df_lugar$sexo <- factor(df_lugar$sexo, levels=data_lugar[["categories"]][["codes"]][[4]], labels=data_lugar[["categories"]][["labels"]][[4]])
df_lugar$valor <- as.numeric(df_lugar$valor)
df_lugar$mun <- recode_mun(df_lugar, 'mun')

# Personas que viven en el municipios pero han nacido en otro país, el resto de España o Canarias:
Num_lugar_Canarias <- df_lugar %>% filter(mun == municipio_actual$municipio & lugar == "CANARIAS" & año == params$año & sexo =="AMBOS SEXOS") %>% subset(select = "valor") %>% as.numeric
Num_lugar_RestoEspaña <- df_lugar %>% filter(mun == municipio_actual$municipio & lugar == "RESTO DE ESPAÑA" & año == params$año & sexo =="AMBOS SEXOS") %>% subset(select = "valor") %>% as.numeric
Num_lugar_OtroPais <- df_lugar %>% filter(mun == municipio_actual$municipio & lugar == "OTRO PAÍS" & año == params$año & sexo =="AMBOS SEXOS") %>% subset(select = "valor") %>% as.numeric

porc_lugar_Canarias <- 100 * Num_lugar_Canarias/Num_Pobl_num
porc_lugar_RestoEspaña <- 100 * Num_lugar_RestoEspaña/Num_Pobl_num
porc_lugar_OtroPais <- 100 * Num_lugar_OtroPais/Num_Pobl_num
porc_lugar_Canarias_l <- round(porc_lugar_Canarias, 1) %>% as.numeric
porc_lugar_RestoEspaña_l <- round(porc_lugar_RestoEspaña, 1) %>% as.numeric
porc_lugar_OtroPais_l <- round(100 - porc_lugar_Canarias_l - porc_lugar_RestoEspaña_l, 1) %>% as.numeric
```

```{r Población según sexos y nacionalidades}
data_nacionalidad <- fromJSON(params$url.nacionalidad)

df_nacionalidad <- cbind(data.frame(do.call('rbind', data_nacionalidad[["data"]][["dimCodes"]])), data_nacionalidad[["data"]][["Valor"]])
colnames(df_nacionalidad) <- c('mun', 'nacionalidad', 'año', 'sexo', 'valor')
df_nacionalidad$mun <- factor(df_nacionalidad$mun, levels=data_nacionalidad[["categories"]][["codes"]][[1]], labels=data_nacionalidad[["categories"]][["labels"]][[1]])
df_nacionalidad$nacionalidad <- factor(df_nacionalidad$nacionalidad, levels=data_nacionalidad[["categories"]][["codes"]][[2]], labels=data_nacionalidad[["categories"]][["labels"]][[2]])
df_nacionalidad$año <- as.numeric(df_nacionalidad$año)
df_nacionalidad$sexo <- factor(df_nacionalidad$sexo, levels=data_nacionalidad[["categories"]][["codes"]][[4]], labels=data_nacionalidad[["categories"]][["labels"]][[4]])
df_nacionalidad$valor <- as.numeric(df_nacionalidad$valor)
df_nacionalidad$mun <- recode_mun(df_nacionalidad, 'mun')
## Porcentaje de población según nacionalidad. 2020.
df_nacionalidad_mun <- df_nacionalidad %>% filter(mun == municipio_actual$municipio &
                       nacionalidad %in% c("TOTAL", "ESPAÑA", "EXTRANJERO") & año == params$año & sexo == "AMBOS SEXOS") %>% 
  select(c(nacionalidad, valor))
df_nacionalidad_mun <- cbind(df_nacionalidad_mun, porcentaje = round(df_nacionalidad_mun$valor / df_nacionalidad_mun$valor[1] * 100, 2))

peso_españoles <- df_nacionalidad_mun %>% filter(nacionalidad == "ESPAÑA") %>% select(porcentaje) %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>%  as.character()
peso_extranjeros <- df_nacionalidad_mun %>% filter(nacionalidad == "EXTRANJERO") %>% select(porcentaje) %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
```

```{r Barras nacionalidades, echo=FALSE, message=FALSE, warning=FALSE}
ranking_nacionalidad_mun <- df_nacionalidad %>% filter(mun == municipio_actual$municipio &
                            nacionalidad %notin% c("TOTAL", "ESPAÑA", "EXTRANJERO", " RESTO DE UE-28", "  Ampliación de 2004", "  Otros países de la Unión Europea",
                                                   " RESTO EUROPA", "  Otros países de Europa", " ÁFRICA", "  Otros de África", " AMÉRICA",
                                                   "  Otros países de América", " ASIA", "  Otros países de Asia", " OCEANÍA")
                            & año == params$año & sexo == "AMBOS SEXOS") %>%
  select(c(nacionalidad, valor)) %>%
  top_n(10, valor) %>%
  arrange(-valor)

if(length(ranking_nacionalidad_mun$nacionalidad) > 10){
  ranking_nacionalidad_mun <- ranking_nacionalidad_mun %>% filter(valor != min(ranking_nacionalidad_mun$valor))
}

Num_total_extr <- df_nacionalidad %>% 
  filter(mun == municipio_actual$municipio & nacionalidad == "EXTRANJERO" & año == params$año & sexo == "AMBOS SEXOS") %>% select(valor) %>% as.numeric()
df_nacionalidad_mun_sexo <- df_nacionalidad %>%
  filter(mun == municipio_actual$municipio & nacionalidad %in% ranking_nacionalidad_mun$nacionalidad & año == params$año & sexo !="AMBOS SEXOS") %>% 
  arrange(valor)
df_nacionalidad_mun_sexo <- cbind(df_nacionalidad_mun_sexo, porcentaje = df_nacionalidad_mun_sexo$valor / Num_total_extr)
ranking_nacionalidad_mun_o <- ranking_nacionalidad_mun %>% arrange(valor)
df_nacionalidad_mun_sexo$nacionalidad <- ordered(df_nacionalidad_mun_sexo$nacionalidad, levels = ranking_nacionalidad_mun_o$nacionalidad)
df_nacionalidad_mun_sexo <- df_nacionalidad_mun_sexo %>% transform(hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", trimws(nacionalidad), "</b><br><br>"), ""),
    "<b>", sexo, "</b>",
    "<br>",trimws(format(abs(valor), big.mark = ".", decimal.mark = ",")), " habitantes", 
    "<br>(", trimws(format(round(abs(porcentaje)*100, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

g_nacionalidad_mun_sexo <- ggplot(df_nacionalidad_mun_sexo, aes(x = valor, y = nacionalidad, fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, position = position_stack(reverse = TRUE)) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(x = NULL, y = NULL, colour = " ") +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(n.breaks = 5, labels = function(x){format(x, big.mark='.', decimal.mark = ",")})

g_nacionalidad_mun_sexo <- ggplotly(g_nacionalidad_mun_sexo, tooltip = c("text")) %>%
  layout(hoverlabel = "", margin = list(t=10), hovermode = 'y unified') %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))
```

```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator3 = function(label, value, image) {
  return(sprintf("<div class='indicator3'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r params$año`</h3>
<h2 style="color: #666; margin: 0;">Indicadores demográficos</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Pobl` habitantes</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$Municipio[i], leyenda_poblacion$Valor[i], leyenda_poblacion$Tasa[i]))
}
```
</div>
</div>

<div class="row">
```{r, results='asis'}
if(Variacion_Porcentual_Pobl == "NA"){
  cat(paste0(
    "<div class='column-3'>", get_indicator2('Edad</br>media', edad_media, './img/family.png'), "</div><div class='column-3'>", get_indicator2(paste0('Mujeres</p><p class="label" style="color: #999;">', Num_Mujeres), paste0(Percent_Mujeres, '%'), './img/female.png'), "</div><div class='column-3'>", get_indicator2(paste0('Hombres</p><p class="label" style="color: #999;">', Num_Hombres), paste0(Percent_Hombres, '%'), './img/male.png'), "</div>"))
}else{
  cat(paste0(
    "<div class='column-4'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual_Pobl, '%'), Imagen_Variacion), "</div><div class='column-4'>", get_indicator2('Edad</br>media', edad_media, './img/family.png'), "</div><div class='column-4'>", get_indicator2(paste0('Mujeres</p><p class="label" style="color: #999;">', Num_Mujeres), paste0(Percent_Mujeres, '%'), './img/female.png'), "</div><div class='column-4'>", get_indicator2(paste0('Hombres</p><p class="label" style="color: #999;">', Num_Hombres), paste0(Percent_Hombres, '%'), './img/male.png'), "</div>"))
}
```
</div>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map">
  <div class="image map-canarias">
```{r}
mapa_Canarias_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_isla_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_comarca_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_comarca`º </span>en la comarca</p>
  <p class="label2">de `r num_mun_comarca` municipios (`r percent_comarca`%)</p>
  </div>
</div>
</div>
</div>

<div class="row">
<div class="column indicator-title">
  <h3>Pirámide poblacional</h3>
</div>
<div class="column indicator-title">
  <h3>Nacionalidades</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
<div class="piramide">
  `r g_piramide`
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3'></div><div class='sp-content'>Mujeres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-4'></div><div class='sp-content'>Canarias</div></div>
</div>

```{r, results='asis'}
if(max(df_nacimientos_mun$año) == params$año-1){
  cat(paste0("<div class='column-3'>", get_indicator3('Tasa de</br>natalidad *</br>', paste0(TBN, '‰'),'./img/natalidad.png'), "</div>"))
}else{
  cat(paste0("<div class='column-3'>", get_indicator3('Tasa de</br>natalidad</br>', paste0(TBN, '‰'),'./img/natalidad.png'), "</div>"))
}
if(max(df_defunciones_mun$año) == params$año-1){
  cat(paste0("<div class='column-3'>", get_indicator3('Tasa de</br>mortalidad *</br>', paste0(TBM, '‰'),'./img/muerte.png'), "</div>"))
}else{
  cat(paste0("<div class='column-3'>", get_indicator3('Tasa de</br>mortalidad</br>', paste0(TBM, '‰'),'./img/muerte.png'), "</div>"))
}
if(max(df_crec_veg_mun$año) == params$año-1){
  cat(paste0("<div class='column-3'>", get_indicator3('Crecimiento</br>vegetativo *', Crec_veg,'./img/balanza.png'), "</div>"))
}else{
  cat(paste0("<div class='column-3'>", get_indicator3('Crecimiento</br>vegetativo', Crec_veg,'./img/balanza.png'), "</div>"))
}
```

<div class="column-3">`r get_indicator3("Índice de</br>dependencia", paste0(id_dep, "%"),"./img/dependencia.png")`</div>
```{r, results='asis'}
if(max(df_defunciones_mun$año) == params$año-1){
  cat(paste0("<div class='column-3'>", get_indicator3('Edad media</br>defunción *', emd_mujer,'./img/female-black.png'), "</div><div class='column-3'>", get_indicator3('Edad media</br>defunción *', emd_hombre,'./img/male-black.png'), "</div>"))
}else{
  cat(paste0("<div class='column-3'>", get_indicator3('Edad media</br>defunción', emd_mujer,'./img/female-black.png'), "</div><div class='column-3'>", get_indicator3('Edad media</br>defunción', emd_hombre,'./img/male-black.png'), "</div>"))
}
```
</div>

<div class="column" style="padding: 0px 5px;">
<div class="highlight" style="width: 100% !important; padding-top: 12px;">

<div class="piramide" style="height: 300px">
  `r g_nacionalidad_mun_sexo`
</div>
<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3'></div><div class='sp-content'>Mujeres</div></div>
</div>
<div class="row" style="margin-top: 10px">
  <div class="column-2">`r get_indicator3("España", paste0(peso_españoles, "%"),"./img/spain2.png")`</div> 
  <div class="column-2">`r get_indicator3("Extranjero", paste0(peso_extranjeros, "%"),"./img/world.png")`</div>
</div>
</div>
<div class="indicator-title" style="width: 100% !important; margin-top: 15px; padding: 5px;">
  <h3>Lugares de nacimiento</h3>
</div>

<div class="highlight" style="width: 100% !important; margin-top: 10px; padding-top: 10px;">
<div class="progress-bar-container">
  <div class="progress-bar-1" style="width:`r porc_lugar_Canarias`%"></div>
  <div class="progress-bar-2" style="width:`r porc_lugar_RestoEspaña`%"></div>
  <div class="progress-bar-3" style="width:`r porc_lugar_OtroPais`%"></div>
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-1'></div><div class='sp-content'>Canarias<br/>`r format(porc_lugar_Canarias_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
  <div class='progressbar-legend'><div class='progress-bar-2'></div><div class='sp-content'>Resto de España<br/>`r format(porc_lugar_RestoEspaña_l, big.mark = ".", decimal.mark = ",", nsmall = 1) `%</div></div>
  <div class='progressbar-legend'><div class='progress-bar-3'></div><div class='sp-content'>Extranjero<br/>`r format(porc_lugar_OtroPais_l, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
</div>
</div>
</div>
</div>

<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

