---
title: ''
params:
  id_municipio: 35006
  año: 2020
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.mapa_2007: https://datos.canarias.es/catalogos/estadisticas/dataset/03f5044c-6d40-4c09-84db-eaf9d6681b48/resource/d765c56b-a67d-46e2-800e-5c9a1e9138f0/download/municipios_20170101_antes2007.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.cultivada: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/2b88193e-29c3-44ae-91dd-c17bbe90124a/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D
  url.cultivada_secano: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/e59bfde6-0aab-473f-a771-0063f9b3133d/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cultivada_regadio: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/40e615bb-a0fb-4575-931b-c8ca0ef99b59/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.superficie: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7/data?representation=MEASURE%5BABSOLUTE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.agr_herbaceos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=9bd9de0e-1785-4e6c-b0e5-b139106445b9
  url.agr_leñosos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=bba81127-8204-4fbb-8b37-4872748439df
  url.exp_especies: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E01008B_000002/~latest.json?dim=TERRITORIO:ES70|35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.cab_especies: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E01008B_000001/~latest.json?dim=TERRITORIO:ES70|35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  
  url.cultivada_herbaceos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/682d0933-f921-46f6-94bc-fbb7d2569247/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cultivada_leñosos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/bd997d29-4bb6-402f-9086-17eee6022d73/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cabezas_bovino: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/0f6d7612-91b6-49d4-aa38-a6624243712d/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cabezas_ovino: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/ea920cf7-48fc-4f12-8071-75a1f336133a/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cabezas_caprino: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/005c5a4d-44a3-4fb3-802d-8b4ec348ccb8/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.cabezas_porcino: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/fb761796-5971-4ed8-8550-3c7cea6ad3a5/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)

signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
palette <- c('#8CD2EA', '#005980')

url_mapa <- ifelse(params$año < 2007, params$url.mapa_2007, params$url.mapa)
mapa_Canarias <- st_read(url_mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != municipio_actual$id), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == municipio_actual$id), col = "1")
) %>% 
  select(-c(notas, utm_x_capi, utm_y_capi, long_capi, lati_capi)) %>%
  st_sf

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)

mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla) %>% select(geocode, col)

mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)

mapa_comarca <- filter(mapa_Canarias, mapa_Canarias$geocode %in% (df_CL_AREA_mun[df_CL_AREA_mun$id_comarca == municipio_actual$id_comarca,]$id)) %>% select(geocode, col)

mapa_comarca_plot <- tm_shape(mapa_comarca) + 
                     tm_borders() + 
                     tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                     tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                     tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución de la población turística}
data_u <- fromJSON(params$url.cultivada)
df_u_ <- data.frame(
  municipio = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_u[["dimension"]][["TIME"]][["representation"]][["size"]] * data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  año = rep(names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = round(as.numeric(data_u[["observation"]]), 1)) %>%
  arrange(año) %>%
  spread(medida, valor) %>%
  select(municipio, año, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)
df_u <- df_u_ %>% filter(substring(municipio, 0,2) != "ES")
df_u$año <- as.integer(df_u$año)

related_mun <- df_u %>% filter(año == params$año)
related_mun <- seleccion_mun(related_mun %>% select(mun = municipio, valor), 'valor')

df <- related_mun %>%
  select(municipio = "mun") %>%
  left_join(df_u, by= "municipio") %>%
  select(id = municipio, año, valor, tasa) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(año, municipio, valor, tasa) %>%
  filter(año <= params$año & año != min(año))

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Habitantes: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

df <- df %>% mutate(
    tooltip = ifelse(año == params$año,
                     sprintf(leyenda.content, municipio, ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, municipio, paste0(ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")), ' (',año,')'),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
    )
) 

g_line <- ggplot(data = df, 
                 aes(x = año, y = valor, group = municipio, colour = municipio, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_continuous(breaks = function(x){seq(from = max(max(df$año) - 8, min(df$año)), to = max(df$año), by = as.integer((max(df$año)-max(max(df$año) - 18, min(df$año)))/4))}) +
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(max(df$año) - 8, min(df$año)), max(df$año)),
                      rangeslider = list(type = "date", thickness = 0.04))) %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) { highlight(d); });
      el.on('plotly_unhover', function(d) { reset(d); });
      el.on('plotly_click', function(d) { highlight(d); });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 

leyenda_poblacion <- df %>% filter(año == params$año) %>%
  mutate(valor = ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))) %>%
  left_join(data.frame(cbind(municipio = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "municipio")
```

```{r Indicador evolución de la población}
df_lv <- df_u %>% filter(año == params$año & municipio == params$id_municipio)

superficie_cultivada_num <- df_lv$valor
superficie_cultivada <- superficie_cultivada_num %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Imagen_Variacion <- ifelse(signo(df_lv$tasa) == "más", './img/up.png', './img/down.png')
Variacion_Porcentual <- df_lv$tasa %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Indicador Secano}
data_secano <- fromJSON(params$url.cultivada_secano)

df_secano <- data.frame(mun = rep(names(data_secano[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                                  each=data_secano[["dimension"]][["TIME"]][["representation"]][["size"]] * data_secano[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
                        año = rep(names(data_secano[["dimension"]][["TIME"]][["representation"]][["index"]]),
                                  each=data_secano[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
                        medida = names(data_secano[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
                        valor = round(as.numeric(data_secano[["observation"]]), 1)) %>% 
  spread(medida, valor) %>%
  select(mun, año, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)

sup_secano_num <- df_secano %>% filter(año == params$año & mun == params$id_municipio) %>% select(valor) %>% as.numeric()
sup_secano <- sup_secano_num %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
percent_secano <- round(sup_secano_num / superficie_cultivada_num * 100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Indicador Regadío}
data_regadio <- fromJSON(params$url.cultivada_regadio)

df_regadio <- data.frame(mun = rep(names(data_regadio[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                                   each=data_regadio[["dimension"]][["TIME"]][["representation"]][["size"]] * data_regadio[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
                         año = rep(names(data_regadio[["dimension"]][["TIME"]][["representation"]][["index"]]),
                                   each=data_regadio[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
                         medida = names(data_regadio[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
                         valor = round(as.numeric(data_regadio[["observation"]]), 1)) %>% 
  spread(medida, valor) %>%
  select(mun, año, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)

sup_regadio_num <- df_regadio %>% filter(año == params$año & mun == params$id_municipio) %>% select(valor) %>% as.numeric()
sup_regadio <- sup_regadio_num %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
percent_regadio <- round(sup_regadio_num / superficie_cultivada_num * 100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Indicador Proporción superficie cultivada sobre superficie total}
data_superficie <- fromJSON(params$url.superficie)

df_superficie <- data.frame(mun = rep(names(data_superficie[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                                      each=length(data_superficie[["dimension"]][["TIME"]][["representation"]][["index"]])),
                            año = names(data_superficie[["dimension"]][["TIME"]][["representation"]][["index"]]),
                            valor = as.numeric(data_superficie[["observation"]]))

superficie_num <- df_superficie %>% filter(año == params$año & mun == params$id_municipio) %>% select(valor) %>% as.numeric()
percent_sup_cultivada <- round(superficie_cultivada_num / superficie_num * 100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Rankings}
sup_Canarias_total <- df_u_ %>% filter(municipio == "ES70" & año == params$año) %>% select(valor) %>% as.numeric()
sup_Isla_total <- df_u_ %>% filter(municipio == municipio_actual$id_isla & año == params$año) %>% select(valor) %>% as.numeric()

df_ranking <- df_u %>%
  select(id = municipio, año, valor) %>%
  filter(año == params$año) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

df_ranking_mun <- df_ranking[which(df_ranking$id==params$id_municipio),]
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_ranking_mun$valor / sup_Canarias_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_ranking_isla <- df_ranking %>% filter(isla == df_ranking_mun$isla)
rk_isla <- grep(params$id_municipio, df_ranking_isla$id)
num_mun_isla <- nrow(df_ranking_isla)
percent_isla <- format(round(df_ranking_mun$valor / sup_Isla_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

df_ranking_comarca <- df_ranking %>% filter(comarca == municipio_actual$comarca)
rk_comarca <- grep(params$id_municipio, df_ranking_comarca$id)
num_mun_comarca <- nrow(df_ranking_comarca)
percent_comarca <- format(round(df_ranking_comarca[which(df_ranking_comarca$id==params$id_municipio),]$rankingacion / sum(df_ranking_comarca$valor) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Barras herbáceos}
data_herbaceos <- fromJSON(params$url.agr_herbaceos)
df_herbaceos <- cbind(data.frame(do.call('rbind', data_herbaceos[["data"]][["dimCodes"]])), data_herbaceos[["data"]][["Valor"]])
colnames(df_herbaceos) <- c('mun', 'cultivo', 'año', 'sistema', 'valor')
df_herbaceos$mun <- factor(df_herbaceos$mun, levels=data_herbaceos[["categories"]][["codes"]][[1]], labels=data_herbaceos[["categories"]][["labels"]][[1]])
df_herbaceos$cultivo <- factor(df_herbaceos$cultivo, levels=data_herbaceos[["categories"]][["codes"]][[2]], labels=data_herbaceos[["categories"]][["labels"]][[2]])
df_herbaceos$año <- as.numeric(df_herbaceos$año)
df_herbaceos$sistema <- factor(df_herbaceos$sistema, levels=data_herbaceos[["categories"]][["codes"]][[4]], labels=data_herbaceos[["categories"]][["labels"]][[4]])
df_herbaceos$valor <- as.numeric(df_herbaceos$valor)
df_herbaceos$mun <- recode_mun(df_herbaceos, 'mun')

sup_herbaceos <- df_herbaceos %>%
  filter(mun == municipio_actual$municipio & año == params$año & cultivo == "TOTAL CULTIVOS HERBÁCEOS" & sistema == "TOTAL (SECANO+REGADÍO)") %>% select(valor) %>% as.numeric()
sup_herbaceos_C <- df_herbaceos %>%
  filter(mun == "CANARIAS" & año == params$año & cultivo == "TOTAL CULTIVOS HERBÁCEOS" & sistema == "TOTAL (SECANO+REGADÍO)") %>% select(valor) %>% as.numeric()
df_herbaceos <- df_herbaceos %>% filter(substring(cultivo, 0,1) == " " & substring(cultivo, 0,4) != " Otr" & sistema == "TOTAL (SECANO+REGADÍO)" & año == params$año)
df_herbaceos <- df_herbaceos %>% mutate(cultivo = recode(cultivo, " Maíz grano" = "Maíz<br>grano"),
                                        cultivo = recode(cultivo, " Alforfón o trigo sarraceno" = "Alforfón o<br>trigo sarraceno"),
                                        cultivo = recode(cultivo, " Judías grano" = "Judías<br>grano"),
                                        cultivo = recode(cultivo, " Habas grano" = "Habas<br>grano"),
                                        cultivo = recode(cultivo, " Veza para grano" = "Veza para<br>grano"),
                                        cultivo = recode(cultivo, " Papa extratemprana" = "Papa<br>extratemprana"),
                                        cultivo = recode(cultivo, " Papa temprana" = "Papa<br>temprana"),
                                        cultivo = recode(cultivo, " Papa media estación" = "Papa media<br>estación"),
                                        cultivo = recode(cultivo, " Papa tardía" = "Papa<br>tardía"),
                                        cultivo = recode(cultivo, " Batata y boniato" = "Batata y<br>boniato"),
                                        cultivo = recode(cultivo, " Caña de azúcar" = "Caña de<br>azúcar"),
                                        cultivo = recode(cultivo, " Azafrán de la tierra" = "Azafrán de<br>la tierra"),
                                        cultivo = recode(cultivo, " Plantas ornamentales" = "Plantas<br>ornamentales"),
                                        cultivo = recode(cultivo, " Cereales de Invierno" = "Cereales de<br>Invierno"),
                                        cultivo = recode(cultivo, " Maíz forrajero" = "Maíz<br>forrajero"),
                                        cultivo = recode(cultivo, " Sorgo forrajero" = "Sorgo<br>forrajero"),
                                        cultivo = recode(cultivo, " Veza para forraje" = "Veza para<br>forraje"),
                                        cultivo = recode(cultivo, " Remolacha forrajera" = "Remolacha<br>forrajera"),
                                        cultivo = recode(cultivo, " Col forrajera" = "Col<br>forrajera"),
                                        cultivo = recode(cultivo, " Cardo y otros forrajes varios" = "Cardo y otros<br>forrajes varios"),
                                        cultivo = recode(cultivo, " Guindilla y pimiento para mojo" = "Guindilla y pimiento<br>para mojo"),
                                        cultivo = recode(cultivo, " Fresa y fresón" = "Fresa y<br>fresón"),
                                        cultivo = recode(cultivo, " Remolacha de mesa" = "Remolacha<br>de mesa"),
                                        cultivo = recode(cultivo, " Habichuelas (Judía verde)" = "Habichuelas<br>(Judía verde)"),
                                        cultivo = recode(cultivo, " Guisante verde" = "Guisante<br>verde"),
                                        cultivo = recode(cultivo, " Haba verde" = "Haba<br>verde")
                                        )

rk_herbaceos_mun <- df_herbaceos %>%
  filter(mun == municipio_actual$municipio) %>%
  top_n(8, valor) %>% 
  arrange(valor) %>%
  select(c(cultivo, valor))

if(length(rk_herbaceos_mun$cultivo) > 10){
  rk_herbaceos_mun <- rk_herbaceos_mun %>% filter(valor != min(rk_herbaceos_mun$valor))
}
rk_herbaceos_mun$cultivo <- ordered(rk_herbaceos_mun$cultivo, levels = rk_herbaceos_mun$cultivo)

df_herbaceos_mun <- df_herbaceos %>%
  filter(mun == municipio_actual$municipio & cultivo %in% rk_herbaceos_mun$cultivo) %>%
  select(c(cultivo, valor))
df_herbaceos_C <- df_herbaceos %>%
  filter(mun == "CANARIAS" & cultivo %in% rk_herbaceos_mun$cultivo) %>%
  select(c(cultivo, valor))
df_herbaceos_mun <- df_herbaceos_mun %>%
  mutate(porcentaje = df_herbaceos_mun$valor / sup_herbaceos * 100,
         valor_Canarias = df_herbaceos_C$valor,
         porcentaje_Canarias = df_herbaceos_C$valor / sup_herbaceos_C * 100)

df_herbaceos_plot <- df_herbaceos_mun %>%
  top_n(8, valor) %>% 
  mutate(label = "|")
df_herbaceos_plot$cultivo <- ordered(df_herbaceos_plot$cultivo, levels = rk_herbaceos_mun$cultivo)

df_herbaceos_plot <- df_herbaceos_plot %>% transform(hovertext = paste0(
  "<b>", trimws(cultivo), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

df_herbaceos_0 <- df_herbaceos_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_herbaceos_plot <- rbind(df_herbaceos_plot, df_herbaceos_0)

df_herbaceos_plot <- df_herbaceos_plot %>% filter(valor != 0)

if(nrow(df_herbaceos_plot)/2 == 12){
  col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0083C4", "#0072A2", "#005980", "#00405B")
  }else if(nrow(df_herbaceos_plot)/2 == 11){
    col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0072A2", "#005980", "#00405B")
    }else if(nrow(df_herbaceos_plot)/2 == 10){
      col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
      }else if(nrow(df_herbaceos_plot)/2 == 9){
        col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
        }else if(nrow(df_herbaceos_plot)/2 == 8){
          col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
          }else if(nrow(df_herbaceos_plot)/2 == 7){
            col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
            }else if(nrow(df_herbaceos_plot)/2 == 6){
              col <- c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
              }else if(nrow(df_herbaceos_plot)/2 == 5){
                col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#0072A2", "#005980")
                }else if(nrow(df_herbaceos_plot)/2 == 4){
                  col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#005980")
                  }else if(nrow(df_herbaceos_plot)/2 == 3){
                    col <- c("#8CD2EA", "#008BD0", "#005980")
                    }else if(nrow(df_herbaceos_plot)/2 == 2){
                      col <- c("#8CD2EA", "#005980")
                    }

g_herbaceos <- ggplot(data = df_herbaceos_plot, aes(y = cultivo, fill = cultivo, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = col) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_herbaceos <- ggplotly(g_herbaceos, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))  %>%
  style(hoverinfo = "skip", traces = c((nrow(df_herbaceos_plot)/2+1):24))
```

```{r Barras leñosos}
data_leñosos <- fromJSON(params$url.agr_leñosos)
df_leñosos <- cbind(data.frame(do.call('rbind', data_leñosos[["data"]][["dimCodes"]])), data_leñosos[["data"]][["Valor"]])
colnames(df_leñosos) <- c('mun', 'cultivo', 'año', 'sistema', 'valor')
df_leñosos$mun <- factor(df_leñosos$mun, levels=data_leñosos[["categories"]][["codes"]][[1]], labels=data_leñosos[["categories"]][["labels"]][[1]])
df_leñosos$cultivo <- factor(df_leñosos$cultivo, levels=data_leñosos[["categories"]][["codes"]][[2]], labels=data_leñosos[["categories"]][["labels"]][[2]])
df_leñosos$año <- as.numeric(df_leñosos$año)
df_leñosos$sistema <- factor(df_leñosos$sistema, levels=data_leñosos[["categories"]][["codes"]][[4]], labels=data_leñosos[["categories"]][["labels"]][[4]])
df_leñosos$valor <- as.numeric(df_leñosos$valor)
df_leñosos$mun <- recode_mun(df_leñosos, 'mun')

sup_leñosos <- df_leñosos %>%
  filter(mun == municipio_actual$municipio & año == params$año & cultivo == "TOTAL CULTIVOS LEÑOSOS" & sistema == "TOTAL EN PLANTACIÓN REGULAR (SECANO+REGADÍO)") %>% select(valor) %>% as.numeric()
sup_leñosos_C <- df_leñosos %>%
  filter(mun == "CANARIAS" & año == params$año & cultivo == "TOTAL CULTIVOS LEÑOSOS" & sistema == "TOTAL EN PLANTACIÓN REGULAR (SECANO+REGADÍO)") %>% select(valor) %>% as.numeric()
df_leñosos <- df_leñosos %>% filter(substring(cultivo, 0,1) == " " & substring(cultivo, 0,4) != " Otr" & sistema == "TOTAL EN PLANTACIÓN REGULAR (SECANO+REGADÍO)" & año == params$año)
df_leñosos <- df_leñosos %>% mutate(cultivo = recode(cultivo, " Naranjo amargo" = "Naranjo<br>amargo"),
                                    cultivo = recode(cultivo, " Limero y otros cítricos" = "Limero y<br>otros cítricos"),
                                    cultivo = recode(cultivo, " Cerezo y guindo" = "Cerezo y<br>guindo"),
                                    cultivo = recode(cultivo, " Palmera datilera" = "Palmera<br>datilera"),
                                    cultivo = recode(cultivo, " Piña tropical" = "Piña<br>tropical"),
                                    cultivo = recode(cultivo, " Uva de mesa (Principal)" = "Uva de mesa<br>(Principal)"),
                                    cultivo = recode(cultivo, " Uva de mesa (Asociada)" = "Uva de mesa<br>(Asociada)"),
                                    cultivo = recode(cultivo, " Uva para vino (Principal)" = "Uva para vino<br>(Principal)"),
                                    cultivo = recode(cultivo, " Uva para vino (Asociada)" = "Uva para vino<br>(Asociada)"),
                                    cultivo = recode(cultivo, " Olivar de aceituna de mesa" = "Olivar de<br>aceituna de mesa"),
                                    cultivo = recode(cultivo, " Olivar de aceituna de aceite" = "Olivar de<br>aceituna de aceite"),
                                    cultivo = recode(cultivo, " Agave, pita y rafia" = "Agave, pita<br>y rafia"),
                                    cultivo = recode(cultivo, " Morera y otros" = "Morera<br>y otros"),
                                    cultivo = recode(cultivo, "VIVEROS" = "Viveros"),
                                    )

rk_leñosos_mun <- df_leñosos %>%
  filter(mun == municipio_actual$municipio) %>%
  top_n(8, valor) %>% 
  arrange(valor) %>%
  select(c(cultivo, valor))

if(length(rk_leñosos_mun$cultivo) > 10){
  rk_leñosos_mun <- rk_leñosos_mun %>% filter(valor != min(rk_leñosos_mun$valor))
}
rk_leñosos_mun$cultivo <- ordered(rk_leñosos_mun$cultivo, levels = rk_leñosos_mun$cultivo)

df_leñosos_mun <- df_leñosos %>%
  filter(mun == municipio_actual$municipio & cultivo %in% rk_leñosos_mun$cultivo) %>%
  select(c(cultivo, valor))
df_leñosos_C <- df_leñosos %>%
  filter(mun == "CANARIAS" & cultivo %in% rk_leñosos_mun$cultivo) %>%
  select(c(cultivo, valor))
df_leñosos_mun <- df_leñosos_mun %>%
  mutate(porcentaje = df_leñosos_mun$valor / sup_leñosos * 100,
         valor_Canarias = df_leñosos_C$valor,
         porcentaje_Canarias = df_leñosos_C$valor / sup_leñosos_C * 100)

df_leñosos_plot <- df_leñosos_mun %>%
  mutate(label = "|")
df_leñosos_plot$cultivo <- ordered(df_leñosos_plot$cultivo, levels = rk_leñosos_mun$cultivo)

df_leñosos_plot <- df_leñosos_plot %>% transform(hovertext = paste0(
  "<b>", trimws(cultivo), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

df_leñosos_0 <- df_leñosos_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_leñosos_plot <- rbind(df_leñosos_plot, df_leñosos_0)

df_leñosos_plot <- df_leñosos_plot %>% filter(valor != 0)

if(nrow(df_leñosos_plot)/2 == 12){
  col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0083C4", "#0072A2", "#005980", "#00405B")
  }else if(nrow(df_leñosos_plot)/2 == 11){
    col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0072A2", "#005980", "#00405B")
    }else if(nrow(df_leñosos_plot)/2 == 10){
      col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
      }else if(nrow(df_leñosos_plot)/2 == 9){
        col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
        }else if(nrow(df_leñosos_plot)/2 == 8){
          col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
          }else if(nrow(df_leñosos_plot)/2 == 7){
            col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
            }else if(nrow(df_leñosos_plot)/2 == 6){
              col <- c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
              }else if(nrow(df_leñosos_plot)/2 == 5){
                col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#0072A2", "#005980")
                }else if(nrow(df_leñosos_plot)/2 == 4){
                  col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#005980")
                  }else if(nrow(df_leñosos_plot)/2 == 3){
                    col <- c("#8CD2EA", "#008BD0", "#005980")
                    }else if(nrow(df_leñosos_plot)/2 == 2){
                      col <- c("#8CD2EA", "#005980")
                    }

g_leñosos <- ggplot(data = df_leñosos_plot, aes(y = cultivo, fill = cultivo, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = col) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_leñosos <- ggplotly(g_leñosos, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))  %>%
  style(hoverinfo = "skip", traces = c((nrow(df_leñosos_plot)/2+1):24))
```

```{r Ganadería explotaciones}
data_exp_especies <- fromJSON(params$url.exp_especies)

df_exp_especies <- data.frame(
  mun = rep(data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                   length(data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  año = rep(data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
            times = length(data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_especie = data_exp_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
  valor = unlist(strsplit(data_exp_especies[["data"]][["observations"]], split = " | ", fixed = TRUE)))
df_exp_especies$valor <- as.numeric(df_exp_especies$valor)

df_especies <- data.frame(
  id_especie = data_exp_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  especie = vector(mode = "character", length = data_exp_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))
for(i in 1:data_exp_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]) {
  df_especies$especie[i] <- data_exp_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}

sup_exp_especies <- df_exp_especies %>%
  filter(mun == municipio_actual$id & año == params$año & id_especie == "_T") %>% select(valor) %>% as.numeric()
sup_exp_especies_C <- df_exp_especies %>%
  filter(mun == "ES70" & año == params$año & id_especie == "_T") %>% select(valor) %>% as.numeric()

df_exp_especies$valor <- as.numeric(df_exp_especies$valor)
df_exp_especies <- df_exp_especies %>% transform(mun = if_else(mun == "38013_2007",  "38013", mun)) %>% 
  left_join(df_especies, by = "id_especie") %>% 
  filter(id_especie != "_T" & año == params$año)

rk_exp_especies_mun <- df_exp_especies %>%
  filter(mun == municipio_actual$id) %>%
  top_n(4, valor) %>% 
  arrange(valor) %>%
  select(c(especie, valor))

if(length(rk_exp_especies_mun$especie) > 6){
  rk_exp_especies_mun <- rk_exp_especies_mun %>% filter(valor != min(rk_exp_especies_mun$valor))
}
rk_exp_especies_mun$especie <- ordered(rk_exp_especies_mun$especie, levels = rk_exp_especies_mun$especie)

df_exp_especies_mun <- df_exp_especies %>%
  filter(mun == municipio_actual$id & especie %in% rk_exp_especies_mun$especie) %>%
  select(c(especie, valor))
df_exp_especies_C <- df_exp_especies %>%
  filter(mun == "ES70" & especie %in% rk_exp_especies_mun$especie) %>%
  select(c(especie, valor))
df_exp_especies_mun <- df_exp_especies_mun %>%
  mutate(porcentaje = df_exp_especies_mun$valor / sup_exp_especies * 100,
         valor_Canarias = df_exp_especies_C$valor,
         porcentaje_Canarias = df_exp_especies_C$valor / sup_exp_especies_C * 100)

df_exp_especies_plot <- df_exp_especies_mun %>%
  mutate(label = "|")
df_exp_especies_plot$especie <- ordered(df_exp_especies_plot$especie, levels = rk_exp_especies_mun$especie)

df_exp_especies_plot <- df_exp_especies_plot %>% transform(hovertext = paste0(
  "<b>", trimws(especie), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ","), "%)"
  )
)

df_exp_especies_0 <- df_exp_especies_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_exp_especies_plot <- rbind(df_exp_especies_plot, df_exp_especies_0)

df_exp_especies_plot <- df_exp_especies_plot %>% filter(valor != 0)

if(nrow(df_exp_especies_plot)/2 == 12){
  col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0083C4", "#0072A2", "#005980", "#00405B")
  }else if(nrow(df_exp_especies_plot)/2 == 11){
    col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#0099CC", "#008BD0", "#0072A2", "#005980", "#00405B")
    }else if(nrow(df_exp_especies_plot)/2 == 10){
      col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#28ACD1", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
      }else if(nrow(df_exp_especies_plot)/2 == 9){
        col <- c("#D5EDFA", "#8CD2EA", "#87CAE0", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
        }else if(nrow(df_exp_especies_plot)/2 == 8){
          col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")
          }else if(nrow(df_exp_especies_plot)/2 == 7){
            col <- c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
            }else if(nrow(df_exp_especies_plot)/2 == 6){
              col <- c("#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")
              }else if(nrow(df_exp_especies_plot)/2 == 5){
                col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#0072A2", "#005980")
                }else if(nrow(df_exp_especies_plot)/2 == 4){
                  col <- c("#8CD2EA", "#2CBCE2", "#008BD0", "#005980")
                  }else if(nrow(df_exp_especies_plot)/2 == 3){
                    col <- c("#8CD2EA", "#008BD0", "#005980")
                    }else if(nrow(df_exp_especies_plot)/2 == 2){
                      col <- c("#8CD2EA", "#005980")
                    }

g_exp_especies <- ggplot(data = df_exp_especies_plot, aes(y = especie, fill = especie, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = col) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_exp_especies <- ggplotly(g_exp_especies, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))  %>%
  style(hoverinfo = "skip", traces = c((nrow(df_exp_especies_plot)/2+1):46))
```

```{r Ganadería cabezas}
data_cab_especies <- fromJSON(params$url.cab_especies)

df_cab_especies <- data.frame(
  mun = rep(data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                   length(data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  año = rep(data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
            each = length(data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_especie = data_cab_especies[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
  valor = unlist(strsplit(data_cab_especies[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_especies_ <- data.frame(
  id_especie = data_cab_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  especie = vector(mode = "character", length = data_cab_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))
for(i in 1:data_cab_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]) {
  df_especies_$especie[i] <- data_cab_especies[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}

df_cab_especies$valor <- as.numeric(df_cab_especies$valor)
df_cab_especies <- df_cab_especies %>% transform(mun = if_else(mun == "38013_2007",  "38013", mun)) %>% 
    left_join(df_especies_, by = "id_especie")

df_cab_especies_mun <- df_cab_especies %>%
  filter(mun == municipio_actual$id & año == params$año & especie != "Total") %>% 
  arrange(-valor)

especie_1 <- df_cab_especies_mun$especie[1]
especie_2 <- df_cab_especies_mun$especie[2]
especie_3 <- df_cab_especies_mun$especie[3]
especie_4 <- df_cab_especies_mun$especie[4]

especie_1_num <- df_cab_especies_mun$valor[1] %>% format(big.mark = ".", decimal.mark = ",")
especie_2_num <- df_cab_especies_mun$valor[2] %>% format(big.mark = ".", decimal.mark = ",")
especie_3_num <- df_cab_especies_mun$valor[3] %>% format(big.mark = ".", decimal.mark = ",")
especie_4_num <- df_cab_especies_mun$valor[4] %>% format(big.mark = ".", decimal.mark = ",")
```


```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator3 = function(label, value, image) {
  return(sprintf("<div class='indicator3'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r params$año`</h3>
<h2 style="color: #666; margin: 0;">Sector primario</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">Superficie cultivada: `r superficie_cultivada` m<sup>2</sup></h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$municipio[i], leyenda_poblacion$valor[i], leyenda_poblacion$tasa[i]))
}
```
</div>
</div>

<div class="row">
```{r indicadores principales, results='asis'}
if(Variacion_Porcentual == "NA"){
  cat(paste0(
    "<div class='column-3'>", get_indicator2(paste0('Secano</br></p><p class="label" style="color: #999;">', paste0(percent_secano, '%')), sup_secano, './img/family.png'), "</div><div class='column-3'>", get_indicator2(paste0('Regadío</br></p><p class="label" style="color: #999;">', paste0(percent_regadio, '%')), sup_regadio, './img/family.png'), "</div><div class='column-3'>", get_indicator2("Cultivada<br>vs total", percent_sup_cultivada, "./img/percent-blue.png"), "</div>"))
}else{
  cat(paste0(
    "<div class='column-4'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual, '%'), Imagen_Variacion), "</div><div class='column-4'>", get_indicator2(paste0('Secano</br></p><p class="label" style="color: #999;">', paste0(percent_secano, '%')), sup_secano, './img/family.png'), "</div><div class='column-4'>", get_indicator2(paste0('Regadío</br></p><p class="label" style="color: #999;">', paste0(percent_regadio, '%')), sup_regadio, './img/family.png'), "</div><div class='column-4'>", get_indicator2("Cultivada<br>vs total", percent_sup_cultivada, "./img/percent-blue.png"), "</div>"))
}
```
</div>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map">
  <div class="image map-canarias">
```{r}
mapa_Canarias_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_isla_plot
```
  </div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_comarca_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_comarca`º </span>en la comarca</p>
  <p class="label2">de `r num_mun_comarca` municipios (`r percent_comarca`%)</p>
  </div>
</div>
</div>
</div>

<div class="row">
<div class="column indicator-title" style="margin-top: 10px;">
  <h3>Cultivos herbáceos</h3>
</div>
<div class="column indicator-title" style="margin-top: 10px;">
  <h3>Cultivos leñosos</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
<div class="piramide" style="height: 300px">
  `r g_herbaceos`
</div>

<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
<div class='progress-bar-C-b'>|</div><div class='sp-content'>Canarias</div></div>
</div>

</div>

<div class="column highlight">
<div class="piramide" style="height: 300px">
  `r g_leñosos`
</div>

<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
<div class='progress-bar-C-b'>|</div><div class='sp-content'>Canarias</div></div>
</div>

</div>
</div>

<div class="indicator-title" style="width: 100% !important; margin-left: 0; padding: 5px;">
  <h3>Ganadería</h3>
</div>
<div class="row">
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Número de explotaciones</h3>
</div>
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Número de cabezas</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
<div class="piramide" style="height: 152px">
  `r g_exp_especies`
</div>

<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
<div class='progress-bar-C-b'>|</div><div class='sp-content'>Canarias</div></div>
</div>

</div>

<div class="column highlight">
<div class="row" style="margin-top: 20px; margin-bottom: 15px;">
  <div class="column-2">`r get_indicator3(especie_1, especie_1_num, "./img/balanza.png")`</div> 
  <div class="column-2">`r get_indicator3(especie_2, especie_2_num, "./img/balanza.png")`</div> 
</div>
<div class="row" style="margin-bottom: 20px;">
  <div class="column-2">`r get_indicator3(especie_3, especie_3_num, "./img/balanza.png")`</div> 
  <div class="column-2">`r get_indicator3(especie_4, especie_4_num, "./img/balanza.png")`</div> 
</div>

</div>
</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

