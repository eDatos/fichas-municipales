---
title: ''
params:
  id_municipio: 35003
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/POBLACION
  url.mes: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS
  url.parque: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BREGIONS%7CMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.parque_tur: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PARQUE_VEHICULOS_TURISMOS/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D%2CTIME%5BMONTHLY%5D
  url.tipos: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=9019908a-7837-4af4-bef0-b4cfa226cb15
  url.presupuesto_1: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000001/~latest.json?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_EJECUTADO:PRESUPUESTO_PARTIDA:INGRESOS:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901&lang=es
  url.presupuesto_1_inicial: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E31025B_000001/~latest.json?dim=MEDIDAS:IMPORTE_PRESUPUESTARIO:PRESUPUESTO_ESTADO:PRESUPUESTO_INICIAL:PRESUPUESTO_PARTIDA:INGRESOS:TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901&lang=es
  url.ingresos_p: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PRESUPUESTO_AYUNTAMIENTOS_LIQUIDADO_INGRESO_HABITANTE/data?representation=MEASURE%5BABSOLUTE%5D
  url.gastos: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/PRESUPUESTO_AYUNTAMIENTOS_LIQUIDADO_GASTO_HABITANTE/data?representation=MEASURE%5BABSOLUTE%5D
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
    self_contained: false
    lib_dir: libs
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr", "reshape2", "kableExtra")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)
```

```{r funciones, include=FALSE}
signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")

get_nombre <- function(nombre) {
  string_list <- str_split(nombre, pattern = " ")[[1]]
  result <- ""
  line.char <- 0
  for(word.index in 1:length(string_list)) {
    if((line.char + nchar(string_list[word.index])) < 20) {
      result <- paste0(result, " ", string_list[word.index])
      line.char <- line.char + 1 + nchar(string_list[word.index])
    } else {
      result <- paste0(result, "<br>", string_list[word.index])
      line.char <- nchar(string_list[word.index])
    }
  }
  trimws(result)
}
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = if_else(substring(id, 0,5) == "38013",  "38013", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Pinar de El Hierro, El", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla", "San Sebastián de la Gomera", "Santa Cruz de la Palma")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla", "San Sebastián de La Gomera", "Santa Cruz de La Palma")

recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
# Frontera
recode_Frontera <- function(df) {
  df_f <- rbind(df %>% filter(ano %in% c(2008:max(ano)) & mun == "38013_1912"),
                df %>% filter(ano %in% c(2001:2007) & mun == "38013_2007"))
  df <- df %>% anti_join(df_f)
}
recode_id_Frontera <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = c("38013_1912", "38013_2007"), to = c("38013", "38013"))
  df[,colname]
}
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
df_localizacion <- filter(df_localizacion, mun != "38013_1912")
df_localizacion$mun <- recode_id_Frontera(df_localizacion, 'mun')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance

distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1,]
}
```


<!-- HTML -->
<body style="height: 1391px;">

<h3 style="color: #008BD0; margin: 0; text-align: right; margin: 10px;">`r municipio_actual$municipio` en cifras</h3>

<h1 style="color: #005980; margin-left: 20px;">Transporte y comunicaciones</h1>

```{r Mes}
data_mes <- fromJSON(params$url.mes)

mes <- data.frame(code = data_mes[["dimension"]][["TIME"]][["representation"]][["code"]],
                  periodo = data_mes[["dimension"]][["TIME"]][["representation"]][["title"]][["es"]],
                  granularidad = data_mes[["dimension"]][["TIME"]][["representation"]][["granularityCode"]]) %>% 
  filter(granularidad == "MONTHLY") %>% select(!granularidad)

mes <- mes %>% 
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1)))) %>% 
  mutate(order = as.integer(order(mes$code, decreasing = FALSE))) %>%
  arrange(order)
mes_actual <- mes[nrow(mes),]
```

```{r Gráfico evolución}
data_u <- fromJSON(params$url.parque)
df_u <- data.frame(
  mun = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_u[["dimension"]][["TIME"]][["representation"]][["size"]] * data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  mes = rep(names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]),
            each=data_u[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  valor = round(as.numeric(data_u[["observation"]]), 1)) %>%
  spread(medida, valor) %>%
  select(mun, mes, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)

ano_min <- min(df_u$mes) %>% substring(0,4) %>% as.numeric
ano_max <- max(df_u$mes) %>% substring(0,4) %>% as.numeric

related_mun <- df_u %>% filter(mes == mes_actual$code & mun != "ES70")
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')
if(related_mun$mun[1] != params$id_municipio) {stop("Error: indicador principal desconocido")}

df_v <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, mes, nombre, valor, tasa) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(mun = id, code = mes, nombre, valor, tasa) %>%
  left_join(mes, by = "code") %>% 
  filter(order < mes_actual$order+1)

min_ano <- max(0.8, nrow(df_v[df_v$nombre == municipio_actual$municipio, ]) - 5*12)
max_ano <- nrow(df_v[df_v$nombre == municipio_actual$municipio, ])
rango <- c(min_ano, max_ano)

I_v_num <- df_v %>% filter(order == min_ano) %>% select(valor) %>% as.numeric
I_v <- I_v_num %>% format(big.mark = ".", decimal.mark = ",")
Num_v_num <- df_v %>% filter(mun == params$id_municipio & code == mes_actual$code) %>% select(valor) %>% as.numeric
Num_v <- Num_v_num %>% format(big.mark = ".", decimal.mark = ",")

df_v <- df_v %>%
  transform(hovertext = paste0(
    "<b>", nombre, "</b><br>Número de vehículos: ", ifelse(is.na(valor), " -", trimws(format(valor, big.mark = ".", decimal.mark = ","))),
    "<br>Tasa de variación: ", ifelse(is.na(tasa), " -", paste0(trimws(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1)), "%"))))

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

g_line_v <- ggplot(data = df_v, 
                 aes(x = code, y = valor, group = nombre, colour = nombre, text = hovertext)) +
  geom_line(size = 0.7) +
  geom_text(aes(x = rango[1], y = (0.92*I_v_num), label = I_v, colour = '#000000'), size = 3.5, nudge_x = 3) +
  geom_text(aes(x = rango[2], y = (0.94*Num_v_num), label = Num_v_num, colour = '#000000'), size = 3.5, nudge_x = -3) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_discrete(breaks = function(x) {paste0(ano_min:ano_max,"-01")}, labels = function(x){substr(x, 0, 4)}) +
  scale_y_continuous(labels = function(x) {paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line_v <- ggplotly(g_line_v, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = rango)) %>%
  style(hoverinfo = "skip", traces = c(2, 3))
```


```{r Parque de vehículos, results='asis'}
data_Tur_Parque <- fromJSON(params$url.parque_tur)

df_Tur_Parque <- data.frame(
  mun = rep(names(data_Tur_Parque[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                  each=data_Tur_Parque[["dimension"]][["TIME"]][["representation"]][["size"]] * data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  code = rep(names(data_Tur_Parque[["dimension"]][["TIME"]][["representation"]][["index"]]),
             each=data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["size"]]),
  medida = names(data_Tur_Parque[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
  turismos = as.numeric(data_Tur_Parque[["observation"]]))
df_Tur_Parque$turismos <- as.numeric(df_Tur_Parque$turismos)

df_Tur_Parque <- df_Tur_Parque %>%
  filter(mun == params$id_municipio & medida == "ABSOLUTE") %>%
  select(c(code, turismos))

data_tipos <- fromJSON(params$url.tipos)

df_tipos <- cbind(data.frame(do.call('rbind', data_tipos[["data"]][["dimCodes"]])), data_tipos[["data"]][["Valor"]])
colnames(df_tipos) <- c('veh', 'combustible', 'mun', 'code', 'valor')
df_tipos$veh <- factor(df_tipos$veh, levels=data_tipos[["categories"]][["codes"]][[1]], labels=data_tipos[["categories"]][["labels"]][[1]])
df_tipos$combustible <- factor(df_tipos$combustible, levels=data_tipos[["categories"]][["codes"]][[2]], labels=data_tipos[["categories"]][["labels"]][[2]])
df_tipos$mun <- factor(df_tipos$mun, levels=data_tipos[["categories"]][["codes"]][[3]])
df_tipos$code <- factor(df_tipos$code, levels=data_tipos[["categories"]][["codes"]][[4]],
                        labels=paste0(substring(data_tipos[["categories"]][["codes"]][[4]], 0,4), "-", substring(data_tipos[["categories"]][["codes"]][[4]], 6,7)))
df_tipos$valor <- as.numeric(df_tipos$valor)
df_tipos$mun <- recode_mun(df_tipos, 'mun')

df_electricos <- df_tipos %>%
  filter(veh == "TOTAL" & combustible == "Eléctrico" & mun == params$id_municipio) %>%
  select(c(code, electricos = valor))

tb_periodos <- df_v %>%
  filter(order > max(df_v$order) - 9) %>%
  select(code)

tb_v <- df_v %>%
  right_join(df_Tur_Parque, by = "code") %>%
  right_join(df_electricos, by = "code") %>%
  filter(code %in% tb_periodos$code) %>%
  arrange(desc(code)) %>%
  mutate(valor = ifelse(is.na(valor), " -", paste0(format(valor, big.mark = ".", decimal.mark = ","))),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")),
         turismos = ifelse(is.na(turismos), " -", paste0(format(turismos, big.mark = ".", decimal.mark = ","))),
         electricos = ifelse(is.na(electricos), " -", paste0(format(electricos, big.mark = ".", decimal.mark = ",")))) %>%
  select('Periodo' = code, 'Vehículos' = valor, 'Tasa' = tasa, 'Turismos' = turismos, 'Eléctricos' = electricos)

tb_v <- tb_v %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  column_spec(2:5, width = "20%")
```
<div class="highlight" style="width: 100% !important; margin: 15px 5px;">
<h2 style="color: #005980; margin-left: 20px;">Parque de vehículos</h2>

<div class="row">
  <div class="column-2" style="padding-top: 20px;">`r tb_v`</div>

  <div class="column-2" style="height: 350px;">`r g_line_v`</div>
</div>

</div>

--------------------------------------------

<h1 style="color: #005980; margin-left: 20px;">Administración pública</h1>

```{r Gráfico evolución del presupuesto}
# Presupuesto inicial
data_I <- fromJSON(params$url.presupuesto_1_inicial)
dI <- length(rep(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                 each = length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                        length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]))) -
      length(unlist(strsplit(data_I[["data"]][["observations"]], split = " | ", fixed = TRUE)))

###### Añadir aviso si la variable d_ es mayor que 0 ######

df_I <- data.frame(
  ano = rep(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  mun = rep(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
            times = length(data_I[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]])),
  valor = c(unlist(strsplit(data_I[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, dI)))
df_I$valor <- as.numeric(df_I$valor)
df_I <- recode_Frontera(df_I)
df_I$mun <- recode_id_Frontera(df_I, 'mun')
df_I <- df_I[with(df_I, order(ano)), ] %>%
  filter(mun == params$id_municipio) %>%
  mutate(valor_M = round(valor / 10^6, 1), ano = as.integer(ano)) %>%
  transform(mun = paste0(municipio_actual$municipio, "_inicial")) %>%
  filter(ano <= max(ano))

# Liquidación del presupuesto consolidado de ingresos y gastos de las Entidades Locales según capítulos de la estructura económica y fases presupuestarias. Islas y municipios de Canarias por años [tabla1]
data_u <- fromJSON(params$url.presupuesto_1)

du <- length(rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                 each = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]))) -
      length(unlist(strsplit(data_u[["data"]][["observations"]], split = " | ", fixed = TRUE)))

###### Añadir aviso si la variable d_ es mayor que 0 ######

df_u <- data.frame(
  ano = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  mun = rep(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
            times = length(data_u[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]])),
  valor = c(unlist(strsplit(data_u[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, du)))
df_u$valor <- as.numeric(df_u$valor)
df_u <- recode_Frontera(df_u)
df_u$mun <- recode_id_Frontera(df_u, 'mun')
df_u <- df_u[with(df_u, order(ano)), ] %>%
  mutate(valor_M = round(valor / 10^6, 1), ano = as.integer(ano))

related_mun <- df_u %>% filter(ano == max(df_u$ano))
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

df_ps <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, ano, nombre, valor, valor_M) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(ano, mun = id, nombre, valor, valor_M) %>%
  mutate(tasa =  round(100*((valor / lag(valor)) - 1), 1), ano = as.integer(ano)) %>%
  filter(ano != min(ano) & ano <= max(df_u$ano))

min_ano <- max(max(df_ps$ano) - 18, min(df_ps$ano))
max_ano <- max(df_ps$ano)
rango <- c(min_ano, max_ano)

I_pr_num <- df_ps %>% filter(ano == min_ano & mun == params$id_municipio) %>% select(valor) %>% as.numeric
pr_num <- df_u %>% filter(ano == max_ano & mun == params$id_municipio) %>% select(valor) %>% as.numeric
I_pr <- I_pr_num %>% format(big.mark = ".", decimal.mark = ",") %>% as.character
pr <- pr_num %>% format(big.mark = ".", decimal.mark = ",") %>% as.character

df_ps <- df_ps %>%
  left_join(df_I %>% select(ano, valor_inicial = valor_M), by = "ano") %>%
  transform(hovertext = paste0(
    "<b>", nombre, "</b><br>Presupuesto inicial: ", ifelse(is.na(valor_inicial), " -", paste0(format(valor_inicial, big.mark = ".", decimal.mark = ",", nsmall = 1), " mill.€")),
    "<br>Presupuesto ejecutado: ", ifelse(is.na(valor_M), " -", paste0(format(valor_M, big.mark = ".", decimal.mark = ",", nsmall = 1), " mill.€")),
    "<br>Tasa de variación: ", ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))))

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

g_line_ps <- ggplot(data = df_ps, aes(x = ano, y = valor_M, group = nombre, colour = nombre, text = hovertext)) +
  geom_line(size = 0.7) +
  geom_text(aes(x = min_ano+0.4, y = (0.92*I_pr_num), label = I_pr, colour = '#000000'), size = 3.5) +
  geom_text(aes(x = max_ano-0.4, y = (0.94*pr_num), label = pr, colour = '#000000'), size = 3.5) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_continuous(breaks = function(x){seq(from = min(df_ps$ano), to = max(df_ps$ano), by = as.integer((max(df_ps$ano)-min(df_ps$ano))/3))}) +
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), " mill.")}, n.breaks = 5, limits = c(0, NA))

g_line_ps <- ggplotly(g_line_ps, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = rango)) %>%
  style(hoverinfo = "skip", traces = c(2, 3))
```

```{r Ingresos por habitante}
# Presupuesto liquidado. Ingresos por habitante. Ayuntamientos.
ind_Ingresos <- fromJSON(params$url.ingresos_p)

df_ind_Ingresos <- data.frame(
  mun = rep(names(ind_Ingresos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
            each=ind_Ingresos[["dimension"]][["TIME"]][["representation"]][["size"]]),
  ano = as.integer(names(ind_Ingresos[["dimension"]][["TIME"]][["representation"]][["index"]])),
  valor = as.integer(ind_Ingresos[["observation"]]))
df_ind_Ingresos <- recode_Frontera(df_ind_Ingresos)
df_ind_Ingresos$mun <- recode_id_Frontera(df_ind_Ingresos, 'mun')
```

```{r Gastos por habitante}
# Presupuesto liquidado. Gastos por habitante. Ayuntamientos.
ind_Gastos <- fromJSON(params$url.gastos)

df_ind_Gastos <- data.frame(
  mun = rep(names(ind_Gastos[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
            each=ind_Gastos[["dimension"]][["TIME"]][["representation"]][["size"]]),
  ano = as.integer(names(ind_Gastos[["dimension"]][["TIME"]][["representation"]][["index"]])),
  valor = as.integer(ind_Gastos[["observation"]]))
df_ind_Gastos <- recode_Frontera(df_ind_Gastos)
df_ind_Gastos$mun <- recode_id_Frontera(df_ind_Gastos, 'mun')
```

```{r Presupuesto, results='asis'}
tb_ps <- df_ps %>%
  filter(ano %in% c((max_ano-7):max_ano))

df_ind_Ingresos <- df_ind_Ingresos %>%
  filter(mun == params$id_municipio) %>%
  select(ano, ingresos = valor)

df_ind_Gastos <- df_ind_Gastos %>%
  filter(mun == params$id_municipio) %>%
  select(ano, gastos = valor)

tb_ps <- tb_ps %>%
  left_join(df_ind_Ingresos, 'ano') %>%
  left_join(df_ind_Gastos, 'ano') %>%
  arrange(-ano) %>%
  mutate(valor_inicial = ifelse(is.na(valor_inicial), " -", paste0(format(valor_inicial, big.mark = ".", decimal.mark = ",", nsmall = 1), " mill.€")),
         valor_M = ifelse(is.na(valor_M), " -", paste0(format(valor_M, big.mark = ".", decimal.mark = ",", nsmall = 1), " mill.€")),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")),
         ingresos = ifelse(is.na(ingresos), " -", paste0(format(ingresos, big.mark = ".", decimal.mark = ","), " €")),
         gastos = ifelse(is.na(gastos), " -", paste0(format(gastos, big.mark = ".", decimal.mark = ","), " €"))) %>%
  select('Año' = ano, 'Pres. inicial' = valor_inicial, 'Pres. ejecutado' = valor_M, 'Tasa de variación' = tasa,  'Ingresos /habitante' = ingresos, 'Gastos /habitante' = gastos)

tb_ps <- tb_ps %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  column_spec(2:6, width = "18%")
```
<div class="highlight" style="width: 100% !important; margin: 15px 5px;">
<h2 style="color: #005980; margin-left: 20px;">Presupuesto ejecutado de ingresos y gastos</h2>

<div class="row">
  <div class="column-2" style="padding-top: 20px;">`r tb_ps`</div>

  <div class="column-2" style="height: 350px;">`r g_line_ps`</div>
</div>
</div>


--------------------------------------------
<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

