---
title: ''
params:
  id_municipio: 38001
  convocatoria: 2019
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.mapa_2007: https://datos.canarias.es/catalogos/estadisticas/dataset/03f5044c-6d40-4c09-84db-eaf9d6681b48/resource/d765c56b-a67d-46e2-800e-5c9a1e9138f0/download/municipios_20170101_antes2007.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.municipales_2019: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/C00010A_000032/~latest.json?dim=TERRITORIO:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.municipales_2015: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/C00010A_000015/~latest.json?dim=TERRITORIO:35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|35004|35010|35018|35024|35028|20150524_35028_D01_S001|20150524_35028_D01_S002|20150524_35028_D01_S003|20150524_35028_D01_S004|20150524_35028_D01_S005|20150524_35028_D01_S006|35029|35034|38013|38048|38901|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052&lang=es
  url.municipales_2011: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/C00010A_000005/~latest.json?dim=TERRITORIO:35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|35004|35010|35018|35024|35028|20110522_35028_D01_S001|20110522_35028_D01_S002|20110522_35028_D01_S003|20110522_35028_D01_S004|20110522_35028_D01_S005|20110522_35028_D01_S006|35029|35034|38013|38048|38901|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052&lang=es
  url.municipales_2007: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/C00010A_000025/~latest.json?dim=TERRITORIO:35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|35004|35010|35018|35024|35028|20070527_35028_D01_S001|20070527_35028_D01_S002|20070527_35028_D01_S003|20070527_35028_D01_S004|20070527_35028_D01_S005|20070527_35028_D01_S006|35029|35034|38013|38048|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052&lang=es
  url.municipales_participacion: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/C00010A_000001/~latest.json?dim=TERRITORIO:ES70|35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_1912|38013_2007|38048|38901:PROCESO_ELECTORAL:MUNICIPALES_2019|MUNICIPALES_2015|MUNICIPALES_2011|MUNICIPALES_2007&lang=es
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)

signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")
```

```{r Convocatoria}
data_participacion <- fromJSON(params$url.congreso_participacion)

convocatoria <- data.frame(
    code = data_participacion[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["id"]],
    name = vector(mode = "character", length = data_participacion[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]))
for(i in 1:data_participacion[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]) {
  convocatoria$name[i] <- data_participacion[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["name"]][["text"]][[i]][["value"]]
}

convocatoria_congreso <- convocatoria %>% 
  filter(substring(code, 0,9) == "CONGRESO_") %>% 
  transform(url = paste0("url.", tolower(code)))
convocatoria_congreso <- convocatoria_congreso %>% 
  mutate(order = as.integer(order(1:nrow(convocatoria_congreso), decreasing = TRUE)),
         convocatoria_formatted = ifelse(substring(code, 10,13) == "2019",
                                         paste0(substring(code, 15,15), tolower(substring(code, 16,23)), " ", substring(code, 10,13)),
                                         paste0(substring(code, 10,13))),
         convocatoria_axis = ifelse(substring(code, 10,13) == "2019",
                                    paste0(tolower(substring(code, 15,17)), " ", substring(code, 10,13)),
                                    paste0(substring(code, 10,13))))

convocatoria_actual <- convocatoria_congreso %>% filter(substring(code, 10,23) == params$convocatoria)
convocatoria_tva <- convocatoria_congreso[convocatoria_congreso$order == convocatoria_congreso[convocatoria_actual$code == convocatoria_congreso$code, ]$order - 1, ]
min_code <- min(convocatoria_congreso$code)
convocatoria_congreso$code <- factor(convocatoria_congreso$code, levels = convocatoria_congreso$code)
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>% 
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = if_else(substring(id, 0,5) == "38013",  "38013", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>%
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Pinar de El Hierro, El", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla")
recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
  
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico evolución de la población}
df_participacion <- data.frame(
    ind = rep(data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
              each = length(data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                     length(data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
    mun = rep(data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
              each = length(data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
    proceso = data_participacion[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
    valor = c(unlist(strsplit(data_participacion[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, dP)))
df_participacion$valor <- as.numeric(df_participacion$valor)
df_u_ <- df_participacion %>% filter(substring(mun, 0,2) != "ES" & ind == "ELECTORES") %>% arrange(proceso) %>% select(!ind)

related_mun <- df_u_ %>% filter(proceso == convocatoria_actual$code)
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

min_code <- min(df_u_$proceso)
df <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u_, by = "mun") %>%
  select(id = mun, proceso, valor, nombre) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(code = proceso, valor, Municipio = id, nombre) %>%
  left_join(convocatoria_congreso, by = "code") %>%
  transform(Tasa = ifelse(code == min_code, NA, round(100*((valor / lag(valor)) - 1), 1))) %>% 
  filter(order <= convocatoria_actual$order)

g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)'), related_mun$nombre)

leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Electores: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span></div></div>"
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Electores: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s</span>"

df <- df %>% mutate(
    tooltip = ifelse(code == convocatoria_actual$code,
                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")), ' (',convocatoria_formatted,')'),
                             ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
    )
)

g_line <- ggplot(data = df, 
                 aes(x = order, y = valor, group = nombre, colour = nombre, text = tooltip)) +
  geom_line(size = 0.7) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_continuous(breaks = c(convocatoria_congreso$order[convocatoria_actual$order:1]), labels = c(convocatoria_congreso$convocatoria_axis[convocatoria_actual$order:1])) +
  scale_y_continuous(labels = function(x) {paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified') %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) { highlight(d); });
      el.on('plotly_unhover', function(d) { reset(d); });
      el.on('plotly_click', function(d) { highlight(d); });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 

leyenda_poblacion <- df %>% filter(code == convocatoria_actual$code) %>%
  mutate(valor = ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
         Tasa = ifelse(is.na(Tasa), " -", paste0(format(Tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))) %>%
  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "nombre")
```

```{r Indicadores}
df_participacion_mun <- df_participacion %>% filter(mun == params$id_municipio & proceso == convocatoria_actual$code) %>% select(c(ind, valor))

Num_Electores <- df_participacion_mun %>% filter(ind == "ELECTORES") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Variacion_Porcentual_Elec <- df %>% filter(nombre == municipio_actual$municipio & code == convocatoria_actual$code) %>% select(Tasa) %>%
  as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Imagen_Variacion <- ifelse(signo(Variacion_Porcentual_Elec) == "más", './img/up.png', './img/down.png')

Tasa_participacion <- df_participacion_mun %>% filter(ind == "TASA_PARTICIPACION") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",")
Tasa_abstencion <- df_participacion_mun %>% filter(ind == "TASA_ABSTENCION") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",")

Elec_votantes <- df_participacion_mun %>% filter(ind == "ELECTORES_VOTANTES") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Elec_abstenidos <- df_participacion_mun %>% filter(ind == "ELECTORES_ABSTENIDOS") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")

Votos_validos <- df_participacion_mun %>% filter(ind == "VOTOS_VALIDOS") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Votos_candidatura <- df_participacion_mun %>% filter(ind == "VOTOS_VALIDOS_CANDIDATURA") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Votos_blanco <- df_participacion_mun %>% filter(ind == "VOTOS_VALIDOS_BLANCO") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Votos_nulos <- df_participacion_mun %>% filter(ind == "VOTOS_NULOS") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")
Tasa_Votos_validos <- df_participacion_mun %>% filter(ind == "TASA_VOTOS_VALIDOS") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Tasa_Votos_candidatura <- df_participacion_mun %>% filter(ind == "TASA_VOTOS_VALIDOS_CANDIDATURA") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Tasa_Votos_blanco <- df_participacion_mun %>% filter(ind == "TASA_VOTOS_VALIDOS_BLANCO") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Tasa_Votos_nulos <- df_participacion_mun %>% filter(ind == "TASA_VOTOS_NULOS") %>% select(valor) %>% as.numeric() %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Data Resultados}
data_municipales <- fromJSON(params[[convocatoria_actual$url]])

dM <- length(rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                 each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                        length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]))) -
      length(unlist(strsplit(data_municipales[["data"]][["observations"]], split = " | ", fixed = TRUE)))

###### Añadir aviso si la variable d_ es mayor que 0 ######

if(params$convocatoria == 2015){
  df_municipales <- data.frame(
    candidatura = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                      each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                             length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
    mun = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
              each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
    medida = data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
    valor = c(unlist(strsplit(data_municipales[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, dM)))
  
  df_partido <- data.frame(
    candidatura = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[1]][["id"]],
    name_partido = vector(mode = "character", length = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][1]))
  for(i in 1:data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][1]) {
    df_partido$name_partido[i] <- data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[1]][["name"]][["text"]][[i]][["value"]]
  }}else{
    if(params$convocatoria %in% c(2019, 2007)){
      df_municipales <- data.frame(
        mun = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                     each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                            length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
        medida = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                  each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
        candidatura = data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
        valor = c(unlist(strsplit(data_municipales[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, dM)))
      
      df_partido <- data.frame(
        candidatura = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["id"]],
        name_partido = vector(mode = "character", length = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]))
      for(i in 1:data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]) {
        df_partido$name_partido[i] <- data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["name"]][["text"]][[i]][["value"]]
        }}else{
          if(params$convocatoria == 2011){
            df_municipales <- data.frame(
              mun = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                                each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                                       length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
              candidatura = rep(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                           each = length(data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]])),
              medida = data_municipales[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
              valor = c(unlist(strsplit(data_municipales[["data"]][["observations"]], split = " | ", fixed = TRUE)), rep(NA, dM)))
            
            df_partido <- data.frame(
              candidatura = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[2]][["id"]],
              name_partido = vector(mode = "character", length = data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][2]))
            for(i in 1:data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][2]) {
              df_partido$name_partido[i] <- data_municipales[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[2]][["name"]][["text"]][[i]][["value"]]
            }}
        }
  }

df_municipales$valor <- as.numeric(df_municipales$valor)
df_municipales <- df_municipales %>% transform(mun = if_else(mun == "38013_2007",  "38013", mun))
```

```{r Resultados}
df_municipales_mun <- df_municipales %>% 
  left_join(df_partido, by = "candidatura") %>%
  filter(mun == params$id_municipio)

partido_mas_votado <- df_municipales_mun %>% filter(medida == "VOTOS_VALIDOS_CANDIDATURA" & substring(candidatura, 0,1) == "P") %>% top_n(1, valor) %>%
  select(name_partido) %>% as.character()
df_plot_ <- df_municipales_mun %>% filter(substring(candidatura, 0,1) == "G") %>% arrange(valor) %>% select(c(medida, name_partido, valor))
df_plot_ <- df_plot_ %>%
  spread(medida, valor) %>% filter(!is.na(VOTOS_VALIDOS_CANDIDATURA)) %>%
  select(name_partido, VOTOS_VALIDOS_CANDIDATURA, RATIO_VOTOS_CANDIDATURA) %>% arrange(desc(VOTOS_VALIDOS_CANDIDATURA))
df_plot <- df_plot_ %>% rbind(c("", sum(df_plot_$VOTOS_VALIDOS_CANDIDATURA)))
df_plot$VOTOS_VALIDOS_CANDIDATURA <- as.numeric(df_plot$VOTOS_VALIDOS_CANDIDATURA)
df_plot$RATIO_VOTOS_CANDIDATURA <- as.numeric(df_plot$RATIO_VOTOS_CANDIDATURA)
df_plot <- df_plot %>% mutate(porcentaje = df_plot$VOTOS_VALIDOS_CANDIDATURA / sum(df_plot$VOTOS_VALIDOS_CANDIDATURA) * 100)

df_plot$name_partido <- ordered(df_plot$name_partido, levels = df_plot_$name_partido[nrow(df_plot_):1])

df_plot <- df_plot %>% transform(hovertext = paste0(
    "<b>", name_partido, " </b>",
    "<br>", trimws(format(VOTOS_VALIDOS_CANDIDATURA, big.mark = ".", decimal.mark = ",")), " votos", 
    " (", trimws(format(round(RATIO_VOTOS_CANDIDATURA, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)), "%)"
  )
)
df_plot$hovertext[which(is.na(df_plot$RATIO_VOTOS_CANDIDATURA))] <- ""

if(nrow(df_plot_) == 7){
  col <- c("#005980", "#0072A2", "#008BD0", "#00A6DC", "#2CBCE2", "#8CD2EA", "#D5EDFA", "white")
  }else if(nrow(df_plot_) == 6){
      col <- c("#005980", "#0072A2", "#008BD0", "#00A6DC", "#2CBCE2", "#8CD2EA", "white")
      }else if(nrow(df_plot_) == 5){
        col <- c("#005980", "#0072A2", "#008BD0", "#00A6DC", "#2CBCE2", "white")
        }else if(nrow(df_plot_) == 4){
          col <- c("#005980", "#0072A2", "#008BD0", "#00A6DC", "white")
          }

g_municipales_mun <- plot_ly(df_plot, labels = df_plot$name_partido, values = df_plot$porcentaje, type = 'pie', sort = TRUE, direction = "clockwise", hole = 0.6,
                             textposition = "none", textinfo = "none", insidetextfont = list(color = "white"), hoverinfo = "text", text = df_plot$hovertext,
                             rotation = 90, marker = list(colors = col, line = list(width = 0))
                             )

g_municipales_mun <- ggplotly(g_municipales_mun, tooltip = c("text")) %>%
  layout(showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))
```

```{r Resultados Canarias}
df_municipales_C <- df_municipales %>% 
  left_join(df_partido, by = "candidatura") %>%
  filter(mun == "ES70")

partido_mas_votado_C <- df_municipales_C %>%
  filter(medida == "VOTOS_VALIDOS_CANDIDATURA" & substring(candidatura, 0,1) == "P") %>% top_n(1, valor) %>% select(name_partido) %>% as.character()
df_plot_C_ <- df_municipales_C %>% filter(substring(candidatura, 0,1) == "G") %>% arrange(valor) %>% select(c(medida, name_partido, valor))
df_plot_C_ <- df_plot_C_ %>% 
  spread(medida, valor) %>% filter(!is.na(VOTOS_VALIDOS_CANDIDATURA)) %>% 
  select(name_partido, VOTOS_VALIDOS_CANDIDATURA, RATIO_VOTOS_CANDIDATURA) %>% arrange(desc(VOTOS_VALIDOS_CANDIDATURA))
df_plot_C <- df_plot_C_ %>% rbind(c("", sum(df_plot_C_$VOTOS_VALIDOS_CANDIDATURA)))
df_plot_C$VOTOS_VALIDOS_CANDIDATURA <- as.numeric(df_plot_C$VOTOS_VALIDOS_CANDIDATURA)
df_plot_C$RATIO_VOTOS_CANDIDATURA <- as.numeric(df_plot_C$RATIO_VOTOS_CANDIDATURA)
df_plot_C <- df_plot_C %>% mutate(porcentaje = df_plot_C$VOTOS_VALIDOS_CANDIDATURA / sum(df_plot_C$VOTOS_VALIDOS_CANDIDATURA) * 100)

df_plot_C$name_partido <- ordered(df_plot_C$name_partido, levels = df_plot_C$name_partido[nrow(df_plot_C_):1])

df_plot_C <- df_plot_C %>% transform(hovertext = paste0(
    "<b>", name_partido, " </b>",
    "<br>", trimws(format(VOTOS_VALIDOS_CANDIDATURA, big.mark = ".", decimal.mark = ",")), " votos", 
    " (", trimws(format(round(RATIO_VOTOS_CANDIDATURA, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)), "%)"
  )
)
df_plot_C$hovertext[which(is.na(df_plot_C$RATIO_VOTOS_CANDIDATURA))] <- ""

if(nrow(df_plot_C_) == 7){
  col <- c("#59656E", "#77848D", "#8C9BA3", "#99A9B1", "#ABBBC2", "#BBC8D0", "#CED6E7", "white")
  }else if(nrow(df_plot_C_) == 6){
      col <- c("#59656E", "#77848D", "#8C9BA3", "#99A9B1", "#ABBBC2", "#BBC8D0", "white")
      }else if(nrow(df_plot_C_) == 5){
        col <- c("#59656E", "#77848D", "#8C9BA3", "#99A9B1", "#ABBBC2", "white")
        }else if(nrow(df_plot_C_) == 4){
          col <- c("#59656E", "#77848D", "#8C9BA3", "#99A9B1", "white")
          }

g_municipales_C <- plot_ly(df_plot_C, labels = df_plot_C$name_partido, values = df_plot_C$porcentaje, type = 'pie', sort = TRUE, direction = "clockwise", hole = 0.6,
                           textposition = "none", textinfo = "none", insidetextfont = list(color = "white"), hoverinfo = "text", text = df_plot_C$hovertext,
                           rotation = 90, marker = list(colors = col, line = list(width = 0))
                           )

g_municipales_C <- ggplotly(g_municipales_C, tooltip = c("text")) %>%
  layout(showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage")))
```

```{r Barras Participación}
df_bars <- df_participacion_mun %>% filter(ind %in% c("VOTOS_VALIDOS_CANDIDATURA", "VOTOS_VALIDOS_BLANCO", "VOTOS_NULOS"))
df_participacion_C <- df_participacion %>% filter(mun == "ES70" & proceso == convocatoria_actual$code & ind %in% c("VOTOS_VALIDOS_CANDIDATURA", "VOTOS_VALIDOS_BLANCO", "VOTOS_NULOS")) %>%
  select(c(ind, valor))
df_participacion_C <- df_participacion_C %>% mutate(porcentaje = df_participacion_C$valor / sum(df_participacion_C$valor) * 100)

df_bars <- df_bars %>%
  mutate(porcentaje = df_bars$valor / sum(df_bars$valor) * 100,
         valor_Canarias = df_participacion_C$valor,
         porcentaje_Canarias = df_participacion_C$valor / sum(df_participacion_C$valor) * 100)
df_bars <- df_bars %>% mutate(label = "|")

df_bars <- df_bars %>% transform(hovertext = paste0(
  "<b>", trimws(ind), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)), "%)",
  "<br>Canarias: ", format(valor_Canarias, big.mark = ".", decimal.mark = ","),
  " (", format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",", nsmall = 1), "%)"
  )
)

df_bars_0 <- df_bars %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_bars <- rbind(df_bars, df_bars_0)

g_participacion <- ggplot(data = df_bars,
                          aes(y = ind, fill = ind,  label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  scale_fill_manual(values = c("#8CD2EA", "#008BD0", "#005980")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.text.y = element_blank(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(n.breaks = 5, labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_participacion <- ggplotly(g_participacion, tooltip = c("text")) %>%
  layout(hovermode = "y unified", showlegend = FALSE) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(4:6))
```


```{r Generación HTML, results="asis"}
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
get_indicator4 = function(title, label, value) {
  return(sprintf("<div class='indicator4'><div class='title'>%s</div><hr class='separator'><p class='value'>%s</p><p class='label'>%s</p></div>", title, value, label))
}
```

<!-- HTML -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r convocatoria_actual$convocatoria_formatted`</h3>
<h2 style="color: #666; margin: 0;">Resultados de las Elecciones Municipales</h2>
<hr>

<div class="linechart-placeholder">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Electores` electores</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$nombre[i], leyenda_poblacion$valor[i], leyenda_poblacion$Tasa[i]))
}
```
</div>
</div>

<div class="row">
```{r Indicadores principales, results='asis'}
if(Variacion_Porcentual_Elec == "NA"){
  cat(paste0(
    "<div class='column-2'>", get_indicator2('Tasa de</br>abstención', Tasa_abstencion, './img/percent-blue.png'), "</div><div class='column-2'>", get_indicator2('Tasa de</br>participación', Tasa_participacion, './img/percent-blue.png'), "</div>"))
}else{
  cat(paste0(
    "<div class='column-3'>", get_indicator2('Tasa de</br>variación', paste0(Variacion_Porcentual_Elec, '%'), Imagen_Variacion), "</div><div class='column-3'>", get_indicator2('Tasa de</br>abstención', Tasa_abstencion, './img/percent-blue.png'), "</div><div class='column-3'>", get_indicator2('Tasa de</br>participación', Tasa_participacion, './img/percent-blue.png'), "</div>"))
}
```
</div>

<div class="indicator-title" style="width: 100% !important; margin-top: 10px; margin-left: 0">
  <h3>Resultados por grupos de partidos</h3>
</div>
<div class="row highlight" style="width: 100% !important; margin-top: 10px;">
<div class="column" style="margin-bottom: 20px;">

<div class="piramide" style="height: 280px;">
  `r g_municipales_mun`
</div>

<div class="legend-vertical-container" style="margin-top: -100px;">
```{r leyenda mun, results='asis'}
for (i in 1:nrow(df_plot_)) {
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-blue",i,"'></div><div class='sp-content-b'>", df_plot[i,]$name_partido, " (", format(round(df_plot[i,]$RATIO_VOTOS_CANDIDATURA, 1), big.mark = ".", decimal.mark = ",", nsmall = 1), "%)</div></div>"))
}
```
</div>

</div>

<div class="column" style="margin-bottom: 20px;">

<div class="piramide" style="height: 280px;">
  `r g_municipales_C`
</div>

<p style="margin: -120px 20px 0; position: relative;">Canarias</p>
<div class="legend-vertical-container" style="margin-top: 6px;">
```{r leyenda Canarias, results='asis'}
for (i in 1:nrow(df_plot_C_)) {
  cat(paste0(
    "<div class='progressbar-legend'><div class='progress-bar-grey",i,"'></div><div class='sp-content-b'>", df_plot_C[i,]$name_partido, " (", format(round(df_plot_C[i,]$RATIO_VOTOS_CANDIDATURA, 1), big.mark = ".", decimal.mark = ",", nsmall = 1), "%)</div></div>"))
}
```
</div>

</div>
</div>

<div class="indicator-title" style="width: 100% !important; margin-top: 20px; margin-left: 0">
  <h3>Tipos de votos</h3>
</div>
<div class="row">
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Votos</h3>
</div>
<div class="column indicator-title" style="margin-top: 0px;">
  <h3>Votos válidos</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
  <div class="column-2">`r get_indicator4("Válidos", paste0(Tasa_Votos_validos, "%"), Votos_validos)`</div>
  <div class="column-2">`r get_indicator4("Nulos", paste0(Tasa_Votos_nulos, "%"), Votos_nulos)`</div>
</div>
<div class="column highlight">
  <div class="column-2">`r get_indicator4("A candidatura", paste0(Tasa_Votos_candidatura, "%"), Votos_candidatura)`</div>
  <div class="column-2">`r get_indicator4("En blanco", paste0(Tasa_Votos_blanco, "%"), Votos_blanco)`</div>
</div>
</div>


<div class="row" style="margin-top: 10px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

