---
title: ''
params:
  id_municipio: 35003
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicators/POBLACION
  url.afil_r: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000037/~latest.json?dim=LUGAR_RESIDENCIA:35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901&lang=es
  url.piramide_r: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000042/~latest.json?lang=es
  url.afil_ae_r_0: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000032/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:ES70&lang=es
  url.afil_ae_r_08: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000033/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:35004|35010|35018|35024|35028|35029|35034&lang=es
  url.afil_ae_r_04: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000061/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:35003|35007|35014|35015|35017|35030&lang=es
  url.afil_ae_r_05: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000062/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033&lang=es
  url.afil_ae_r_09: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000063/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052&lang=es
  url.afil_ae_r_06: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000064/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:38002|38003|38021|38036|38049|38050&lang=es
  url.afil_ae_r_07: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000065/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053&lang=es
  url.afil_ae_r_03: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E58015B_000066/~latest.json?dim=SEXO:M|F:SITUACION_EMPLEO:_T:LUGAR_RESIDENCIA:38013_2007|38048|38901&lang=es
  url.parados: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E59021A_000008/~latest.json?&lang=es
  url.paro_se: https://datos.canarias.es/api/estadisticas/statistical-resources/v1.0/datasets/ISTAC/E59021A_000009/~latest.json?dim=SEXO:M|F:TERRITORIO:ES70|35004|35010|35018|35024|35028|35029|35034|35003|35007|35014|35015|35017|35030|35001|35002|35005|35006|35008|35009|35011|35012|35013|35016|35019|35020|35021|35022|35023|35025|35026|35027|35031|35032|35033|38001|38004|38005|38006|38010|38011|38012|38015|38017|38018|38019|38020|38022|38023|38025|38026|38028|38031|38032|38034|38035|38038|38039|38040|38041|38042|38043|38044|38046|38051|38052|38002|38003|38021|38036|38049|38050|38007|38008|38009|38014|38016|38024|38027|38029|38030|38033|38037|38045|38047|38053|38013_2007|38048|38901:ACTIVIDAD_ECONOMICA:A4_01|A4_02|A4_03|A21_07|A21_09|A4_04_O&lang=es
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
    # self_contained: false
    # lib_dir: libs
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr", "reshape2", "kableExtra")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)
```

```{r funciones, include=FALSE}
signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

"%notin%" <- Negate("%in%")

get_nombre <- function(nombre) {
  string_list <- str_split(nombre, pattern = " ")[[1]]
  result <- ""
  line.char <- 0
  for(word.index in 1:length(string_list)) {
    if((line.char + nchar(string_list[word.index])) < 17) {
      result <- paste0(result, " ", string_list[word.index])
      line.char <- line.char + 1 + nchar(string_list[word.index])
    } else {
      result <- paste0(result, "<br>", string_list[word.index])
      line.char <- nchar(string_list[word.index])
    }
  }
  trimws(result)
}
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = if_else(substring(id, 0,5) == "38013",  "38013", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios} 
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Pinar de El Hierro, El", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla", "San Sebastián de la Gomera", "Santa Cruz de la Palma")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla", "San Sebastián de La Gomera", "Santa Cruz de La Palma")

recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
# Frontera
recode_Frontera <- function(df) {
  df_f <- rbind(df %>% filter(ano %in% c(2008:max(ano)) & mun == "38013_1912"),
                df %>% filter(ano %in% c(2000:2007) & mun == "38013_2007"))
  df <- df %>% anti_join(df_f)
}

recode_id_Frontera <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = c("38013_1912", "38013_2007"), to = c("38013", "38013"))
  df[,colname]
}
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')
df_localizacion <- filter(df_localizacion, mun != "38013_1912")
df_localizacion$mun <- recode_id_Frontera(df_localizacion, 'mun')
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance

distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1,]
}
```


<!-- HTML -->
<body style="height: 1391px;">

<h3 style="color: #008BD0; margin: 0; text-align: right; margin: 10px 10px 5px;">`r municipio_actual$municipio` en cifras</h3>

```{r Mes residencia}
data_afil_r <- fromJSON(params$url.afil_r)
mes_or <- levels(ordered(data_afil_r[["metadata"]][["temporalCoverages"]][["item"]][["id"]]))
mes <- data.frame(code = mes_or) %>%
  filter(substring(code, 6,8) %in% c("M03", "M06", "M09", "M12")) %>%
  mutate(periodo = code) %>%
  transform(periodo = gsub("-M03", " Marzo", periodo)) %>%
  transform(periodo = gsub("-M06", " Junio", periodo)) %>%
  transform(periodo = gsub("-M09", " Septiembre", periodo)) %>%
  transform(periodo = gsub("-M12", " Diciembre", periodo)) %>%
  transform(code = gsub("M", "", code)) %>%
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1))))

mes <- mes %>%
  mutate(order = as.integer(order(mes$code, decreasing = FALSE)))
mes_actual <- mes %>% filter(code == max(mes$code))
```

```{r Gráfico evolución de las afiliaciones según residencia}
df_r_afil <- data.frame(
  mun = rep(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
            each = length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                   length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                   length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                   length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_sl = rep(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
              each = length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                     length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                     length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  periodo = rep(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                each = length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                       length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_nacionalidad = rep(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
                        each = length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_sexo =  rep(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
                 times = length(data_afil_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(data_afil_r[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_r_afil <- df_r_afil %>%
  filter(substring(periodo, 5,8) %in% c("-M03", "-M06", "-M09", "-M12") & substring(mun, 0,2) != "ES")

df_r_sl <- data.frame(
  id_sl = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[2]][["id"]],
  sl = vector(mode = "character", length = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][2]))

for(i in 1:nrow(df_r_sl)) {
  df_r_sl$sl[i] <- data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[2]][["name"]][["text"]][[i]][["value"]]
}

df_r_nacionalidad <- data.frame(
  id_nacionalidad = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  nacionalidad = vector(mode = "character", length = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))

for(i in 1:nrow(df_r_nacionalidad)) {
  df_r_nacionalidad$nacionalidad[i] <- data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}

df_r_sexo <- data.frame(
  id_sexo = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[5]][["id"]],
  sexo = vector(mode = "character", length = data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][5]))

for(i in 1:nrow(df_r_sexo)) {
  df_r_sexo$sexo[i] <- data_afil_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[5]][["name"]][["text"]][[i]][["value"]]
}

df_r_afil <- df_r_afil %>%
  right_join(df_r_sl, by = "id_sl") %>%
  right_join(df_r_sexo, by = "id_sexo") %>%
  right_join(df_r_nacionalidad, by = "id_nacionalidad") %>%
  transform(periodo = gsub("M", "", periodo)) %>%
  select(c(mun, periodo, sl, nacionalidad, sexo, valor))
df_r_afil$valor <- df_r_afil$valor %>% as.numeric
df_r_afil$mun <- recode_id_Frontera(df_r_afil, 'mun')

df_r_u <- df_r_afil %>% filter(sl == "Total" & sexo == "Total" & nacionalidad == "Total") %>%
  select(mun, periodo, valor) %>% arrange(periodo)

related_mun <- df_r_u %>% filter(periodo == mes_actual$code)
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

g_line_r_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)

df_r <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_r_u, by = "mun") %>%
  select(id = mun, periodo, nombre, valor) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(mun = id, code = periodo, nombre, valor) %>%
  left_join(mes, by = "code") %>%
  transform(tasa = ifelse(substring(code, 0,4) != min(substring(code, 0,4)), round(100*((valor / lag(valor, n = 4)) - 1), 1), NA)) %>% 
  filter(order < mes_actual$order+1)

ano_min_r <- min(as.integer(substring(df_r$code, 0,4)))
I_periodo_r <- df_r[nrow(df_r) - 5*4,]$code
x_I_periodo_r <- df_r[nrow(df_r) - 5*4 + 1,]$code
ano_max_r <- max(as.integer(substring(df_r$code, 0,4)))
x_max_periodo_r <- df_r[nrow(df_r) - 1,]$code
I_Afil_num <- df_r %>% filter(code == I_periodo_r & mun == params$id_municipio) %>% select(valor) %>% as.numeric
df_r_lv <- df_r %>% filter(code == mes_actual$code & mun == params$id_municipio)
Num_Afil_num <- df_r_lv$valor %>% as.numeric
I_Afil <- I_Afil_num %>% format(big.mark = ".", decimal.mark = ",") %>% as.character
Num_Afil <- Num_Afil_num %>% format(big.mark = ".", decimal.mark = ",") %>% as.character

df_r <- df_r %>%
  transform(hovertext = paste0(
    "<b>", nombre, "</b><br>Afiliaciones: ", ifelse(is.na(valor), " -", trimws(format(valor, big.mark = ".", decimal.mark = ","))),
    "<br>Tasa de variación: ", ifelse(is.na(tasa), " -", paste0(trimws(format(tasa, big.mark = ".", decimal.mark = ",")), "%"))))

g_line_r <- ggplot(data = df_r, aes(x = code, y = valor, group = nombre, colour = nombre, text = hovertext)) +
  geom_line() +
  geom_text(aes(x = x_I_periodo_r, y = (0.92*I_Afil_num), label = I_Afil, colour = '#000000'), size = 3.5) +
  geom_text(aes(x = x_max_periodo_r, y = (0.94*Num_Afil_num), label = Num_Afil, colour = '#000000'), size = 3.5) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_r_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_discrete(breaks = function(x){paste0(ano_min_r:ano_max_r, "-03")}, labels = function(x){substr(x, 0,4)}) +
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line_r <- ggplotly(g_line_r, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"), list("pan2d"), list("resetScale2d"), list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(1, nrow(df_r[df_r$nombre == municipio_actual$municipio, ]) - 5*4), nrow(df_r[df_r$nombre == municipio_actual$municipio, ])))) %>%
  style(hoverinfo = "skip", traces = c(2, 3))
```

```{r Pirámide afiliaciones según residencia por edad y sexo}
piramide_r <- fromJSON(params$url.piramide_r)
df_r_piramide_ <- data.frame(
  id_sexo = rep(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                each = length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                       length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  periodo = rep(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                each = length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_gredad = rep(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                  each = length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  mun =  rep(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
             times = length(piramide_r[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(piramide_r[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_r_edad <- data.frame(
  id_gredad = piramide_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["id"]],
  gredad = vector(mode = "character", length = piramide_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]))

for(i in 1:nrow(df_r_edad)) {
  df_r_edad$gredad[i] <- piramide_r[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["name"]][["text"]][[i]][["value"]]
}
df_r_edad <- df_r_edad %>%
  transform(gredad = gsub("Menor de 20 años", "<20", gredad)) %>%
  transform(gredad = gsub("60 años o más", ">59", gredad)) %>%
  transform(gredad = gsub("De ", "", gredad)) %>%
  transform(gredad = gsub(" a ", "-", gredad)) %>%
  transform(gredad = gsub(" años", "", gredad))

df_r_piramide <- df_r_piramide_ %>%
  right_join(df_r_edad, by = "id_gredad") %>%
  right_join(df_r_sexo, by = "id_sexo") %>%
  transform(periodo = gsub("M", "", periodo)) %>%
  select(c(mun, periodo, gredad, sexo, valor))
df_r_piramide$valor <- df_r_piramide$valor %>% as.numeric
df_r_piramide$mun <- recode_id_Frontera(df_r_piramide, 'mun')

Num_Afil_Canarias <- df_r_piramide %>% filter(mun == "ES70" & periodo == mes_actual$code & gredad == "Total" & sexo == "Total") %>%
  select(valor) %>% as.numeric
```

```{r Barras afiliaciones actividades económicas por sexo}
data_afil_r_ae_C <- fromJSON(params$url.afil_ae_r_0)
df_r_afil_ae_C_ <- data.frame(
  periodo = rep(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                each = length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                       length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                       length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_sexo = rep(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                each = length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                       length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  sl = rep(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
           each = length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                  length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_ae = rep(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
              each = length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  mun =  rep(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
             times = length(data_afil_r_ae_C[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(data_afil_r_ae_C[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_r_ae_C <- data.frame(
  id_ae = data_afil_r_ae_C[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  name_ae = vector(mode = "character", length = data_afil_r_ae_C[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))

for(i in 1:nrow(df_r_ae_C)) {
  df_r_ae_C$name_ae[i] <- data_afil_r_ae_C[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}

df_ae <- read.csv2("../CL_CNAE.csv", encoding = "UTF-8", sep = ",") %>% select(!name_ae)

df_r_ae_C <- df_r_ae_C %>% inner_join(df_ae, by = "id_ae")

df_r_afil_ae_C <- df_r_afil_ae_C_ %>%
  right_join(df_r_ae_C, by = "id_ae") %>%
  right_join(df_r_sexo, by = "id_sexo") %>%
  select(c(mun, periodo, ae, sexo, valor))

if(substring(municipio_actual$id_isla, 4,5) == "08"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_08)
}
if(substring(municipio_actual$id_isla, 4,5) == "04"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_04)
}
if(substring(municipio_actual$id_isla, 4,5) == "05"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_05)
}
if(substring(municipio_actual$id_isla, 4,5) == "09"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_09)
}
if(substring(municipio_actual$id_isla, 4,5) == "06"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_06)
}
if(substring(municipio_actual$id_isla, 4,5) == "07"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_07)
}
if(substring(municipio_actual$id_isla, 4,5) == "03"){
  data_afil_r_ae <- fromJSON(params$url.afil_ae_r_03)
}

df_r_afil_ae_ <- data.frame(
  periodo = rep(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                each = length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                       length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                       length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_sexo = rep(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                each = length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                       length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  sl = rep(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
           each = length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]]) *
                  length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  id_ae = rep(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
              each = length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]])),
  mun =  rep(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[5]][["code"]],
             times = length(data_afil_r_ae[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(data_afil_r_ae[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_r_ae <- data.frame(
  id_ae = data_afil_r_ae[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  name_ae = vector(mode = "character", length = data_afil_r_ae[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))

for(i in 1:nrow(df_r_ae)) {
  df_r_ae$name_ae[i] <- data_afil_r_ae[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}

df_r_ae <- df_r_ae %>% inner_join(df_ae, by = "id_ae")

df_r_afil_ae <- df_r_afil_ae_ %>%
  right_join(df_r_ae, by = "id_ae") %>%
  right_join(df_r_sexo, by = "id_sexo") %>%
  select(c(mun, periodo, ae, sexo, valor))

df_r_afil_ae <- df_r_afil_ae %>%
  rbind(df_r_afil_ae_C) %>%
  transform(periodo = gsub("M", "", periodo))
df_r_afil_ae$valor <- df_r_afil_ae$valor %>% as.numeric
df_r_afil_ae$mun <- recode_id_Frontera(df_r_afil_ae, 'mun')

df_r_afil_ae_sexo_mun_ <- df_r_afil_ae %>%
  filter(mun == params$id_municipio & ae != "Total" & periodo == mes_actual$code) %>%
  select(ae, sexo, valor)
df_r_afil_ae_sexo_mun <- acast(df_r_afil_ae_sexo_mun_, ae ~ sexo, sum)
df_r_afil_ae_sexo_mun <- df_r_afil_ae_sexo_mun %>% 
  melt(id.var = "ae")
colnames(df_r_afil_ae_sexo_mun) <- c("ae", "sexo", "valor")

df_r_afil_Canarias_ <- df_r_afil_ae %>%
  filter(mun == "ES70" & ae != "Total" & periodo == mes_actual$code) %>% 
  select(ae, sexo, valor)
df_r_afil_Canarias <- acast(df_r_afil_Canarias_, ae ~ sexo, sum)
df_r_afil_Canarias <- df_r_afil_Canarias %>% 
  melt(id.var = "ae")
colnames(df_r_afil_Canarias) <- c("ae", "sexo", "valor")

df_r_afil_ae_sexo_mun <- df_r_afil_ae_sexo_mun %>% 
  mutate(porcentaje = df_r_afil_ae_sexo_mun$valor / Num_Afil_num * 100,
         valor_Canarias = df_r_afil_Canarias$valor, 
         porcentaje_Canarias = df_r_afil_Canarias$valor / Num_Afil_Canarias * 100) %>%
  transform(porcentaje = if_else(sexo == "Hombres", -porcentaje, porcentaje),
            porcentaje_Canarias = if_else(sexo == "Hombres", -porcentaje_Canarias, porcentaje_Canarias))

df_r_afil_ae_sexo_mun <- df_r_afil_ae_sexo_mun %>%
  transform(hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", trimws(ae), "</b><br>"), ""),
    "<br><b>", sexo, "</b>",
    "<br>",trimws(format(valor, big.mark = ".", decimal.mark = ",")), 
    " (", trimws(format(round(abs(porcentaje), 1), big.mark = ".", decimal.mark = ",")), "%)",
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
    " (", trimws(format(round(abs(porcentaje_Canarias), 1), big.mark = ".", decimal.mark = ",")), "%)"))
df_r_afil_ae_sexo_mun$ae <- ordered(df_r_afil_ae_sexo_mun$ae, levels = df_r_afil_ae_sexo_mun$ae[6:1])
df_r_afil_ae_sexo_mun <- df_r_afil_ae_sexo_mun %>% mutate(ae = recode(ae,  "Resto de servicios" = "Resto de<br>servicios"))

g_r_afil_ae_sexo_mun <- ggplot(df_r_afil_ae_sexo_mun, aes(x = ae, fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.99, position = position_stack(reverse = TRUE), aes(y = porcentaje)) +
  geom_bar(stat = "identity", color = "#59656E", alpha = 0, width = 0.99, size = 0.4, aes(y = porcentaje_Canarias, text = "")) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(n.breaks = 5, labels = function(x){paste0(format(abs(x), big.mark = '.', decimal.mark = ","), '%')},
                     limits = c(-1, 1)*max(abs(df_r_afil_ae_sexo_mun$porcentaje), abs(df_r_afil_ae_sexo_mun$porcentaje_Canarias)))

g_r_afil_ae_sexo_mun <- ggplotly(g_r_afil_ae_sexo_mun, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(t = 0, l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Afil_residencia, results='asis'}
tb_periodos <- df_r %>%
  filter(order > max(df_r$order) - 8) %>%
  select(code)

tb_res <- df_r %>%
  filter(code %in% tb_periodos$code)

df_r_afil_sexo <- df_r_afil %>%
  filter(mun == params$id_municipio & sl == "Total" & sexo != "Total" & periodo %in% tb_periodos$code & nacionalidad == "Total") %>%
  acast(periodo ~ sexo, value.var = 'valor')
df_r_afil_sexo <- df_r_afil_sexo %>%
  data.frame(code = rownames(df_r_afil_sexo))

tb_res <- tb_res %>%
  left_join(df_r_afil_sexo, 'code') %>%
  arrange(desc(code)) %>%
  mutate(valor = ifelse(is.na(valor), " -", paste0(format(valor, big.mark = ".", decimal.mark = ","))),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")),
         Mujeres = ifelse(is.na(Mujeres), " -", paste0(format(Mujeres, big.mark = ".", decimal.mark = ","))),
         Hombres = ifelse(is.na(Hombres), " -", paste0(format(Hombres, big.mark = ".", decimal.mark = ",")))) %>%
  select('Periodo' = code, 'Afiliaciones' = valor, 'Tasa de variación' = tasa, 'Mujeres', 'Hombres')

tb_res <- tb_res %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left", bootstrap_options = 'responsive') %>%
  column_spec(2:5, width = "22%")
```

```{r Residencia actividades económicas, results='asis'}
df_r_afil_ae_sexo_mun <- df_r_afil_ae_sexo_mun %>% mutate(ae = recode(ae,  "Resto de<br>servicios" = "Resto de servicios"))

tb_res_ae <- df_r_afil_ae_sexo_mun %>%
  acast(ae ~ sexo, value.var = 'valor')
tb_res_ae <- as.data.frame(tb_res_ae[nrow(tb_res_ae):1,]) %>%
  rownames_to_column %>%
  mutate(Total = Mujeres + Hombres) %>%
  mutate(Mujeres = ifelse(is.na(Mujeres), " -", paste0(format(Mujeres, big.mark = ".", decimal.mark = ","))),
         Hombres = ifelse(is.na(Hombres), " -", paste0(format(Hombres, big.mark = ".", decimal.mark = ","))),
         Total = ifelse(is.na(Total), " -", paste0(format(Total, big.mark = ".", decimal.mark = ",")))) %>%
  select('Actividades económicas' = rowname, 'Mujeres', 'Hombres', 'Total')

tb_res_ae <- tb_res_ae %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  column_spec(2:4, width = "20%")
```

<div class="highlight" style="width: 100% !important; margin: 15px 5px;">
<h2 style="color: #005980; margin-left: 20px;">Afiliaciones según el lugar de residencia</h2>

<div class="row">
  <div class="column-2">`r tb_res`</div>

  <div class="column-2" style="height: 340px;">`r g_line_r`</div>
</div>

<div class="row" style="margin-top: 20px">
  <div class="column-2">`r tb_res_ae`</div>

  <div class="column-2" style="height: 290px;">`r g_r_afil_ae_sexo_mun`</div>
</div>

<div class="row">
  <div class="column-2"></div>
  <div class="column-2">
<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Mujeres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-C'></div><div class='sp-content'>Canarias</div></div>
  </div>
</div>
</div>
</div>


```{r Mes paro}
parados <- fromJSON(params$url.parados)
mes_or_p <- levels(ordered(parados[["metadata"]][["temporalCoverages"]][["item"]][["id"]]))
mes_p <- data.frame(code = mes_or_p) %>%
  mutate(periodo = paste0(substring(code, 0,4), substring(code, 5,8))) %>%
  transform(periodo = gsub("-M01", " Enero", periodo)) %>%
  transform(periodo = gsub("-M02", " Febrero", periodo)) %>%
  transform(periodo = gsub("-M03", " Marzo", periodo)) %>%
  transform(periodo = gsub("-M04", " Abril", periodo)) %>%
  transform(periodo = gsub("-M05", " Mayo", periodo)) %>%
  transform(periodo = gsub("-M06", " Junio", periodo)) %>%
  transform(periodo = gsub("-M07", " Julio", periodo)) %>%
  transform(periodo = gsub("-M08", " Agosto", periodo)) %>%
  transform(periodo = gsub("-M09", " Septiembre", periodo)) %>%
  transform(periodo = gsub("-M10", " Octubre", periodo)) %>%
  transform(periodo = gsub("-M11", " Noviembre", periodo)) %>%
  transform(periodo = gsub("-M12", " Diciembre", periodo)) %>%
  transform(code = gsub("M", "", code)) %>%
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1))))

mes_p <- mes_p %>%
  mutate(order = as.integer(order(mes_p$code, decreasing = FALSE)))
mes_actual_p <- mes_p %>% filter(code == max(mes_p$code))
```

```{r Gráfico evolución de la población parada}
df_parados <- data.frame(
  periodo = rep(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
                each = length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                       length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  mun = rep(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
            each = length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                   length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_sexo = rep(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
                each = length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_gredad = rep(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
                  times = length(parados[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(parados[["data"]][["observations"]], split = " | ", fixed = TRUE)))

df_edad <- data.frame(
  id_gredad = parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  gredad = vector(mode = "character", length = parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))

for(i in 1:nrow(df_edad)) {
  df_edad$gredad[i] <- parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}
df_edad <- df_edad %>%
  transform(gredad = gsub("De ", "", gredad)) %>%
  transform(gredad = gsub(" años", "", gredad)) %>%
  transform(gredad = gsub(" a ", "-", gredad))

df_sexo <- data.frame(
  id_sexo = parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["id"]],
  sexo = vector(mode = "character", length = parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][3]))

for(i in 1:nrow(df_sexo)) {
  df_sexo$sexo[i] <- parados[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[3]][["name"]][["text"]][[i]][["value"]]
}

df_parados <- df_parados %>%
  right_join(df_edad, by = "id_gredad") %>%
  right_join(df_sexo, by = "id_sexo") %>%
  transform(periodo = gsub("M", "", periodo)) %>%
  select(!c(id_gredad, id_sexo))
df_parados$valor <- df_parados$valor %>% as.numeric
df_parados$mun <- recode_id_Frontera(df_parados, 'mun')

Num_Paro_Canarias <- df_parados %>% filter(mun == "ES70" & periodo == mes_actual_p$code & gredad == "Total" & sexo == "Total") %>% select(valor) %>% as.numeric

df_u <- df_parados %>% filter(substring(mun, 0,2) != "ES" & gredad == "Total" & sexo == "Total") %>%
  select(mun, periodo, valor) %>%
  arrange(periodo)

ano_max <- max(substring(df_u$periodo, 0,4)) %>% as.numeric
ano_min <- min(substring(df_u$periodo, 0,4)) %>% as.numeric

related_mun <- df_u %>% filter(periodo == mes_actual_p$code)
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')
if(related_mun$mun[1] != params$id_municipio) {stop("Error: indicador principal desconocido")}

df_p <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, code = periodo, nombre, valor) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(mun = id, code, nombre, valor) %>%
  left_join(mes_p, by = "code") %>%
  transform(tasa = ifelse(substring(code, 0,4) != min(substring(code, 0,4)), round(100*((valor / lag(valor, n = 12)) - 1), 1), NA)) %>%
  filter(order < mes_actual_p$order+1)

df_p <- df_p %>%
  transform(hovertext = paste0(
    "<b>", nombre, "</b><br>Personas en paro: ", ifelse(is.na(valor), " -", trimws(format(valor, big.mark = ".", decimal.mark = ","))),
    "<br>Tasa de variación: ", ifelse(is.na(tasa), " -", paste0(trimws(format(round(tasa, 1), big.mark = ".", decimal.mark = ",")), "%"))))

g_line_p_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)

line_range_min <- max(1, nrow(df_p[df_p$nombre == municipio_actual$municipio, ]) - 5*12)
line_range_max <- nrow(df_p[df_p$nombre == municipio_actual$municipio, ])
I_Paro_num <- df_p %>% filter(order == line_range_min) %>% select(valor) %>% as.numeric
I_Paro <- I_Paro_num %>% format(big.mark = ".", decimal.mark = ",")
Num_Paro_num <- df_p %>% filter(code == mes_actual_p$code) %>% select(valor) %>% as.numeric
Num_Paro <- Num_Paro_num %>% format(big.mark = ".", decimal.mark = ",")

g_line_p <- ggplot(data = df_p, aes(x = code, y = valor, group = nombre, colour = nombre, text = hovertext)) +
  geom_line() +
  geom_text(aes(x = line_range_min, y = (0.92*I_Paro_num), label = I_Paro, colour = '#000000'), size = 3.5, nudge_x = 2) +
  geom_text(aes(x = line_range_max, y = (0.94*Num_Paro_num), label = Num_Paro, colour = '#000000'), size = 3.5, nudge_x = -2) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_p_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1)) +
  scale_x_discrete(breaks = function(x){ paste0(ano_min:ano_max, "-01") }, labels = function(x){substr(x, 0, 4) }) +
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line_p <- ggplotly(g_line_p, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"), list("pan2d"), list("resetScale2d"), list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(line_range_min, line_range_max))) %>%
  style(hoverinfo = "skip", traces = c(2, 3))
```

```{r Barras Paro por sectores económicos y sexo}
data_paro_se <- fromJSON(params$url.paro_se)

df_paro_se <- data.frame(
  id_sexo = rep(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[1]][["code"]],
             each = length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]]) *
                    length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                    length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  periodo = rep(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]],
                each = length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]]) *
                       length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  mun = rep(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[3]][["code"]],
            each = length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]])),
  id_ae = rep(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[4]][["code"]],
              times = length(data_paro_se[["data"]][["dimensions"]][["dimension"]][["representations"]][["representation"]][[2]][["code"]])),
  valor = unlist(strsplit(data_paro_se[["data"]][["observations"]], split = " | ", fixed = TRUE)))
df_paro_se$valor <- as.numeric(df_paro_se$valor)
df_paro_se$mun <- recode_id_Frontera(df_paro_se, 'mun')

df_ae_p <- data.frame(
  id_ae = data_paro_se[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["id"]],
  ae = vector(mode = "character", length = data_paro_se[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]),
  name_ae = vector(mode = "character", length = data_paro_se[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["total"]][4]))

for(i in 1:nrow(df_ae_p)) {
  df_ae_p$ae[i] <- data_paro_se[["metadata"]][["dimensions"]][["dimension"]][["dimensionValues"]][["value"]][[4]][["name"]][["text"]][[i]][["value"]]
}
df_ae_p <- df_ae_p %>%
  transform(ae = lapply(strsplit(ae, " "), '[[', 1)) %>%
  transform(ae = gsub(",", "", ae)) %>%
  transform(ae = gsub("Resto", "Resto de servicios", ae))
for(i in 1:nrow(df_ae_p)) {
  df_ae_p$name_ae[i] <- get_nombre(paste0(df_ae_p$ae[i]))
}

df_paro_se <- df_paro_se %>%
  right_join(df_sexo, by = "id_sexo") %>%
  right_join(df_ae_p, by = "id_ae") %>%
  transform(periodo = gsub("M", "", periodo)) %>%
  select(!c(id_sexo, id_ae))

df_paro_se_mun <- df_paro_se %>%
  filter(mun == params$id_municipio & periodo == mes_actual$code & ae != "Total" & sexo != "Total") %>% select(!c(mun, periodo))
df_paro_Canarias <- df_paro_se %>%
  filter(mun == "ES70" & periodo == mes_actual$code & ae != "Total" & sexo != "Total") %>% select(!c(mun, periodo))
df_paro_se_mun <- df_paro_se_mun %>%
  mutate(porcentaje = df_paro_se_mun$valor / Num_Paro_num * 100,
         valor_Canarias = df_paro_Canarias$valor,
         porcentaje_Canarias = df_paro_Canarias$valor / Num_Paro_Canarias * 100) %>%
  transform(porcentaje = if_else(sexo == "Hombres", -porcentaje, porcentaje),
            porcentaje_Canarias = if_else(sexo == "Hombres", -porcentaje_Canarias, porcentaje_Canarias))

df_paro_se_mun <- df_paro_se_mun %>%
  transform(hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", trimws(ae), "</b><br>"), ""),
    "<br><b>", sexo, "</b><br>",
    trimws(format(valor, big.mark = ".", decimal.mark = ",")), 
    " (", trimws(format(round(abs(porcentaje), 1), big.mark = ".", decimal.mark = ",")), "%)<br>",
    "Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
    " (", trimws(format(round(abs(porcentaje_Canarias), 1), big.mark = ".", decimal.mark = ",")), "%)"))

df_paro_se_mun$ae <- ordered(df_paro_se_mun$ae, levels = df_paro_se_mun$ae[6:1])
df_paro_se_mun$name_ae <- ordered(df_paro_se_mun$name_ae, levels = df_paro_se_mun$name_ae[6:1])

g_paro_se <- ggplot(data = df_paro_se_mun, aes(x = name_ae, fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.99, position = position_stack(reverse = TRUE), aes(y = porcentaje)) +
  geom_bar(stat = "identity", color = "#59656E", alpha = 0, width = 0.99, size = 0.4, aes(y = porcentaje_Canarias, text = "")) +
  coord_flip() +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(labels = function(x){paste0(format(abs(x), big.mark = '.', decimal.mark = ","), '%')},
                     limits = c(-1, 1)*max(abs(df_paro_se_mun$porcentaje), abs(df_paro_se_mun$porcentaje_Canarias)))

g_paro_se <- ggplotly(g_paro_se, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(t = 10, l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Paro_registrado, results='asis'}
tb_periodos <- df_p %>%
  filter(order > max(df_p$order) - 8) %>%
  select(code)

tb_p <- df_p %>%
  filter(code %in% tb_periodos$code)

df_paro_sexo <- df_parados %>%
  filter(mun == params$id_municipio & gredad == "Total" & sexo != "Total" & periodo %in% tb_periodos$code) %>%
  acast(periodo ~ sexo, value.var = 'valor')
df_paro_sexo <- df_paro_sexo %>%
  data.frame(code = rownames(df_paro_sexo))

tb_p <- tb_p %>%
  left_join(df_paro_sexo, 'code') %>%
  arrange(desc(code)) %>%
  mutate(valor = ifelse(is.na(valor), " -", paste0(format(valor, big.mark = ".", decimal.mark = ","))),
         tasa = ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")),
         Mujeres = ifelse(is.na(Mujeres), " -", paste0(format(Mujeres, big.mark = ".", decimal.mark = ","))),
         Hombres = ifelse(is.na(Hombres), " -", paste0(format(Hombres, big.mark = ".", decimal.mark = ",")))) %>%
  select('Periodo' = code, 'Personas en paro' = valor, 'Tasa de variación' = tasa, 'Mujeres', 'Hombres')

tb_p <- tb_p %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  column_spec(2:5, width = "22%")
```

```{r Paro actividades económicas, results='asis'}
tb_ae_p <- df_paro_se_mun %>%
  acast(ae ~ sexo, value.var = 'valor')
tb_ae_p <- as.data.frame(tb_ae_p[nrow(tb_ae_p):1,]) %>%
  rownames_to_column %>%
  mutate(Total = Mujeres + Hombres) %>%
  mutate(Mujeres = ifelse(is.na(Mujeres), " -", paste0(format(Mujeres, big.mark = ".", decimal.mark = ","))),
         Hombres = ifelse(is.na(Hombres), " -", paste0(format(Hombres, big.mark = ".", decimal.mark = ","))),
         Total = ifelse(is.na(Total), " -", paste0(format(Total, big.mark = ".", decimal.mark = ",")))) %>%
  select('Actividades económicas' = rowname, 'Mujeres', 'Hombres', 'Total')

tb_ae_p <- tb_ae_p %>%
  kable(format = 'html', align = 'c', table.attr = "class=\"my-table-2\"") %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  column_spec(2:4, width = "20%")
```

<div class="highlight" style="width: 100% !important; margin: 15px 5px;">
<h2 style="color: #005980; margin-left: 20px;">Paro registrado</h2>

<div class="row">
  <div class="column-2">`r tb_p`</div>

  <div class="column-2" style="height: 340px;">`r g_line_p`</div>
</div>

</div>

