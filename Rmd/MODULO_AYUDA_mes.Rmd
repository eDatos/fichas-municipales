---
title: ''
params:
  año: 2021
  mes: 3
  trimestre: 1
  id_municipio: 35024
  url.mes: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/9de5166a-c9d0-4e56-bf73-42a6e07f5a97
  url.cl_area: https://datos.canarias.es/api/estadisticas/structural-resources/v1.0/codelists/ISTAC/CL_AREA_ES70_COMARCAS/01.000/codes
  url.mapa: https://datos.canarias.es/catalogos/estadisticas/dataset/6dd8baf4-14f4-43a3-88b2-984d034c965c/resource/812f22ae-62a5-4cea-8052-b0269b1bd491/download/municipios_20170101.json
  url.dist_mun: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/6daf4220-c08f-431c-8383-a0a7daa87da7
  url.parados: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/9de5166a-c9d0-4e56-bf73-42a6e07f5a97/data?representation=MEASURE%5BABSOLUTE%7CANNUAL_PERCENTAGE_RATE%7CANNUAL_PUNTUAL_RATE%5D&granularity=GEOGRAPHICAL%5BMUNICIPALITIES%5D
  url.ind_paro_M: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/1b3dffb7-faa4-4b41-931b-68d7d384c706/data?representation=MEASURE%5BABSOLUTE%5D
  url.ind_paro_H: https://datos.canarias.es/api/estadisticas/indicators/v1.0/indicatorsSystems/C00067A/indicatorsInstances/68af63ed-db2b-4825-96be-69d94df6469f/data?representation=MEASURE%5BABSOLUTE%5D
  url.piramide_paro: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=abc2a458-df6a-41eb-bc66-661b6e5c70fb
  url.paro_se: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=7c423bf5-3b26-4e21-aca3-f3745d461ec2
  url.paro_sexo_est: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=4aa1f89e-bc23-4b31-97a9-55a95fea782f
  url.afil_r: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=ffd9beb1-b9f0-477c-9a44-480397986f84
  url.viajeros_lugar: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=d7482433-d3db-4228-bbf0-0196a02d0f48
  url.aloj_isla: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=b4de650c-10d8-4202-b678-58f597b1b040
  url.hotel: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=2457b2ce-c6c1-46d5-9c85-59cd4b9b076d
  url.extrahoteleros: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=76147e33-158b-4df0-ac5d-447de68ad3ef
  url.GM_sexo_edad: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=948e02fd-4d75-4a06-9d40-48acd5fd4556
  url.GM_sl: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=42f1c94f-5732-4e38-9583-39258ff8f5bf
  url.GM_ni: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=b8a748fa-26de-46da-a276-5d4a2e97d740
  url.GM_ne: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=ac3a3368-b6b5-4c63-aa23-19ed2261ed1d
  url.GM_ta: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=9ea1e03b-3ce2-404e-b289-e7d6d7894575
  url.GM_np: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=a6a6170b-1ac2-4393-a1d7-6ba04452c333
  url.GM_pt: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=70840a10-9dc8-409e-bf67-1099f6629093
  url.GM_pais: http://www.gobiernodecanarias.org/istac/jaxi-istac/tabla.do?accion=jsonMtd&uuidConsulta=7f56ab7b-ac57-4e2d-9b8a-02fa434cfbd6
output:
  html_document:
    df_print: paged
    css: styles/FICHA.css
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, error=FALSE)
```

```{r librerías, include=FALSE}
# Lista de los paquetes de R que se deben cargar si no lo están ya.
list.of.packages <- c("jsonlite", "ggplot2", "knitr", "data.table", "plotly", "plyr", "dplyr", "scales", "htmlwidgets", "sf", "fuzzyjoin", "xml2", "XML", "tidyverse", "tmap", "magrittr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, character.only = TRUE)
```

```{r funciones, include=FALSE}
# Designar el signo de un valor:
signo <- function(value) {
  if (value > 0){sign <- "más"} else {sign <- "menos"}
  return(sign)
}

# No incluido:
"%notin%" <- Negate("%in%")

# Para separar nombres largos en varias líneas:
get_nombre <- function(nombre) {
  string_list <- str_split(nombre, pattern = " ")[[1]]
  result <- ""
  line.char <- 0
  for(word.index in 1:length(string_list)) {
    if((line.char + nchar(string_list[word.index])) < 17) {
      result <- paste0(result, " ", string_list[word.index])
      line.char <- line.char + 1 + nchar(string_list[word.index])
    } else {
      result <- paste0(result, "<br>", string_list[word.index])
      line.char <- nchar(string_list[word.index])
    }
  }
  trimws(result)
}
```

```{r Mes}
data_mes <- fromJSON(params$url.mes)

# DF con los meses y sus códigos.
mes <- data.frame(code = data_mes[["dimension"]][["TIME"]][["representation"]][["code"]],
                  periodo = data_mes[["dimension"]][["TIME"]][["representation"]][["title"]][["es"]])

# DF incluyendo como debe aparecer el mes escrito en la ficha y el orden para construir la serie.
mes <- mes %>% 
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " ", unlist(lapply(strsplit(periodo, " "), '[[', 1)))) %>% 
  mutate(order = as.integer(order(mes$code, decreasing = FALSE)))
# Mes que se seleccionó.
mes_actual <- mes %>% filter(substring(code, 0,4) == params$año & as.numeric(substring(code, 7,9)) == params$mes)
```

```{r Municipio actual}
CL_AREA <- as_list(read_xml(params$url.cl_area))

# DF para la clasificación de los municipios por comarca, isla y provincia con sus códigos.
df_CL_AREA <- tibble::as_tibble(CL_AREA) %>% 
  unnest_wider('codes') %>%
  transform(name = lapply(name, '[[', 2)) %>%
  unnest(cols = names(.)) %>%
  unnest(cols = names(.)) %>%
  readr::type_convert() %>%
  mutate(parent = gsub("^.*).", "", parent)) %>%
  select(code = id, value = name, parent)

df_CL_AREA_mun <- df_CL_AREA %>% 
  select(id = code, municipio = value, code = parent) %>%
  filter(substring(id, 0,2) != "ES") %>% 
  transform(id = sub("\\_.*", "", id)) %>%
  filter(nchar(id) > 0 & !grepl("(", municipio, fixed = TRUE)) %>%
  left_join(df_CL_AREA, by="code") %>%
  select(id, municipio, code = parent, id_comarca = code, comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, code = parent, id_gran_comarca = code, gran_comarca = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, code = parent, id_isla = code, isla = value) %>% 
  left_join(df_CL_AREA, by="code") %>% 
  select(id, municipio, id_comarca, comarca, id_gran_comarca, gran_comarca, id_isla, isla, provincia = value)

# Solo para el municipio seleccionado.
municipio_actual <- df_CL_AREA_mun[df_CL_AREA_mun$id == params$id_municipio,]
```

```{r Normalización de municipios}
# Corregir posibles errores en los nombres de todos los municipios canarios.
recode_mun.from <- c("Oliva (La)", "Palmas de Gran Canaria (Las)", "Valsequillo", "Santa María de Guía", "Aldea de San Nicolás (La)", "Santa Lucía", "Pinar de El Hierro (El)", "Fuencaliente", "Llanos de Aridane (Los)", "Paso (El)", "Laguna (La)", "Rosario (El)", "Matanza de Acentejo (La)", "Sauzal (El)", "Victoria de Acentejo (La)", "Silos (Los)", "Tanque (El)", "Guancha (La)", "Orotava (La)", "Realejos (Los)", "San Miguel", "Vilaflor", "Güimar", "Icod de Los Vinos", "Puerto de La Cruz", "San Juan de La Rambla", "La Laguna")
recode_mun.to <- c("La Oliva", "Las Palmas de Gran Canaria", "Valsequillo de Gran Canaria", "Santa María de Guía de Gran Canaria", "La Aldea de San Nicolás", "Santa Lucía de Tirajana", "El Pinar de El Hierro", "Fuencaliente de La Palma", "Los Llanos de Aridane", "El Paso", "San Cristóbal de La Laguna", "El Rosario", "La Matanza de Acentejo", "El Sauzal", "La Victoria de Acentejo", "Los Silos", "El Tanque", "La Guancha", "La Orotava", "Los Realejos", "San Miguel de Abona", "Vilaflor de Chasna", "Güímar", "Icod de los Vinos", "Puerto de la Cruz", "San Juan de la Rambla", "San Cristóbal de La Laguna")

recode_mun <- function(df, colname) {
  df[,colname] = trimws(df[,colname])
  df[,colname] = mapvalues(df[,colname], from = recode_mun.from, to = recode_mun.to)
  df[,colname]
}
```

```{r Mapas}
mapa_Canarias <- st_read(params$url.mapa, quiet = TRUE)

mapa_Canarias <- rbind(
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode != params$id_municipio), col = "0"),
  cbind(filter(mapa_Canarias, mapa_Canarias$geocode == params$id_municipio), col = "1")
) %>% 
  select(-c(notas, utm_x_capi, utm_y_capi, long_capi, lati_capi)) %>%
  st_sf

palette <- c('#8CD2EA', '#005980')
mapa_isla <- filter(mapa_Canarias, mapa_Canarias$gcd_isla == municipio_actual$id_isla)
mapa_comarca <- filter(mapa_Canarias, mapa_Canarias$geocode %in% (df_CL_AREA_mun[df_CL_AREA_mun$id_comarca == municipio_actual$id_comarca,]$id))

mapa_Canarias_plot <- tm_shape(mapa_Canarias) + 
                      tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                      tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA, outer.margins = 0, inner.margins = 0) +
                      tmap_options(check.and.fix = TRUE)

mapa_isla_plot <- tm_shape(mapa_isla) + 
                  tm_borders() + 
                  tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                  tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                  tmap_options(check.and.fix = TRUE)

mapa_comarca_plot <- tm_shape(mapa_comarca) + 
                     tm_borders() + 
                     tm_fill(col = "col", palette = palette, alpha = 0.8, legend.show = F) +
                     tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA) +
                     tmap_options(check.and.fix = TRUE)
```

```{r Municipios relacionados}
datamun <- fromJSON(params$url.dist_mun)

# DF con el código, el nombre y la situación geográfica de todos los municipios canarios.
df_localizacion <- data.frame(mun = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["code"]],
                              nombre = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["title"]][["es"]],
                              latitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["latitude"]],
                              longitud = datamun[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["longitude"]]) %>% 
  filter(substring(mun, 0,2) != "ES")
df_localizacion$nombre <- recode_mun(df_localizacion, 'nombre')

# Cálculo de las distancias geográficas entre el municipio seleccionado y el resto de municipios canarios.
distancias_mun <- df_localizacion %>%
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326) %>%
  st_distance
distancias_mun <- data.frame(
  mun = df_localizacion$mun,
  nombre = df_localizacion$nombre,
  distancia = distancias_mun[as.numeric(rownames(df_localizacion[df_localizacion$mun == params$id_municipio, ])),] / 1000
)

# Función para seleccionar los dos municipios comparables en el gráfico espacio-temporal.
# Se tiene en cuenta:
# - la distancia geográfica entre el municipio y el municipio seleccionado y
# - la diferencia entre el valor de la variable principal en el municipio y el municipio seleccionado.
# Se escogen dos municipios para comparar.
seleccion_mun <- function(df_variable, variable, p = 0.5) {
  df_dif <- df_variable %>% left_join(distancias_mun, by = "mun") 
  mun_actual <- df_dif[df_dif$mun == params$id_municipio,]
  
  df_result <- df_dif %>%
    mutate(
      dif = abs(df_dif[,variable] - mun_actual[1,variable]),
      distancia_N = scale(distancia),
      dif_N = scale(dif),
      coeficientes = p * distancia_N + (1-p) * dif_N
    ) %>%
  arrange(coeficientes)
  
  df_result[1:3,]
}
```

```{r Gráfico espacio-temporal de la variable principal}
data_u <- fromJSON(params$url.parados)

# DF de los valores de la variable principal en todos los periodos y municipios canarios.
df_u <- data.frame(
  mun = rep(names(data_u[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                 each=length(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]) * length(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]])),
  code = rep(names(data_u[["dimension"]][["TIME"]][["representation"]][["index"]]),
             each=length(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]])),
  medida = rep(names(data_u[["dimension"]][["MEASURE"]][["representation"]][["index"]]),
            times = length(data_u[["dimension"]][["TIME"]][["representation"]][["index"]])),
  valor = round(as.numeric(data_u[["observation"]]), 1)) %>%
  spread(medida, valor) %>%
  select(mun, code, valor = ABSOLUTE, tasa = ANNUAL_PERCENTAGE_RATE)

# DF de los valores de la variable principal en todos los municipios canarios en el periodo (mes y año) escogido.
related_mun <- df_u %>% filter(code == mes_actual$code)
# Se aplica la función para seleccionar municipios relacionados en el mes y año escogidos.
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

# Plantilla para la leyenda.
leyenda.template <- "<div class='serie-placeholder serie-placeholder-%s'><div class='sp-bullet' style='background-color: %s'></div><div class='sp-content'><span class='sp-municipio'>%s</span><br/>Unidades: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s&percnt;</span></div></div>"
# Plantilla para el contenido de la leyenda.
leyenda.content <- "<span class='sp-municipio'>%s</span><br/>Unidades: <span class='sp-habitantes'>%s</span><br/>Tasa de variación: <span class='sp-tasa'>%s&percnt;</span>"

# Colores para el gráfico espacio-temporal y su leyenda.
g_line_colours <- setNames(c('rgba(0, 89, 128, 0.8)', 'rgba(0, 139, 208, 0.8)', 'rgba(140, 210, 234, 0.8)' ), related_mun$nombre)

# DF de los valores en los tres municipios relacionados.
df <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, code, nombre, valor, tasa) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(mun = id, code, nombre, valor, tasa) %>%
  left_join(mes, by = "code") %>%
  filter(code <= mes_actual$code & order > 12)

# Leyenda fija.
leyenda_poblacion <- df %>% filter(periodo == mes_actual$periodo) %>%
  mutate(valor = format(valor, big.mark = ".", decimal.mark = ",")) %>%
  mutate(tasa = format(tasa, big.mark = ".", decimal.mark = ",")) %>%
  left_join(data.frame(cbind(nombre = rownames(data.frame(g_line_colours)), color = g_line_colours)), by = "nombre")

# Texto que irá apareciendo en la leyenda al pasar el cursor a lo largo de la representación gráfica.
df <- df %>% mutate(
    tooltip = ifelse(code == mes_actual$code, 
                     sprintf(leyenda.content, nombre, ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%"))),
                     sprintf(leyenda.content, nombre, paste0(ifelse(is.na(valor), " -", format(valor, big.mark = ".", decimal.mark = ",")), ' (',periodo_formatted,')'),
                             ifelse(is.na(tasa), " -", paste0(format(tasa, big.mark = ".", decimal.mark = ",", nsmall = 1), "%")))
              )
  )
  
# Gráfico espacio-temporal que consiste en un diagrama de líneas para los tres municipios relacionados.
g_line <- ggplot(data = df, aes(x = code, y = valor, group = nombre, colour = nombre, text = tooltip)) +
  geom_line() +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  scale_colour_manual(values = g_line_colours) +
  scale_size_manual(values = c(1, 0.1, 0.1))+
  scale_x_discrete(breaks = function(x){ paste0(2006:2021, "-01") }, labels = function(x){substr(x, 0, 4) }) +
  scale_y_continuous(labels = function(x){paste0(format(x, big.mark = ".", decimal.mark = ","), "")}, n.breaks = 6, limits = c(0, NA))

g_line <- ggplotly(g_line, tooltip = "text") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"), list("pan2d"), list("resetScale2d"), list("toImage"))) %>%
  layout(hoverlabel = "", hovermode = 'x unified',
         xaxis = list(autorange = FALSE,
                      range = c(max(max(df$order) - 5*12 - 12, min(df$order) - 12), max(df$order) - 12),
                      rangeslider = list(type = "date", thickness=0.04))) %>%
  onRender("
    function(el) {
      var municipios = document.getElementsByClassName('sp-municipio');
      var contents = document.getElementsByClassName('sp-content');

      el.on('plotly_hover', function(d) { highlight(d); });
      el.on('plotly_unhover', function(d) { reset(d); });
      el.on('plotly_click', function(d) { highlight(d); });
      
      function highlight(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var x = d.points[point].x;
              contents[i].innerHTML = d.points[point].text;
            }
          }
        }
      }
      
      function reset(d) {
        for (point in d.points) {
          for (var i = 0; i < municipios.length; i++) {
            if (d.points[point].data.legendgroup.includes(municipios[i].textContent)) {
              var fullTexts = d.points[point].fullData.text;
              contents[i].innerHTML = fullTexts[fullTexts.length - 1];
            }
          }
        }
      }
    }
  ") 
```

```{r Valor de la variable principal y su variación porcentual}
# DF de los valores de la variable para el municipio y periodo seleccionados.
df_lv <- df_u %>% filter(code == mes_actual$code & mun == params$id_municipio)

# Valor de la variable principal para el cálculo de porcentajes.
Num_Paro_num <- df_lv$valor %>% as.numeric
# Valor de la variable principal formateado para mostrarlo en la ficha.
Num_Paro <- Num_Paro_num %>% format(big.mark = ".", decimal.mark = ",")
# Variación porcentual de la variable principal, si no se puede calcular no aparecerá en la ficha.
Variacion_Porcentual_Paro <- df_lv %>% select(tasa) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
# Icono que acompaña a la tasa de variación.
Imagen_Variacion <- ifelse(signo(Variacion_Porcentual_Paro) == "más", './img/up.png', './img/down.png')
```

```{r Indicadores por sexos}
ind_paro_M <- fromJSON(params$url.ind_paro_M)

df_p_M <- data.frame(mun = rep(names(ind_paro_M[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                               each=length(ind_paro_M[["dimension"]][["TIME"]][["representation"]][["index"]])),
                     code = names(ind_paro_M[["dimension"]][["TIME"]][["representation"]][["index"]]),
                     valor = as.numeric(ind_paro_M[["observation"]]))

# Valor y porcentaje de mujeres.
Num_Paro_M_num <- df_p_M %>% filter(code == mes_actual$code & mun == params$id_municipio) %>% select(valor) %>% as.numeric
Num_Paro_M <- Num_Paro_M_num %>% format(big.mark = ".", decimal.mark = ",")
Percent_Mujeres <- round(Num_Paro_M_num / Num_Paro_num *100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)

ind_paro_H <- fromJSON(params$url.ind_paro_H)

df_p_H <- data.frame(mun = rep(names(ind_paro_H[["dimension"]][["GEOGRAPHICAL"]][["representation"]][["index"]]),
                               each=length(ind_paro_H[["dimension"]][["TIME"]][["representation"]][["index"]])),
                     code = names(ind_paro_H[["dimension"]][["TIME"]][["representation"]][["index"]]),
                     valor = as.numeric(ind_paro_H[["observation"]]))

# Valor y porcentaje de hombres.
Num_Paro_H_num <- df_p_H %>% filter(code == mes_actual$code & mun == params$id_municipio) %>% select(valor) %>% as.numeric
Num_Paro_H <- Num_Paro_H_num %>% format(big.mark = ".", decimal.mark = ",")
Percent_Hombres <- round(Num_Paro_H_num / Num_Paro_num *100, 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```
 
```{r Pirámide por grupos de edad y sexos}
piramide <- fromJSON(params$url.piramide_paro)

# DF de la variable principal desagregada por grupos de edad y sexo para construir un gráfico en forma de pirámide.
df_piramide <- cbind(data.frame(do.call('rbind', piramide[["data"]][["dimCodes"]])), piramide[["data"]][["Valor"]])
colnames(df_piramide) <- c('mun', 'periodo', 'gredad', 'sexo', 'valor')
df_piramide$periodo <- factor(df_piramide$periodo , levels=piramide[["categories"]][["codes"]][[2]], labels=piramide[["categories"]][["labels"]][[2]])
df_piramide$gredad <- ordered(df_piramide$gredad, levels = piramide[["categories"]][["codes"]][[3]], labels=piramide[["categories"]][["labels"]][[3]])
df_piramide$sexo <- factor(df_piramide$sexo , levels=piramide[["categories"]][["codes"]][[4]], labels=piramide[["categories"]][["labels"]][[4]])
df_piramide$valor <- as.numeric(df_piramide$valor)

# Valor de la variable principal en la isla correspondiente para el ranking a nivel insular.
Num_Paro_Isla <- df_piramide %>% filter(mun == municipio_actual$id_isla & periodo == mes_actual$periodo & gredad == "TOTAL" & sexo == "AMBOS SEXOS") %>% select(valor) %>% as.numeric()
# Valor de la variable principal en Canarias para el cálculo de porcentajes de Canarias y para el ranking a nivel autonómico.
Num_Paro_Canarias <- df_piramide %>% filter(mun == "ES70" & periodo == mes_actual$periodo & gredad == "TOTAL" & sexo == "AMBOS SEXOS") %>% select(valor) %>% as.numeric()

# Filtro por las categorías indicadas de sexos, grupos de edad y año y hago las transformaciones para poner los valores masculinos en negativo.
df_piramide_plot <- df_piramide %>% filter(periodo == mes_actual$periodo & gredad != "TOTAL" & sexo != "AMBOS SEXOS") %>%
  select(gredad, sexo, valor, mun) %>%
  transform(valor = if_else(sexo == "Hombres", -valor, valor), gredad = ifelse(grepl("ó", gredad, fixed = TRUE), gsub(" ó ", "-", gredad), gsub(" a ", "-", gredad))) %>%
  transform(order = as.numeric(unlist(lapply(strsplit(gredad, "-"), '[[', 1)))) %>% 
  transform(gredad = ifelse(gredad == "Menores de 20", "<20", gredad)) %>%
  transform(gredad = ifelse(gredad == "Mayores de 59", ">59", gredad)) %>%
  transform(order = if_else(gredad == "<20", 19, order)) %>%
  transform(order = if_else(gredad == ">59", 60, order)) %>%
  arrange(desc(order))

# DF solo para el municipio y Canarias
df_Canarias <- df_piramide_plot %>% filter(mun == "ES70")
df_mun <- df_piramide_plot %>% filter(mun == params$id_municipio)
df_mun <- cbind(df_mun, porcentaje = df_mun$valor / Num_Paro_num, valor_Canarias = df_Canarias$valor, porcentaje_Canarias = df_Canarias$valor / Num_Paro_Canarias)

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_mun <- df_mun %>% transform(
  hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", gredad," años</b><br>"), ""),
    "<br><b>", sexo, "</b>",
    "<br>", trimws(format(abs(valor), big.mark = ".", decimal.mark = ",")),
    " (", trimws(format(round(abs(porcentaje)*100, 1), big.mark = ".", decimal.mark = ",")), "%)",
    "<br>Canarias: ", trimws(format(abs(valor_Canarias), big.mark = ".", decimal.mark = ",")),
    " (", trimws(format(round(abs(porcentaje_Canarias)*100, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

# Representación gráfica en forma de pirámide.
g_piramide <- ggplot(data = df_mun, aes(x = reorder(gredad,order), fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.99, aes(y = porcentaje)) + 
  geom_bar(stat = "identity", color = "#59656E", alpha = 0, width = 0.99, size = 0.4, aes(y = porcentaje_Canarias, text = "")) +
  coord_flip() + 
  theme_minimal() +
  labs(x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none"
        ) +
  scale_y_continuous(n.breaks = 7, labels = function(x){paste0(format(abs(x)*100, big.mark = '.', decimal.mark = ","), '%')},
                     limits = c(-1, 1)*max(abs(df_mun$porcentaje), abs(df_mun$porcentaje_Canarias)))

g_piramide <- ggplotly(g_piramide, tooltip = c("text")) %>%
  layout(margin = list(t=10), hovermode = "y unified") %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Rankings territoriales}
# DF de todos los municipios canarios ordenados por el valor de la variable principal de mayor a menor en el periodo escogido.
df_ranking <- df_u %>%
  select(id = mun, code, valor) %>%
  filter(code == mes_actual$code & !is.na(valor)) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

# Posición y porcentaje respecto a todos.
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_ranking[which(df_ranking$id==params$id_municipio),]$valor / Num_Paro_Canarias * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

# Posición y porcentaje respecto a los municipios de la misma isla.
df_ranking_isla <- df_ranking %>% filter(isla == municipio_actual$isla)
rk_isla <- grep(params$id_municipio, df_ranking_isla$id)
num_mun_isla <- nrow(df_ranking_isla)
percent_isla <- format(round(df_ranking_isla[which(df_ranking_isla$id==params$id_municipio),]$valor / Num_Paro_Isla * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

# Posición y porcentaje respecto a los municipios de la misma comarca.
df_ranking_comarca <- df_ranking %>% filter(comarca == municipio_actual$comarca)
rk_comarca <- grep(params$id_municipio, df_ranking_comarca$id)
num_mun_comarca <- nrow(df_ranking_comarca)
percent_comarca <- format(round(df_ranking_comarca[which(df_ranking_comarca$id==params$id_municipio),]$valor / sum(df_ranking_comarca$valor) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Edad media calculada}
# Cálculo de la edad media a través de la fórmula de la media por intervalos.
df_edad_media <- df_piramide %>% 
  filter(mun == params$id_municipio & periodo == mes_actual$periodo, gredad != "TOTAL" & sexo == "AMBOS SEXOS") %>% 
  transform(gredad = ifelse(grepl("ó", gredad, fixed = TRUE), gsub(" ó ", "-", gredad), gsub(" a ", "-", gredad))) %>%
  transform(x = as.numeric(unlist(lapply(strsplit(gredad, "-"), '[[', 1)))) %>%
  transform(x = x + 2.5) %>% 
  transform(x = if_else(gredad == "Menores de 20", 18, x)) %>%
  transform(x = if_else(gredad == "Mayores de 59", 62.5, x)) %>% 
  transform(producto = valor * x)

# Valor del indicador.
edad_media <- round(sum(df_edad_media$producto) / sum(df_edad_media$valor), 1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Barras sectores económicos y sexo}
data_paro_se <- fromJSON(params$url.paro_se)

# DF de la variable principal desagregada por sectores económicos y sexos para construir un diagrama de barras.
df_paro_se <- cbind(data.frame(do.call('rbind', data_paro_se[["data"]][["dimCodes"]])), data_paro_se[["data"]][["Valor"]])
colnames(df_paro_se) <- c('mun', 'periodo', 'sector', 'sexo', 'valor')
df_paro_se$mun <- factor(df_paro_se$mun, levels=data_paro_se[["categories"]][["codes"]][[1]], labels=data_paro_se[["categories"]][["labels"]][[1]])
df_paro_se$periodo <- factor(df_paro_se$periodo, levels=data_paro_se[["categories"]][["codes"]][[2]], labels=data_paro_se[["categories"]][["labels"]][[2]])
df_paro_se$sector <- factor(df_paro_se$sector, levels=data_paro_se[["categories"]][["codes"]][[3]], labels=data_paro_se[["categories"]][["labels"]][[3]])
df_paro_se$sexo <- factor(df_paro_se$sexo, levels=data_paro_se[["categories"]][["codes"]][[4]], labels=data_paro_se[["categories"]][["labels"]][[4]])
df_paro_se$valor <- as.numeric(df_paro_se$valor)
df_paro_se$mun <- recode_mun(df_paro_se, 'mun')

# DF de la variable principal desagregada por sectores económicos y sexos en el municipio y periodo seleccionados.
df_paro_se_mun <- df_paro_se %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$periodo & sector != "TOTAL" & sexo != "AMBOS SEXOS") %>% select(!c(mun, periodo))
df_paro_Canarias <- df_paro_se %>%
  filter(mun == "CANARIAS" & periodo == mes_actual$periodo & sector != "TOTAL" & sexo != "AMBOS SEXOS") %>% select(!c(mun, periodo))
df_paro_se_mun <- df_paro_se_mun %>%
  mutate(porcentaje = df_paro_se_mun$valor / Num_Paro_num * 100,
         valor_Canarias = df_paro_Canarias$valor,
         porcentaje_Canarias = df_paro_Canarias$valor / Num_Paro_Canarias * 100) %>% 
  transform(porcentaje = if_else(sexo == "Hombres", -porcentaje, porcentaje),
            porcentaje_Canarias = if_else(sexo == "Hombres", -porcentaje_Canarias, porcentaje_Canarias))

# FOR para separar los nombres de los sectores económicos en varias líneas.
df_paro_se_mun$name_sector <- ""
for(i in 1:nrow(df_paro_se_mun)) {
  df_paro_se_mun$name_sector[i] <- get_nombre(paste0(df_paro_se_mun$sector[i]))
}

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_paro_se_mun <- df_paro_se_mun %>% transform(hovertext = paste0(
    ifelse(sexo == "Hombres", paste0("<b>", trimws(sector), "</b><br>"), ""),
    "<br><b>", sexo, "</b>",
    "<br>",trimws(format(valor, big.mark = ".", decimal.mark = ",")), 
    " (", trimws(format(round(abs(porcentaje), 1), big.mark = ".", decimal.mark = ",")), "%)",
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
    " (", trimws(format(round(abs(porcentaje_Canarias), 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_paro_se_mun <- rbind(df_paro_se_mun[3:nrow(df_paro_se_mun),], df_paro_se_mun[1:2,]) %>% mutate(order = nrow(df_paro_se_mun):1)

# Representación gráfica de un diagrama de barras ordenadas por el orden habitual de las actividades económicas.
g_paro_se <- ggplot(data = df_paro_se_mun, aes(x = reorder(name_sector, order), fill = sexo, group = sexo, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.99, position = position_stack(reverse = TRUE), aes(y = porcentaje)) +
  geom_bar(stat = "identity", color = "#59656E", alpha = 0, width = 0.99, size = 0.4, aes(y = porcentaje_Canarias, text = "")) +
  coord_flip() +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("Mujeres" = "#8CD2EA", "Hombres" = "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_y_continuous(labels = function(x){paste0(format(abs(x), big.mark = '.', decimal.mark = ","), '%')},
                     limits = c(-1, 1)*max(abs(df_paro_se_mun$porcentaje), abs(df_paro_se_mun$porcentaje_Canarias)))

g_paro_se <- ggplotly(g_paro_se, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(t = 10, l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>% 
  style(hoverinfo = "skip", traces = c(3, 4))
```

```{r Paro por estudios terminados y sexo}
data_paro_sexo_est <- fromJSON(params$url.paro_sexo_est)

# DF de la variable principal desagregada por niveles de estudios terminados y sexos para construir indicadores.
df_paro_sexo_est <- cbind(data.frame(do.call('rbind', data_paro_sexo_est[["data"]][["dimCodes"]])), data_paro_sexo_est[["data"]][["Valor"]])
colnames(df_paro_sexo_est) <- c('mun', 'estudios', 'periodo', 'sexo', 'valor')
df_paro_sexo_est$mun <- factor(df_paro_sexo_est$mun, levels=data_paro_sexo_est[["categories"]][["codes"]][[1]], labels=data_paro_sexo_est[["categories"]][["labels"]][[1]])
df_paro_sexo_est$estudios <- factor(df_paro_sexo_est$estudios, levels=data_paro_sexo_est[["categories"]][["codes"]][[2]], 
                                    labels=data_paro_sexo_est[["categories"]][["labels"]][[2]])
df_paro_sexo_est$periodo <- factor(df_paro_sexo_est$periodo, levels=data_paro_sexo_est[["categories"]][["codes"]][[3]], 
                                   labels=data_paro_sexo_est[["categories"]][["labels"]][[3]])
df_paro_sexo_est$sexo <- factor(df_paro_sexo_est$sexo, levels=data_paro_sexo_est[["categories"]][["codes"]][[4]], 
                                labels=data_paro_sexo_est[["categories"]][["labels"]][[4]])
df_paro_sexo_est$valor <- as.numeric(df_paro_sexo_est$valor)
df_paro_sexo_est$mun <- recode_mun(df_paro_sexo_est, 'mun')

# DF de la variable principal desagregada por niveles de estudios terminados y sexos en el municipio y periodo seleccionados.
df_paro_sexo_est_mun_ <- df_paro_sexo_est %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$periodo & estudios != "TOTAL" & substring(estudios, 1, 1) != " " & sexo == "AMBOS SEXOS") %>%
  select(!c(mun, sexo)) %>% arrange(valor)
df_paro_sexo_est_mun_ <- df_paro_sexo_est_mun_ %>% mutate(peso = round(df_paro_sexo_est_mun_$valor / Num_Paro_num * 100, 1))

# Indicadores.
ind.sin_estudios <- format(df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Sin estudios', ]$peso, big.mark = ".", decimal.mark = ",", nsmall = 1)
ind.estudios_primarios <- format(df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Estudios primarios', ]$peso, big.mark = ".", decimal.mark = ",", nsmall = 1)
ind.estudios_secundarios <- format(df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Estudios secundarios', ]$peso, big.mark = ".", decimal.mark = ",", nsmall = 1)
ind.estudios_postsecundarios <- format(100 - df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Sin estudios', ]$peso - df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Estudios primarios', ]$peso - df_paro_sexo_est_mun_[df_paro_sexo_est_mun_$estudios =='Estudios secundarios', ]$peso, big.mark = ".", decimal.mark = ",", nsmall = 1)
```


```{r Generación HTML, results="asis"}
# Función para los indicadores principales colocados entre el gráfico espacio-temporal y las clasificaciones territoriales; y para los indicadores del recuadro de las afiliaciones (residencia y cotización) según sus nacionalidades (icono representativo, valor/porcentaje y nombre o icono representativo, porcentaje, nombre y valor).
get_indicator2 = function(label, value, image) {
  return(sprintf("<div class='indicator2'><div class='image'><img src='%s'></img></div><div class='indicator-content'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
# Función para los indicadores de los porcentajes de personas paradas por niveles de estudios terminados (icono representativo, porcentaje y modalidad).
get_indicator3 = function(label, value, image) {
  return(sprintf("<div class='indicator3'><div class='image'><img src='%s'></img></div><div class='indicator-content' style='padding-left: 20px;'><p class='value'>%s</p><p class='label'>%s</p></div></div>", image, value, label))
}
# Función para los indicadores de los porcentajes de personas alojadas canarias respecto a su lugar de residencia (porcentaje y modalidad).
get_indicator3s = function(label, value) {
  return(sprintf("<div class='indicator3'><div class='indicator-content'><p class='value'>%s</p><hr class='separator'><p class='label'>%s</p></div></div>", value, label))
}
```

<!-- HTML -->
<!-- <h1 style="color: #008BD0; margin: 0; font-size: 54px;">`r municipio_actual$municipio` en cifras</h1> -->
<!-- <h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">`r mes_actual$periodo_formatted`</h3> -->
<h1 style="color: #008BD0; margin: 0; font-size: 54px;">Nombre del municipio en cifras</h1>
<h3 style="color: #999;margin: 0;float: right;margin-right: 20px;">mes</h3>
<h2 style="color: #666; margin: 0;">Temática</h2>
<hr>

```{r espacio leyenda, results='asis'}
# Aumenta el espacio entre el gráfico espacio-temporal y los indicadores principales si el municipio seleccionado necesita escribirse en dos líneas.
margin_b <- ifelse(nchar(leyenda_poblacion$nombre[1]) > 26, 48, 15)
```
<div class="linechart-placeholder" style="margin-bottom: `r paste0(margin_b, 'px')`;">
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Paro` unidades</h2>
<div class="linechart">
  `r g_line`
</div>
<div id="hover-event-placeholder" class="column-4">
```{r leyendas, results = "asis"}
# FOR para la leyenda del gráfico espacio-temporal.
for (i in 1:nrow(leyenda_poblacion)) {
  cat(sprintf(leyenda.template, i, leyenda_poblacion$color[i], leyenda_poblacion$nombre[i], leyenda_poblacion$valor[i], leyenda_poblacion$tasa[i]))
}
```

</div>
</div>

<div class="row">
```{r Indicadores principales, results='asis'}
# Los cuatro indicadores principales, que se quedan en tres si no se tiene la variación porcentual ni se puede calcular.
if(Variacion_Porcentual_Paro == "NA"){
  cat(paste0(
    '</div><div class="column-3-ind">', get_indicator2("Edad</br>media", edad_media, "./img/family.png"), '</div><div class="column-3-ind">', get_indicator2(paste0("Mujeres</p><p class='label' style='color: #999;'>", Num_Paro_M), paste0(Percent_Mujeres, "%"), "./img/female.png"), '</div><div class="column-3-ind">', get_indicator2(paste0("Hombres</p><p class='label' style='color: #999;'>", Num_Paro_H), paste0(Percent_Hombres, "%"), "./img/male.png"), '</div>'))
}else{
  cat(paste0(
    '<div class="column-4">', get_indicator2("Tasa de</br>variación", paste0(Variacion_Porcentual_Paro, "%"), Imagen_Variacion), '</div><div class="column-4">', get_indicator2("Edad</br>media", edad_media, "./img/family.png"), '</div><div class="column-4">', get_indicator2(paste0("Mujeres</p><p class='label' style='color: #999;'>", Num_Paro_M), paste0(Percent_Mujeres, "%"), "./img/female.png"), '</div><div class="column-4">', get_indicator2(paste0("Hombres</p><p class='label' style='color: #999;'>", Num_Paro_H), paste0(Percent_Hombres, "%"), "./img/male.png"), '</div>'))
}
```
</div>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map map-canarias">
  <div class="image">
```{r} 
mapa_Canarias_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r} 
mapa_isla_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r}
mapa_comarca_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_comarca`º </span>en la comarca</p>
  <p class="label2">de `r num_mun_comarca` municipios (`r percent_comarca`%)</p>
  </div>
</div>
</div>
</div>

<div class="row">
<div class="column indicator-title">
  <h3>Grupos de edad y sexos</h3>
</div>
<div class="column indicator-title">
  <h3>Actividades económicas y sexos</h3>
</div>
</div>

<div class="row">
<div class="column highlight">

<div class="piramide" style="height: 280px;">
  `r g_piramide` 
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Mujeres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-C'></div><div class='sp-content'>Canarias</div></div>
</div>
</div>

<div class="column highlight">

<div class="piramide" style="height: 280px;">
  `r g_paro_se`
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Hombres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Mujeres</div></div>
  <div class='progressbar-legend'><div class='progress-bar-C'></div><div class='sp-content'>Canarias</div></div>
</div>

</div>
</div>
<div class="indicator-title-row">
  <h3>Estudios terminados</h3>
</div>
<div class="row highlight" style="width: 100% !important; margin-top: 10px;">
<div class="column-4">`r get_indicator3("Sin estudios", paste0(ind.sin_estudios, '%'),"./img/sinestudio.png")`</div>
<div class="column-4">`r get_indicator3("Estudios<br/>primarios", paste0(ind.estudios_primarios, '%'),"./img/primarios.png")`</div>
<div class="column-4">`r get_indicator3("Estudios<br/>secundarios", paste0(ind.estudios_secundarios, '%'),"./img/secundarios.png")`</div>
<div class="column-4">`r get_indicator3("Estudios<br/>postsecundarios", paste0(ind.estudios_postsecundarios, '%'),"./img/postsecundario.png")`</div>

</div>


```{r DF de la variable principal de las afiliaciones según lugar de residencia}
data_afil <- fromJSON(params$url.afil_r)

# DF de las variable principal según situaciones laborales, nacionalidades y sexos.
df_afil <- cbind(data.frame(do.call('rbind', data_afil[["data"]][["dimCodes"]])), data_afil[["data"]][["Valor"]])
colnames(df_afil) <- c('mun', 'sl', 'nacionalidad',  'periodo', 'sexo', 'valor')
df_afil$sl <- factor(df_afil$sl, levels=data_afil[["categories"]][["codes"]][[2]], labels=data_afil[["categories"]][["labels"]][[2]])
df_afil$nacionalidad <- factor(df_afil$nacionalidad, levels=data_afil[["categories"]][["codes"]][[3]], labels=data_afil[["categories"]][["labels"]][[3]])
df_afil$sexo <- factor(df_afil$sexo, levels=data_afil[["categories"]][["codes"]][[5]], labels=data_afil[["categories"]][["labels"]][[5]])
df_afil$valor <- as.integer(df_afil$valor)

# DF con filtro de periodos cada tres meses (marzo, junio, septiembre y diciembre).
df_afil <- df_afil %>%
  filter(substring(periodo, 5,8) %in% c("M03", "M06", "M09", "M12") & substring(mun, 0,2) != "ES")
```

```{r Número de afiliaciones según residencia}
# Valor de la variable principal en el municipio y periodo seleccionados para el cálculo de porcentajes.
Num_Afil_num <- df_afil %>% filter(mun == params$id_municipio & sl == "TOTAL DE AFILIACIONES" & nacionalidad == "TOTAL" & sexo == "AMBOS SEXOS" & periodo == mes_actual$code) %>%
  select(valor) %>%  as.numeric()
# Valor de la variable principal formateado para mostrarlo en la ficha.
Num_Afil <- Num_Afil_num %>% format(big.mark = ".", decimal.mark = ",") %>% as.character()
```

```{r Indicadores afiliaciones por nacionalidades}
# DF con la variable principal desagregada por nacionalidades en el municipio y periodo escogido.
df_afil_extr_mun <- df_afil %>%
  filter(mun == params$id_municipio & sl == "TOTAL DE AFILIACIONES" & sexo == "AMBOS SEXOS" & periodo == mes_actual$code &
         nacionalidad %in% c(" ESPAÑOLA", " EXTRANJERA", " APÁTRIDA O SIN ESPECIFICAR")) %>%
  select(nacionalidad, valor)
df_afil_extr_mun <- df_afil_extr_mun %>% mutate(peso = round(df_afil_extr_mun$valor / Num_Afil_num * 100, 1))

# Indicadores
Peso_afil_esp <- df_afil_extr_mun %>% filter(nacionalidad == " ESPAÑOLA") %>% select(peso) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Peso_afil_ext <- df_afil_extr_mun %>% filter(nacionalidad == " EXTRANJERA") %>% select(peso) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1)
Peso_afil_apat <- df_afil_extr_mun %>% filter(nacionalidad == " APÁTRIDA O SIN ESPECIFICAR") %>% select(peso) %>% as.numeric()
```

```{r Progress-bar afiliaciones según situaciones laborales}
# DF con la variable principal desagregada por situaciones laborales en el municipio y periodo escogido.
df_afil_sl_mun <- df_afil %>%
  filter(mun == params$id_municipio & sexo == "AMBOS SEXOS" & periodo == mes_actual$code & nacionalidad == "TOTAL") %>%
  select(sl, valor)
df_afil_sl_mun <- df_afil_sl_mun %>% mutate(peso = round(df_afil_sl_mun$valor / df_afil_sl_mun$valor[which(df_afil_sl_mun$sl == "TOTAL DE AFILIACIONES")] * 100, 1))

# Porcentajes para construir la barra de porcentajes.
Peso_afil_asal <- df_afil_sl_mun %>% filter(sl == " Empleos asalariados") %>% select(peso) %>% as.numeric()
Peso_afil_auton <- df_afil_sl_mun %>% filter(sl == " Empleos autónomos") %>% select(peso) %>% as.numeric()
```

<!-- HTML -->
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Afil` afiliaciones</h2>

<div class="row">
<div class="column indicator-title">
  <h3>Nacionalidades</h3>
</div>
<div class="column indicator-title">
  <h3>Situaciones laborales</h3>
</div>

<div class="column highlight" style="padding-top: 16px;">
  <div class="column-2">`r get_indicator2("Española", paste0(Peso_afil_esp, "%"),"./img/spain2.png")`</div> 
  <div class="column-2">`r get_indicator2("Extranjero", paste0(Peso_afil_ext, "%"),"./img/world.png")`</div>
</div>
<div class="column highlight">
<div class="progress-bar-container">
  <div class="progress-bar-blue1" style="width:`r Peso_afil_asal`%"></div>
  <div class="progress-bar-blue6" style="width:`r Peso_afil_auton`%"></div>
</div>

<div class="progressbar-legend-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1'></div><div class='sp-content'>Asalariados</br>`r format(Peso_afil_asal, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6'></div><div class='sp-content'>Autónomos</br>`r format(Peso_afil_auton, big.mark = ".", decimal.mark = ",", nsmall = 1)`%</div></div>
</div>
</div>
</div>


```{r DF de la variable principal para alojamientos turísticos}
viajeros_lugar <- fromJSON(params$url.viajeros_lugar)

# DF de la variable principal según indicadores y según lugares de residencia por municipios de alojamiento.
df_u_ <- cbind(data.frame(do.call('rbind', viajeros_lugar[["data"]][["dimCodes"]])), viajeros_lugar[["data"]][["Valor"]])
colnames(df_u_) <- c('ind', 'lugar', 'mun', 'periodo', 'valor')
df_u_$ind <- factor(df_u_$ind, levels=viajeros_lugar[["categories"]][["codes"]][[1]], labels=viajeros_lugar[["categories"]][["labels"]][[1]])
df_u_$lugar <- factor(df_u_$lugar, levels=viajeros_lugar[["categories"]][["codes"]][[2]], labels=viajeros_lugar[["categories"]][["labels"]][[2]])
df_u_$valor <- as.numeric(df_u_$valor)
df_u_ <- df_u_ %>% mutate(lugar = recode(lugar, " TOTAL RESIDENTES EN ESPAÑA" = "España"))

# DF de los valores de la variable principal en todos los periodos y municipios canarios.
df_u_ <- df_u_ %>% filter(substring(periodo, 5,5) == "M")
df_u_$periodo <- paste0(substring(df_u_$periodo, 0,4), "-", substring(df_u_$periodo, 6,7))
df_u <- df_u_ %>% filter(lugar == "TOTAL LUGARES DE RESIDENCIA" & ind == "Viajeros alojados") %>% select(mun, periodo, valor)

# Valor de la variable principal en Canarias para el cálculo de porcentajes de Canarias y para el ranking a nivel autonómico.
num_Canarias_total <- df_u %>% filter(mun == "ES70" & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()
# Valor de la variable principal en la isla correspondiente para el ranking a nivel insular.
num_Isla_total <- df_u %>% filter(mun == municipio_actual$id_isla & periodo == mes_actual$code) %>% select(valor) %>% as.numeric()

# DF ordenado temporalmente.
df_u <- df_u[with(df_u, order(periodo)), ]
df_u <- df_u %>%
  filter(substring(mun, 0,1) == "3") %>% 
  arrange(periodo) %>% 
  select(mun, periodo, valor)

# Se aplica la función para seleccionar municipios relacionados en el periodo escogido.
related_mun <- df_u %>% filter(periodo == mes_actual$code)
related_mun <- seleccion_mun(related_mun %>% select(mun, valor), 'valor')

# DF de los valores en los tres municipios relacionados.
df <- related_mun %>%
  select(mun, nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, periodo, nombre, valor) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(id, code = periodo, nombre, valor) %>%
  left_join(mes, by = "code") %>%
  transform(tasa = ifelse(substring(code, 0,4) != min(substring(code, 0,4)), round(100*((valor / lag(valor, n = 12)) - 1), 1), NA)) %>%
  filter(substring(periodo, 0,4) != min(substring(code, 0,4)) & code <= mes_actual$code)
```

```{r Indicador evolución de los viajeros}
# Mismo mes del año anterior para calcular la variación.
mes_tva <- mes[mes$order == mes[mes_actual$code == mes$code, ]$order - 12, ]

# DF de los valores de la variable para el municipio.
ind_viaj <- df %>% filter(id == params$id_municipio & code %in% c(mes_actual$code, mes_tva$code))

# Valor de la variable principal para el cálculo de porcentajes.
Num_Viajeros_num <- ind_viaj %>% filter(code == mes_actual$code) %>% select(valor) %>% as.numeric()
# Valor de la variable principal formateado para mostrarlo en la ficha.
Num_Viajeros <- Num_Viajeros_num %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Rankings territoriales alojamientos}
# DF de todos los municipios canarios ordenados por el valor de la variable principal de mayor a menor en el periodo escogido.
df_ranking <- df_u %>%
  select(id = mun, periodo, valor) %>%
  filter(periodo == mes_actual$code) %>%
  left_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

# Posición y porcentaje respecto a todos.
df_tur_mun <- df_ranking[which(df_ranking$id==params$id_municipio),]
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_tur_mun$valor / num_Canarias_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

# Posición y porcentaje respecto a los municipios de la misma isla.
df_tur_isla <- df_ranking %>% filter(isla == df_tur_mun$isla)
rk_isla <- grep(params$id_municipio, df_tur_isla$id)
num_mun_isla <- nrow(df_tur_isla)
percent_isla <- format(round(df_tur_mun$valor / num_Isla_total * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Barras Lugar}
# DF de los valores de la variable principal en todos los territorios en el periodo escogido.
df_viajeros_lugar <- df_u_ %>% 
  filter(periodo == mes_actual$code & ind == "Viajeros alojados" & 
         lugar %notin% c("TOTAL LUGARES DE RESIDENCIA", " TOTAL RESIDENTES EN EL EXTRANJERO", "  Canarias", "  Residentes en España excepto Canarias")) %>%
  select(mun, lugar, valor)

# DF de los valores de la variable para el municipio seleccionado.
df_viajeros_lugar_mun <- df_viajeros_lugar %>% filter(mun == params$id_municipio)

# DF con la clasificación de la variable principal de los lugares de procedencia de los viajeros alojados.
rk_viajeros_lugar_mun <- df_viajeros_lugar_mun %>%
  arrange(valor) %>%
  select(lugar, valor)
rk_viajeros_lugar_mun <- rk_viajeros_lugar_mun %>% mutate(porcentaje = rk_viajeros_lugar_mun$valor/ Num_Viajeros_num * 100)
rk_viajeros_lugar_mun$lugar <- ordered(rk_viajeros_lugar_mun$lugar, levels = rk_viajeros_lugar_mun$lugar)

# DF de los valores de la variable para el municipio y periodo seleccionados.
df_viajeros_lugar_C <- df_viajeros_lugar %>%
  filter(mun == "ES70") %>%
  select(lugar, valor)
df_viajeros_lugar_mun <- df_viajeros_lugar_mun %>%
  mutate(porcentaje = df_viajeros_lugar_mun$valor / Num_Viajeros_num * 100,
         valor_Canarias = df_viajeros_lugar_C$valor,
         porcentaje_Canarias = df_viajeros_lugar_C$valor / num_Canarias_total * 100)

df_viajeros_lugar_plot <- df_viajeros_lugar_mun %>%
  mutate(label = "|")
df_viajeros_lugar_plot$lugar <- ordered(df_viajeros_lugar_plot$lugar, levels = rk_viajeros_lugar_mun$lugar)

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_viajeros_lugar_plot <- df_viajeros_lugar_plot %>% transform(hovertext = paste0(
  "<b>", trimws(lugar), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_viajeros_lugar_0 <- df_viajeros_lugar_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_viajeros_lugar_plot <- rbind(df_viajeros_lugar_plot, df_viajeros_lugar_0)

# Representación gráfica de un diagrama de barras ordenadas de manera descendente.
g_viajeros_lugar <- ggplot(df_viajeros_lugar_plot, aes(y = lugar, fill = lugar, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  scale_fill_manual(values = c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980", "#00405B")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_viajeros_lugar <- ggplotly(g_viajeros_lugar, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(9:17))
```

```{r Indicadores Lugar/Islas}
# DF de los valores de la variable para el municipio y periodo seleccionados de todas las modalidades de los lugares de residencia.
df_mun <- df_u_ %>%
  filter(mun == params$id_municipio & periodo == mes_actual$code & ind == "Viajeros alojados") %>%
  select(lugar, valor)

# DF de los valores de la variable para las modalidades de los lugares de residencia de España y extrajero respecto al total de viajeros.
df_viajeros_nacionalidad_mun <- df_mun %>%
  filter(lugar %in% c("España", " TOTAL RESIDENTES EN EL EXTRANJERO"))
df_viajeros_nacionalidad_mun <- df_viajeros_nacionalidad_mun %>%
  mutate(porcentaje = df_viajeros_nacionalidad_mun$valor / Num_Viajeros_num * 100)

# Indicadores.
peso_española <- df_viajeros_nacionalidad_mun$porcentaje[which(df_viajeros_nacionalidad_mun$lugar == "España")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
peso_extranjera <- df_viajeros_nacionalidad_mun$porcentaje[which(df_viajeros_nacionalidad_mun$lugar == " TOTAL RESIDENTES EN EL EXTRANJERO")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()

# DF de los valores de la variable para las modalidades de los lugares de residencia de España y total respecto a los viajeros canarios.
df_viajeros_canarios_mun <- df_mun %>%
  filter(lugar %in% c("  Canarias", "España", "TOTAL LUGARES DE RESIDENCIA"))
df_viajeros_canarios_mun <- df_viajeros_canarios_mun %>%
  mutate(porcentaje = df_viajeros_canarios_mun$valor[which(df_viajeros_canarios_mun$lugar == "  Canarias")] / df_viajeros_canarios_mun$valor * 100)

# Indicadores.
peso_Canarias_Esp <- df_viajeros_canarios_mun$porcentaje[which(df_viajeros_canarios_mun$lugar == "España")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
peso_Canarias_Tot <- df_viajeros_canarios_mun$porcentaje[which(df_viajeros_canarios_mun$lugar == "TOTAL LUGARES DE RESIDENCIA")] %>% round(1) %>% format(big.mark = ".", decimal.mark = ",", nsmall = 1) %>% as.character()
```

```{r Barras Islas}
aloj_isla <- fromJSON(params$url.aloj_isla)

# DF de la variable principal desagregada por islas de residencia de Canarias por municipios de alojamiento de Canarias y periodos.
df_aloj_isla <- cbind(data.frame(do.call('rbind', aloj_isla[["data"]][["dimCodes"]])), aloj_isla[["data"]][["Valor"]])
colnames(df_aloj_isla) <- c('ind', 'lugar', 'mun', 'periodo', 'valor')
df_aloj_isla$ind <- factor(df_aloj_isla$ind, levels=aloj_isla[["categories"]][["codes"]][[1]], labels=aloj_isla[["categories"]][["labels"]][[1]])
df_aloj_isla$lugar <- factor(df_aloj_isla$lugar, levels=aloj_isla[["categories"]][["codes"]][[2]], labels=aloj_isla[["categories"]][["labels"]][[2]])
df_aloj_isla$mun <- factor(df_aloj_isla$mun, levels=aloj_isla[["categories"]][["codes"]][[3]], labels=aloj_isla[["categories"]][["labels"]][[3]])
df_aloj_isla$periodo <- paste0(substring(df_aloj_isla$periodo, 0,4), "-", substring(df_aloj_isla$periodo, 6,7))
df_aloj_isla$valor <- as.numeric(df_aloj_isla$valor)
df_aloj_isla$mun <- recode_mun(df_aloj_isla, 'mun')
df_aloj_isla <- df_aloj_isla %>% transform(lugar = gsub("Residencia en ", "", lugar))

num_viajeros_islas_mun <- df_u_ %>%
  filter(mun == params$id_municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar == "  Canarias") %>% select(valor) %>% as.numeric()
num_viajeros_islas_C <- df_u_ %>%
  filter(mun == "ES70" & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar == "  Canarias") %>% select(valor) %>% as.numeric()

# DF con la clasificación de la variable principal desagregadas por islas de procedencia.
rk_aloj_isla_mun <- df_aloj_isla %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>%
  arrange(valor) %>%
  select(lugar, valor)
rk_aloj_isla_mun <- rk_aloj_isla_mun %>% mutate(porcentaje = rk_aloj_isla_mun$valor/ num_viajeros_islas_mun * 100)
rk_aloj_isla_mun$lugar <- ordered(rk_aloj_isla_mun$lugar, levels = rk_aloj_isla_mun$lugar)

# DF de la variable principal desagregada por islas de procedencia para el municipio y periodo seleccionados.
df_aloj_isla_mun <- df_aloj_isla %>%
  filter(mun == municipio_actual$municipio & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>% select(lugar, valor)
# DF de la variable principal desagregada por islas de procedencia en Canarias para el periodo seleccionado.
df_aloj_isla_C <- df_aloj_isla %>%
  filter(mun == "CANARIAS" & periodo == mes_actual$code & ind == "Viajeros alojados" & lugar != "Canarias") %>% select(lugar, valor)
df_aloj_isla_mun <- df_aloj_isla_mun %>%
  mutate(porcentaje = df_aloj_isla_mun$valor / num_viajeros_islas_mun * 100,
         valor_Canarias = df_aloj_isla_C$valor,
         porcentaje_Canarias = df_aloj_isla_C$valor / num_viajeros_islas_C * 100)

df_aloj_isla_plot <- df_aloj_isla_mun %>%
  mutate(label = "|")
df_aloj_isla_plot$lugar <- ordered(df_aloj_isla_plot$lugar, levels = rk_aloj_isla_mun$lugar)

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_aloj_isla_plot <- df_aloj_isla_plot %>% transform(hovertext = paste0(
  "<b>", trimws(lugar), "</b><br>",
  trimws(format(valor, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje, 1), big.mark = ".", decimal.mark = ",")), "%)",
  "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")),
  " (", trimws(format(round(porcentaje_Canarias, 1), big.mark = ".", decimal.mark = ",")), "%)"
  )
)

df_aloj_isla_0 <- df_aloj_isla_plot %>% 
  transform(porcentaje = 0,
            porcentaje_Canarias = 0,
            label = "")

df_aloj_isla_plot <- rbind(df_aloj_isla_plot, df_aloj_isla_0)

# Representación gráfica de un diagrama de barras ordenadas de manera descendente.
g_aloj_isla <- ggplot(data = df_aloj_isla_plot, aes(y = lugar, fill = lugar, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = porcentaje)) +
  geom_text(size = 7, color = "#59656E", aes(x = porcentaje_Canarias, text = "")) +
  theme_minimal() +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("#D5EDFA", "#8CD2EA", "#2CBCE2", "#00A6DC", "#008BD0", "#0072A2", "#005980")) +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), '%')})

g_aloj_isla <- ggplotly(g_aloj_isla, tooltip = c("text")) %>%
  layout(hovermode = 'y unified', margin = list(l = 0, r = 0)) %>%
  config(displaylogo = FALSE,  modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(8:14))
```

```{r Tipos de alojamiento}
hoteles <- fromJSON(params$url.hotel)

# Establecimientos hoteleros abiertos, plazas ofertadas y habitaciones disponibles según categorías por municipios de alojamiento de Canarias y periodos.
df_hoteles <- cbind(data.frame(do.call('rbind', hoteles[["data"]][["dimCodes"]])), hoteles[["data"]][["Valor"]])
colnames(df_hoteles) <- c('ind', 'cat', 'mun', 'periodo', 'valor')
df_hoteles$ind <- factor(df_hoteles$ind, levels=hoteles[["categories"]][["codes"]][[1]], labels=hoteles[["categories"]][["labels"]][[1]])
df_hoteles$cat <- factor(df_hoteles$cat, levels=hoteles[["categories"]][["codes"]][[2]], labels=hoteles[["categories"]][["labels"]][[2]])
df_hoteles$mun <- factor(df_hoteles$mun, levels=hoteles[["categories"]][["codes"]][[3]], labels=hoteles[["categories"]][["labels"]][[3]])
df_hoteles$periodo <- factor(df_hoteles$periodo, levels=hoteles[["categories"]][["codes"]][[4]], labels=hoteles[["categories"]][["labels"]][[4]])
df_hoteles$valor <- as.numeric(df_hoteles$valor)
df_hoteles$mun <- recode_mun(df_hoteles, 'mun')
df_hoteles <- df_hoteles %>% mutate(ind = recode(ind, "Establecimientos hoteleros abiertos" = "Establecimientos"),
                                    ind = recode(ind, "Plazas ofertadas" = "Plazas"),
                                    ind = recode(ind, "Habitaciones disponibles" = "Habitaciones/Apartamentos"))

# DF de los hoteles para el municipio y periodo seleccionados por número de establecimientos, plazas y habitaciones.
df_hoteles_mun <- df_hoteles %>%
  filter(cat == "TOTAL CATEGORÍAS" & mun == municipio_actual$municipio & periodo == mes_actual$periodo) %>% 
  select(ind, valor_hoteles = valor)

# Establecimientos extrahoteleros abiertos, plazas ofertadas y habitaciones disponibles según categorías por municipios de alojamiento de Canarias y periodos. 2009M01 a 2021M04.
extrahoteleros <- fromJSON(params$url.extrahoteleros)
df_extrahoteleros <- cbind(data.frame(do.call('rbind', extrahoteleros[["data"]][["dimCodes"]])), extrahoteleros[["data"]][["Valor"]])
colnames(df_extrahoteleros) <- c('ind', 'cat', 'mun', 'periodo', 'valor')
df_extrahoteleros$ind <- factor(df_extrahoteleros$ind, levels=extrahoteleros[["categories"]][["codes"]][[1]], labels=extrahoteleros[["categories"]][["labels"]][[1]])
df_extrahoteleros$cat <- factor(df_extrahoteleros$cat, levels=extrahoteleros[["categories"]][["codes"]][[2]], labels=extrahoteleros[["categories"]][["labels"]][[2]])
df_extrahoteleros$mun <- factor(df_extrahoteleros$mun, levels=extrahoteleros[["categories"]][["codes"]][[3]], labels=extrahoteleros[["categories"]][["labels"]][[3]])
df_extrahoteleros$periodo <- factor(df_extrahoteleros$periodo, levels=extrahoteleros[["categories"]][["codes"]][[4]], labels=extrahoteleros[["categories"]][["labels"]][[4]])
df_extrahoteleros$valor <- as.numeric(df_extrahoteleros$valor)
df_extrahoteleros$mun <- recode_mun(df_extrahoteleros, 'mun')
df_extrahoteleros <- df_extrahoteleros %>% mutate(ind = recode(ind, "Establecimientos abiertos" = "Establecimientos"),
                                                  ind = recode(ind, "Plazas ofertadas" = "Plazas"),
                                                  ind = recode(ind, "Apartamentos disponibles" = "Habitaciones/Apartamentos"))

# DF de los establecimeintos extrahoteleros para el municipio y periodo seleccionados por número de establecimientos, plazas y apartamentos.
df_extrahoteleros_mun <- df_extrahoteleros %>%
  filter(cat == "TOTAL CATEGORÍAS" & mun == municipio_actual$municipio & periodo == mes_actual$periodo) %>% 
  select(ind, valor_extrahoteleros = valor)

# DF conjuntos de los dos tipos de establecimientos.
df_establecimientos_mun <- df_hoteles_mun %>% 
  left_join(df_extrahoteleros_mun, by = "ind")

# Indicadores.
Num_Hoteles <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Establecimientos")] %>% format(big.mark = ".", decimal.mark = ",")
Plazas_Hoteles <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Plazas")] %>% format(big.mark = ".", decimal.mark = ",")
Num_Habitaciones <- df_establecimientos_mun$valor_hoteles[which(df_establecimientos_mun$ind == "Habitaciones/Apartamentos")] %>% format(big.mark = ".", decimal.mark = ",")
Num_extrahoteleros <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Establecimientos")] %>% format(big.mark = ".", decimal.mark = ",")
Plazas_extrahoteleros <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Plazas")] %>% format(big.mark = ".", decimal.mark = ",")
Num_Apartamentos <- df_establecimientos_mun$valor_extrahoteleros[which(df_establecimientos_mun$ind == "Habitaciones/Apartamentos")] %>% format(big.mark = ".", decimal.mark = ",")
```

<!-- HTML -->
<h2 style="color: #005980; margin-bottom: 0;">`r Num_Viajeros` personas alojadas</h2>

```{r funciones mapa}
# Función para el código antes del mapa cuyo parámetro es el número de columnas, que dependerá de si hay algún dato de los establecimientos turísticos.
get_map_box_before = function(column_number, aditional_classes = '') {
  return(sprintf('<div class="column-%s"><div class="indicator-map %s"><div class="image">', column_number, aditional_classes))
}
# Función para el código después del mapa cuyos parámetros son el ranking territorial, el nombre del territorio, número de municipios en ese territorio y porcentaje.
get_map_box_after = function(rank, territorio, n_municipios, percent) {
  return(sprintf('</div><div class="indicator-content"><p class="label"><span class="value">%s </span>en %s</p><p class="label2">de %s municipios (%s)</p></div></div></div>', rank, territorio, n_municipios, percent))
}
```

<div class="row" style="margin-top:10px;">
`r if_else(Plazas_Hoteles == "NA" & Plazas_extrahoteleros == "NA", get_map_box_before(2, 'map-canarias'), get_map_box_before(3, 'map-canarias'))`
```{r}
mapa_Canarias_plot
```
`r get_map_box_after(paste0(rk_canarias, 'º'), 'Canarias', num_mun_canarias, paste0(percent_canarias, '%'))`

`r if_else(Plazas_Hoteles == "NA" & Plazas_extrahoteleros == "NA", get_map_box_before(2), get_map_box_before(3))`
```{r}
mapa_isla_plot
```
`r get_map_box_after(paste0(rk_isla, 'º'),  municipio_actual$isla, num_mun_isla, paste0(percent_isla, '%'))`

```{r Indicadores tipos de alojamiento, results='asis'}
# Tercer recuadro que sustituye al ranking comarcal que aparecerá en los municipios para los que haya algún dato de los establecimientos.
if(Plazas_Hoteles == "NA" & Plazas_extrahoteleros != "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 38px;"><div class="row"><p class="label"><span class="value">', Num_extrahoteleros,' </span> Apartamentos</p></div><div class="row"><p class="label2" style="margin-top: 31px;"><span class="value2">', Plazas_extrahoteleros,' </span>plazas</p></div><div class="row"><p class="label2" style="margin-top: 10px;"><span class="value2">', Num_Apartamentos,' </span>apartamentos</p></div></div></div></div></div>'))
}else if(Plazas_Hoteles != "NA" & Plazas_extrahoteleros == "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 38px;"><div class="row"><p class="label"><span class="value">', Num_Hoteles,' </span> Hoteles</p></div><div class="row"><p class="label2" style="margin-top: 31px;"><span class="value2">', Plazas_Hoteles,' </span>plazas</p></div><div class="row"><p class="label2" style="margin-top: 10px;"><span class="value2">', Num_Habitaciones,' </span>habitaciones</p></div></div></div></div></div>'))
}else if(Plazas_Hoteles != "NA" & Plazas_extrahoteleros != "NA"){
  cat(paste0('<div class="column-3"><div class="column" style="width: 100% !important;"><div class="indicator-map" style="margin-top: -5px;"><div class="indicator-content" style="margin-top: -10px; padding: 8px;"><div class="row"><p class="label"><span class="value">', Num_Hoteles,' </span> Hoteles</p></div><div class="row"><p class="label2" style="margin-top: 12px;"><span class="value2">', Plazas_Hoteles,' </span>plazas en <span class="value2">', Num_Habitaciones,' </span>habitaciones</p></div></div></div><div class="indicator-map" style="margin-top: 14px;"><div class="indicator-content" style="margin-top: -10px; padding: 8px;"><div class="row"><p class="label"><span class="value">', Num_extrahoteleros,' </span> Apartamentos</p></div><div class="row"><p class="label2" style="margin-top: 12px;"><span class="value2">', Plazas_extrahoteleros,' </span>plazas en <span class="value2">', Num_Apartamentos,' </span>apartamentos</p></div></div></div></div></div>'))
}
```

</div>

<div class="row">
<div class="column indicator-title">
  <h3>Nacionalidades</h3>
</div>
<div class="column indicator-title">
  <h3>Islas de residencia</h3>
</div>
</div>

<div class="row">

<div class="column highlight">

<div class="piramide" style="height: 330px;">
  `r g_viajeros_lugar`
</div>

<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
  <div class='progress-bar-C-a'>|</div><div class='sp-content-b'>Canarias</div></div>
</div>

<div class="row" style="margin: 24px 0 20px;">
  <div class="column-2">`r get_indicator3('España', paste0(peso_española, '%'), './img/spain2.png')`</div>
  <div class="column-2">`r get_indicator3('Extranjero', paste0(peso_extranjera, '%'), './img/world.png')`</div>
</div>

</div>

<div class="column highlight">

<div class="piramide" style="height: 330px;">
  `r g_aloj_isla`
</div>
<div class="progressbar-legend-container" style="margin-top:10px;">
<div class='progressbar-legend'>
  <div class='progress-bar-C-a'>|</div><div class='sp-content-b'>Canarias</div></div>
</div>

<div class="row" style="margin: 14px 0 6px;">
  <div class="column-2">`r get_indicator3s('Canarias respecto</br>a España', paste0(peso_Canarias_Esp, "%"))`</div>
  <div class="column-2">`r get_indicator3s('Canarias respecto</br>al total', paste0(peso_Canarias_Tot, "%"))`</div>
</div>
</div>

</div>


```{r Periodo}
# DF con los periodos y sus códigos.
GM_sexo_edad <- fromJSON(params$url.GM_sexo_edad)
periodo <- data.frame(code = GM_sexo_edad[["categories"]][["codes"]][[5]], 
                      periodo = GM_sexo_edad[["categories"]][["labels"]][[5]]) %>% 
  filter(substring(code, 5,5) == "Q")

# DF incluyendo como debe aparecer el trimestre escrito en la ficha y el orden para construir la serie.
periodo <- periodo %>% 
  transform(periodo_formatted = paste0(unlist(lapply(strsplit(periodo, " "), '[[', 2)), " trimestre de ", unlist(lapply(strsplit(periodo, " "), '[[', 1)))) %>% 
  mutate(order = as.integer(order(code, decreasing = FALSE)))
# Trimestre que se seleccionó.
periodo_actual <- periodo %>% filter(substring(code, 0,4) == params$año & as.numeric(substring(code, 6,7)) == params$trimestre)
periodo_tva <- periodo[periodo$order == periodo[periodo_actual$code == periodo$code, ]$order - 4, ]
```

```{r DF de los gastos medios turísticos}
# DF de los gastos medios según sexos y grupos de edades por municipios turísticos de Canarias y periodos.
df_GM_sexo_edad <- cbind(data.frame(do.call('rbind', GM_sexo_edad[["data"]][["dimCodes"]])), GM_sexo_edad[["data"]][["Valor"]])
colnames(df_GM_sexo_edad) <- c('ind', 'sexo', 'gredad', 'mun', 'periodo', 'valor')
df_GM_sexo_edad$ind <- factor(df_GM_sexo_edad$ind, levels=GM_sexo_edad[["categories"]][["codes"]][[1]], labels=GM_sexo_edad[["categories"]][["labels"]][[1]])
df_GM_sexo_edad$sexo <- factor(df_GM_sexo_edad$sexo, levels=GM_sexo_edad[["categories"]][["codes"]][[2]], labels=GM_sexo_edad[["categories"]][["labels"]][[2]])
df_GM_sexo_edad$gredad <- factor(df_GM_sexo_edad$gredad, levels=GM_sexo_edad[["categories"]][["codes"]][[3]], labels=GM_sexo_edad[["categories"]][["labels"]][[3]])
df_GM_sexo_edad$valor <- as.numeric(df_GM_sexo_edad$valor) %>% round(0)

# DF de los valores de la variable principal en todos los periodos y municipios canarios.
df_u <- df_GM_sexo_edad %>% filter(ind == "Gasto por turista" & sexo == "AMBOS SEXOS" & gredad == "TOTAL GRUPOS DE EDADES" & substring(periodo, 5,5) == "Q") %>% 
  select(mun, periodo, valor)
df_u <- df_u %>% filter(substring(mun, 6,6) == "_") %>% transform(mun = substr(mun, 7, 12))
# DF ordenado temporalmente.
df_u <- df_u[with(df_u, order(periodo)), ]

# Se aplica la función para seleccionar municipios relacionados en el periodo escogido.
related_mun <- df_u %>% filter(periodo == periodo_actual$code)
related_mun <- seleccion_mun(related_mun %>% select(mun , valor), 'valor')

# DF de los valores en los tres municipios relacionados.
df <- related_mun %>%
  select(mun = "mun", nombre) %>%
  left_join(df_u, by = "mun") %>%
  select(id = mun, nombre, periodo, valor) %>%
  left_join(df_CL_AREA_mun, by = "id") %>%
  select(code = periodo, mun = id, nombre, valor) %>%
  left_join(periodo, by = "code") %>%
  mutate(tasa = ifelse(substring(code, 0,4) == min(substring(code, 0,4)), NA, round(100*((valor / lag(valor, n = 4)) - 1), 1))) %>% 
  filter(code <= periodo_actual$code)
```

```{r Indicadores Gastos Medios}
df_GM_sexo_edad$mun <- factor(df_GM_sexo_edad$mun, levels=GM_sexo_edad[["categories"]][["codes"]][[4]], labels=GM_sexo_edad[["categories"]][["labels"]][[4]])
df_GM_sexo_edad$mun <- recode_mun(df_GM_sexo_edad, 'mun')

# DF de los indicadores para el municipio y trimestre seleccionados.
ind_GM_sexo_edad <- df_GM_sexo_edad %>% filter(mun == municipio_actual$municipio & periodo == periodo_actual$code)

Gasto_por_turista <- ind_GM_sexo_edad %>%
  filter(sexo == "AMBOS SEXOS" & gredad == "TOTAL GRUPOS DE EDADES" & ind == "Gasto por turista") %>% select(valor) %>% as.numeric() %>% format(big.mark = ".", decimal.mark = ",")

# DF de los indicadores desagregados por grupos de edad en el municipio.
df_GM_edad_mun <- ind_GM_sexo_edad %>%
  filter(ind == "Gasto por turista" & sexo == "AMBOS SEXOS" & gredad != "TOTAL GRUPOS DE EDADES") %>% 
  select(gredad, valor)

Gasto_por_turista_menor <- df_GM_edad_mun$valor[which(df_GM_edad_mun$gredad == "De 16 a 44 años")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_por_turista_mayor <- df_GM_edad_mun$valor[which(df_GM_edad_mun$gredad == "Mayor de 44 años")] %>% format(big.mark = ".", decimal.mark = ",")

# DF de los indicadores desagregados por grupos de edad en Canarias.
df_GM_sexo_edad_C <- df_GM_sexo_edad %>%
  select(ind, sexo, gredad, mun, periodo, valor) %>%
  filter(ind == "Gasto por turista" & sexo == "AMBOS SEXOS" & gredad != "TOTAL GRUPOS DE EDADES" & mun == "CANARIAS" & periodo == periodo_actual$code)

Gasto_por_turista_menor_C <- df_GM_sexo_edad_C$valor[which(df_GM_sexo_edad_C$gredad == "De 16 a 44 años")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_por_turista_mayor_C <- df_GM_sexo_edad_C$valor[which(df_GM_sexo_edad_C$gredad == "Mayor de 44 años")] %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Rankings territoriales GM}
# DF de todos los municipios canarios ordenados por el valor de la variable principal de mayor a menor en el periodo escogido.
df_ranking <- df_u %>%
  select(id = mun, periodo, valor) %>%
  filter(periodo == periodo_actual$code & !is.na(valor)) %>%
  inner_join(df_CL_AREA_mun, by = "id") %>% 
  arrange(desc(valor))

# Posición y porcentaje respecto a todos.
df_tur_mun <- df_ranking[which(df_ranking$id==params$id_municipio),]
rk_canarias <- grep(params$id_municipio, df_ranking$id)
num_mun_canarias <- nrow(df_ranking)
percent_canarias <- format(round(df_tur_mun$valor / sum(df_ranking$valor, na.rm = TRUE) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)

# Posición y porcentaje respecto a los municipios de la misma isla.
df_tur_isla <- df_ranking %>% filter(isla == df_tur_mun$isla)
rk_isla <- grep(params$id_municipio, df_tur_isla$id)
num_mun_isla <- nrow(df_tur_isla)
percent_isla <- format(round(df_tur_mun$valor / sum(df_tur_isla$valor, na.rm = TRUE) * 100, 1), big.mark = ".", decimal.mark = ",", nsmall = 1)
```

```{r Indicadores Gastos Medios Situación laboral}
GM_sl <- fromJSON(params$url.GM_sl)

# DF de los gastos medios según situación laboral por municipios turísticos de Canarias y periodos.
df_GM_sl <- cbind(data.frame(do.call('rbind', GM_sl[["data"]][["dimCodes"]])), GM_sl[["data"]][["Valor"]])
colnames(df_GM_sl) <- c('ind', 'sl','mun', 'periodo', 'valor')
df_GM_sl$ind <- factor(df_GM_sl$ind, levels=GM_sl[["categories"]][["codes"]][[1]], labels=GM_sl[["categories"]][["labels"]][[1]])
df_GM_sl$sl <- factor(df_GM_sl$sl, levels=GM_sl[["categories"]][["codes"]][[2]], labels=GM_sl[["categories"]][["labels"]][[2]])
df_GM_sl$mun <- factor(df_GM_sl$mun, levels=GM_sl[["categories"]][["codes"]][[3]], labels=GM_sl[["categories"]][["labels"]][[3]])
df_GM_sl$valor <- as.numeric(df_GM_sl$valor) %>% round(0)
df_GM_sl$mun <- recode_mun(df_GM_sl, 'mun')

# DF de la variable principal desagregada por situaciones laborales en el municipio y trimestre escogidos.
df_GM_sl_mun <- df_GM_sl %>%
  filter(ind == "Gasto por turista" & sl != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(sl, valor)

Gasto_tur_sl_Act <- df_GM_sl_mun$valor[which(df_GM_sl_mun$sl == "Activos")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_tur_sl_NAct <- df_GM_sl_mun$valor[which(df_GM_sl_mun$sl == "Inactivos")] %>% format(big.mark = ".", decimal.mark = ",")

# DF de la variable principal desagregada por situaciones laborales en Canarias para el trimestre escogido.
df_GM_sl_C <- df_GM_sl %>%
  filter(ind == "Gasto por turista" & sl != "TOTAL" & mun == "CANARIAS" & periodo == periodo_actual$code) %>% 
  select(sl, valor)

Gasto_tur_sl_Act_C <- df_GM_sl_C$valor[which(df_GM_sl_C$sl == "Activos")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_tur_sl_NAct_C <- df_GM_sl_C$valor[which(df_GM_sl_C$sl == "Inactivos")] %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Barras Gastos Medios Niveles de ingresos}
GM_ni <- fromJSON(params$url.GM_ni)

# DF de la variable principal desagregada según niveles de ingresos por municipios turísticos de Canarias y periodos.
df_GM_ni <- cbind(data.frame(do.call('rbind', GM_ni[["data"]][["dimCodes"]])), GM_ni[["data"]][["Valor"]])
colnames(df_GM_ni) <- c('ind', 'nivel','mun', 'periodo', 'valor')
df_GM_ni$ind <- factor(df_GM_ni$ind, levels=GM_ni[["categories"]][["codes"]][[1]], labels=GM_ni[["categories"]][["labels"]][[1]])
df_GM_ni$nivel <- factor(df_GM_ni$nivel, levels=GM_ni[["categories"]][["codes"]][[2]], labels=GM_ni[["categories"]][["labels"]][[2]])
df_GM_ni$mun <- factor(df_GM_ni$mun, levels=GM_ni[["categories"]][["codes"]][[3]], labels=GM_ni[["categories"]][["labels"]][[3]])
df_GM_ni$valor <- as.numeric(df_GM_ni$valor) %>% round(0)
df_GM_ni$mun <- recode_mun(df_GM_ni, 'mun')
df_GM_ni <- df_GM_ni %>% mutate(nivel = recode(nivel, "Menos de 25.000€" = "< 25.000 €"),
                                nivel = recode(nivel, "25.000€ - 49.999€" = "25.000 € - 49.999 €"),
                                nivel = recode(nivel, "50.000€ - 74.999€" = "50.000 € - 74.999 €"),
                                nivel = recode(nivel, "75.000€ o más" = "> 74.999 €"))

# DF de la variable principal desagregada por niveles de ingresos en el municipio y periodo seleccionados.
df_GM_ni_mun <- df_GM_ni %>%
  filter(ind == "Gasto por turista" & nivel != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(nivel, valor)

# DF de la variable principal desagregada por niveles de ingresos en Canarias para el periodo seleccionado.
df_GM_ni_Canarias <- df_GM_ni %>%
  filter(ind == "Gasto por turista" & nivel != "TOTAL" & mun == "CANARIAS" & periodo == periodo_actual$code) %>% 
  select(nivel, valor)

df_GM_ni_plot <- df_GM_ni_mun %>%
  mutate(valor_Canarias = df_GM_ni_Canarias$valor,
         label = "|")
df_GM_ni_plot$nivel <- ordered(df_GM_ni_plot$nivel, levels = df_GM_ni_plot$nivel)

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_GM_ni_plot <- df_GM_ni_plot %>% transform(hovertext = paste0(
    "<b>", nivel, "</b>",
    "<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")), " €"
    )
  )

df_GM_ni_0 <- df_GM_ni_plot %>% 
  transform(valor = 0,
            valor_Canarias = 0,
            label = "")

df_GM_ni_plot <- rbind(df_GM_ni_plot, df_GM_ni_0)

# Representación gráfica de un diagrama de barras.
g_GM_ni <- ggplot(df_GM_ni_plot, aes(y = nivel, fill = nivel, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = valor)) +
  geom_text(size = 6, color = "#59656E", aes(x = valor_Canarias, text = "")) +
  scale_fill_manual(values = c("> 74.999 €" = "#005980", "50.000 € - 74.999 €" = "#008BD0", "25.000 € - 49.999 €" = "#2CBCE2", "< 25.000 €" = "#8CD2EA")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), ' €')})

g_GM_ni <- ggplotly(g_GM_ni, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(5:8))
```

```{r Barras Gastos Medios Nivel educativo}
GM_ne <- fromJSON(params$url.GM_ne)

# DF de la variable principal desagregada según nivel educativo por municipios turísticos de Canarias y periodos.
df_GM_ne <- cbind(data.frame(do.call('rbind', GM_ne[["data"]][["dimCodes"]])), GM_ne[["data"]][["Valor"]])
colnames(df_GM_ne) <- c('ind', 'estudios','mun', 'periodo', 'valor')
df_GM_ne$ind <- factor(df_GM_ne$ind, levels=GM_ne[["categories"]][["codes"]][[1]], labels=GM_ne[["categories"]][["labels"]][[1]])
df_GM_ne$estudios <- factor(df_GM_ne$estudios, levels=GM_ne[["categories"]][["codes"]][[2]], labels=GM_ne[["categories"]][["labels"]][[2]])
df_GM_ne$mun <- factor(df_GM_ne$mun, levels=GM_ne[["categories"]][["codes"]][[3]], labels=GM_ne[["categories"]][["labels"]][[3]])
df_GM_ne$valor <- as.numeric(df_GM_ne$valor) %>% round(0)
df_GM_ne$mun <- recode_mun(df_GM_ne, 'mun')
df_GM_ne <- df_GM_ne %>% mutate(estudios = recode(estudios, "Sin estudios o estudios primarios" = "Sin estudios o primarios"),
                                estudios = recode(estudios, "Estudios secundarios" = "Secundarios"),
                                estudios = recode(estudios, "Estudios superiores" = "Superiores"))

# DF de la variable principal desagregada según nivel educativo en el municipio y periodo seleccionados.
df_GM_ne_mun <- df_GM_ne %>%
  filter(ind == "Gasto por turista" & estudios != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(estudios, valor)

# DF de la variable principal desagregada según nivel educativo en Canarias para el periodo seleccionado.
df_GM_ne_Canarias <- df_GM_ne %>%
  filter(ind == "Gasto por turista" & estudios != "TOTAL" & mun == "CANARIAS" & periodo == periodo_actual$code) %>%
  select(estudios, valor)
df_GM_ne_mun <- df_GM_ne_mun %>% mutate(valor_Canarias = df_GM_ne_Canarias$valor)

df_GM_ne_plot <- df_GM_ne_mun %>%
  mutate(label = "|")

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_GM_ne_plot <- df_GM_ne_plot %>% transform(hovertext = paste0(
    "<b>", estudios, "</b>",
    "<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")), " €"
    )
  )

df_GM_ne_0 <- df_GM_ne_plot %>% 
  transform(valor = 0,
            valor_Canarias = 0,
            label = "")

df_GM_ne_plot <- rbind(df_GM_ne_plot, df_GM_ne_0)

# Representación gráfica de un diagrama de barras.
g_GM_ne <- ggplot(df_GM_ne_plot, aes(y = estudios, fill = estudios, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = valor)) +
  geom_text(size = 6, color = "#59656E", aes(x = valor_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_blank(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), ' €')}, n.breaks = 3)

g_GM_ne <- ggplotly(g_GM_ne, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(4:6))
```

```{r Indicadores Gastos Medios Tipos de alojamiento}
GM_ta <- fromJSON(params$url.GM_ta)

# DF de la variable principal desagregada según tipos de alojamiento por municipios turísticos de Canarias y periodos.
df_GM_ta <- cbind(data.frame(do.call('rbind', GM_ta[["data"]][["dimCodes"]])), GM_ta[["data"]][["Valor"]])
colnames(df_GM_ta) <- c('ind', 'tipo','mun', 'periodo', 'valor')
df_GM_ta$ind <- factor(df_GM_ta$ind, levels=GM_ta[["categories"]][["codes"]][[1]], labels=GM_ta[["categories"]][["labels"]][[1]])
df_GM_ta$tipo <- factor(df_GM_ta$tipo, levels=GM_ta[["categories"]][["codes"]][[2]], labels=GM_ta[["categories"]][["labels"]][[2]])
df_GM_ta$mun <- factor(df_GM_ta$mun, levels=GM_ta[["categories"]][["codes"]][[3]], labels=GM_ta[["categories"]][["labels"]][[3]])
df_GM_ta$valor <- as.numeric(df_GM_ta$valor) %>% round(0)
df_GM_ta$mun <- recode_mun(df_GM_ta, 'mun')

# DF de la variable principal desagregada según tipos de alojamiento en el municipio y periodo seleccionados.
df_GM_ta_mun <- df_GM_ta %>%
  filter(ind == "Gasto por turista" & tipo != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(tipo, valor)

Gasto_tur_ta_hot <- df_GM_ta_mun$valor[which(df_GM_ta_mun$tipo == "Hoteleros")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_tur_ta_extr <- df_GM_ta_mun$valor[which(df_GM_ta_mun$tipo == "Extrahoteleros")] %>% format(big.mark = ".", decimal.mark = ",")
Gasto_tur_ta_otr <- df_GM_ta_mun$valor[which(df_GM_ta_mun$tipo == "Otros alojamientos colectivos")] %>% format(big.mark = ".", decimal.mark = ",")
```

```{r Barras Gastos Medios Noches pernoctadas}
GM_np <- fromJSON(params$url.GM_np)

# DF de la variable principal desagregada según número noches pernoctadas por municipios turísticos de Canarias y periodos.
df_GM_np <- cbind(data.frame(do.call('rbind', GM_np[["data"]][["dimCodes"]])), GM_np[["data"]][["Valor"]])
colnames(df_GM_np) <- c('ind', 'noches','mun', 'periodo', 'valor')
df_GM_np$ind <- factor(df_GM_np$ind, levels=GM_np[["categories"]][["codes"]][[1]], labels=GM_np[["categories"]][["labels"]][[1]])
df_GM_np$noches <- factor(df_GM_np$noches, levels=GM_np[["categories"]][["codes"]][[2]], labels=GM_np[["categories"]][["labels"]][[2]])
df_GM_np$mun <- factor(df_GM_np$mun, levels=GM_np[["categories"]][["codes"]][[3]], labels=GM_np[["categories"]][["labels"]][[3]])
df_GM_np$valor <- as.numeric(df_GM_np$valor) %>% round(0)
df_GM_np$mun <- recode_mun(df_GM_np, 'mun')
df_GM_np <- df_GM_np %>% mutate(noches = recode(noches, "De 1 a 7 noches" = "1 - 7"),
                                noches = recode(noches, "De 8 a 15 noches" = "8 - 15"),
                                noches = recode(noches, "Más de 15 noches" = "&gt; 15"))

# DF de la variable principal desagregada según número noches pernoctadas en el municipio y periodo seleccionados.
df_GM_np_mun <- df_GM_np %>%
  filter(ind == "Gasto por turista" & noches != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(noches, valor)

# DF de la variable principal desagregada según número noches pernoctadas en Canarias para el periodo seleccionado.
df_GM_np_Canarias <- df_GM_np %>%
  filter(ind == "Gasto por turista" & noches != "TOTAL" & mun == "CANARIAS" & periodo == periodo_actual$code) %>%
  select(noches, valor)
df_GM_np_mun <- df_GM_np_mun %>% mutate(valor_Canarias = df_GM_np_Canarias$valor)

df_GM_np_plot <- df_GM_np_mun %>%
  mutate(label = "|")

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_GM_np_plot <- df_GM_np_plot %>% transform(hovertext = paste0(
    "<b>", noches, "</b>",
    "<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")), " €"
    )
  )

df_GM_np_0 <- df_GM_np_plot %>% 
  transform(valor = 0,
            valor_Canarias = 0,
            label = "")

df_GM_np_plot <- rbind(df_GM_np_plot, df_GM_np_0)

# Representación gráfica de un diagrama de barras.
g_GM_np <- ggplot(df_GM_np_plot, aes(y = noches, fill = noches, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = valor)) +
  geom_text(size = 6, color = "#59656E", aes(x = valor_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_blank(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), ' €')}, n.breaks = 3)

g_GM_np <- ggplotly(g_GM_np, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(4:6))
```

```{r Barras Gastos Medios Paquete turístico}
GM_pt <- fromJSON(params$url.GM_pt)

# DF de la variable principal desagregada según paquete turístico por municipios turísticos de Canarias y periodos.
df_GM_pt <- cbind(data.frame(do.call('rbind', GM_pt[["data"]][["dimCodes"]])), GM_pt[["data"]][["Valor"]])
colnames(df_GM_pt) <- c('paquete','mun', 'periodo', 'valor')
df_GM_pt$paquete <- factor(df_GM_pt$paquete, levels=GM_pt[["categories"]][["codes"]][[1]], labels=GM_pt[["categories"]][["labels"]][[1]])
df_GM_pt$mun <- factor(df_GM_pt$mun, levels=GM_pt[["categories"]][["codes"]][[2]], labels=GM_pt[["categories"]][["labels"]][[2]])
df_GM_pt$valor <- as.numeric(df_GM_pt$valor) %>% round(0)
df_GM_pt$mun <- recode_mun(df_GM_pt, 'mun')
df_GM_pt <- df_GM_pt %>% mutate(paquete = recode(paquete, "TOTAL" = "Paquete turístico"),
                                paquete = recode(paquete, "Con servicios extras" = "Paquete con servicios extras"),
                                paquete = recode(paquete, "Sin servicios extras" = "Paquete sin servicios extras"))

# DF de la variable principal desagregada según paquete turístico en el municipio y periodo seleccionados.
df_GM_pt_mun <- df_GM_pt %>%
  filter(mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% 
  select(paquete, valor)

# DF de la variable principal desagregada según paquete turístico en Canarias para el periodo seleccionado.
df_GM_pt_Canarias <- df_GM_pt %>%
  filter(mun == "CANARIAS" & periodo == periodo_actual$code) %>%
  select(paquete, valor)
df_GM_pt_mun <- df_GM_pt_mun %>% mutate(valor_Canarias = df_GM_pt_Canarias$valor)
df_GM_pt_mun$paquete <- ordered(df_GM_pt_mun$paquete, levels = df_GM_pt_mun$paquete[3:1])

df_GM_pt_plot <- df_GM_pt_mun %>%
  mutate(label = "|")
df_GM_pt_plot$paquete <- ordered(df_GM_pt_plot$paquete, levels = df_GM_pt_plot$paquete[3:1])

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_GM_pt_plot <- df_GM_pt_plot %>% transform(hovertext = paste0(
    "<b>", paquete, "</b>",
    "<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")), " €"
    )
  )

df_GM_pt_0 <- df_GM_pt_plot %>% 
  transform(valor = 0,
            valor_Canarias = 0,
            label = "")

df_GM_pt_plot <- rbind(df_GM_pt_plot, df_GM_pt_0)

# Representación gráfica de un diagrama de barras.
g_GM_pt <- ggplot(df_GM_pt_plot, aes(y = paquete, fill = paquete, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = valor)) +
  geom_text(size = 6, color = "#59656E", aes(x = valor_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_blank(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), ' €')}, n.breaks = 3)

g_GM_pt <- ggplotly(g_GM_pt, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(4:6))
```

```{r Barras Gastos Medios País}
GM_pais <- fromJSON(params$url.GM_pais)

# DF de la variable principal desagregada según países de residencia por municipios turísticos de Canarias y periodos.
df_GM_pais <- cbind(data.frame(do.call('rbind', GM_pais[["data"]][["dimCodes"]])), GM_pais[["data"]][["Valor"]])
colnames(df_GM_pais) <- c('ind', 'pais', 'mun', 'periodo', 'valor')
df_GM_pais$ind <- factor(df_GM_pais$ind, levels=GM_pais[["categories"]][["codes"]][[1]], labels=GM_pais[["categories"]][["labels"]][[1]])
df_GM_pais$pais <- factor(df_GM_pais$pais, levels=GM_pais[["categories"]][["codes"]][[2]], labels=GM_pais[["categories"]][["labels"]][[2]])
df_GM_pais$mun <- factor(df_GM_pais$mun, levels=GM_pais[["categories"]][["codes"]][[3]], labels=GM_pais[["categories"]][["labels"]][[3]])
df_GM_pais$valor <- as.numeric(df_GM_pais$valor) %>% round(0)
df_GM_pais$valor[is.na(df_GM_pais$valor)] <- 0
df_GM_pais$mun <- recode_mun(df_GM_pais, 'mun')
df_GM_pais <- df_GM_pais %>% transform(pais = gsub("Otros países", "Otros", pais))

# DF con la clasificación de la variable principal desagregadas por países de residencia.
rk_GM_pais_mun <- df_GM_pais %>%
  filter(ind == "Gasto por turista"  & pais != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>% arrange(valor) %>%
  select(pais, valor)
rk_GM_pais_mun$pais <- ordered(rk_GM_pais_mun$pais, levels = rk_GM_pais_mun$pais)

# DF de la variable principal desagregada según países de residencia en el municipio y periodo seleccionados.
df_GM_pais_mun <- df_GM_pais %>%
  filter(ind == "Gasto por turista"  & pais != "TOTAL" & mun == municipio_actual$municipio & periodo == periodo_actual$code) %>%
  select(pais, valor)

# DF de la variable principal desagregada según países de residencia en Canarias para el periodo seleccionado.
df_GM_pais_Canarias <- df_GM_pais %>%
  filter(ind == "Gasto por turista" & pais != "TOTAL" & mun == "CANARIAS" & periodo == periodo_actual$code) %>%
  select(pais, valor)
df_GM_pais_mun <- df_GM_pais_mun %>% mutate(valor_Canarias = df_GM_pais_Canarias$valor)
df_GM_pais_mun$pais <- ordered(df_GM_pais_mun$pais, levels = rk_GM_pais_mun$pais)

df_GM_pais_plot <- df_GM_pais_mun %>%
  mutate(label = "|")

# Texto emergente al pasar el cursor a lo largo de la representación gráfica.
df_GM_pais_plot <- df_GM_pais_plot %>% transform(hovertext = paste0(
    "<b>", pais, "</b>",
    "<br>", trimws(format(valor, big.mark = ".", decimal.mark = ",")), " €", 
    "<br>Canarias: ", trimws(format(valor_Canarias, big.mark = ".", decimal.mark = ",")), " €"
    )
  )

df_GM_pais_0 <- df_GM_pais_plot %>% 
  transform(valor = 0,
            valor_Canarias = 0,
            label = "")

df_GM_pais_plot <- rbind(df_GM_pais_plot, df_GM_pais_0)

# Representación gráfica de un diagrama de barras ordenadas de manera descendente.
g_GM_pais <- ggplot(df_GM_pais_plot, aes(y = pais, fill = pais, label = label, name = NULL, text = hovertext)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6, aes(x = valor)) +
  geom_text(size = 6, color = "#59656E", aes(x = valor_Canarias, text = "")) +
  scale_fill_manual(values = c("#8CD2EA", "#2CBCE2", "#008BD0", "#005980")) +
  theme_minimal() +
  guides(fill = guide_legend(title = " ")) +
  labs(title = "", x = NULL, y = NULL, colour = " ") +
  theme(axis.text.x = element_text(),
        axis.line = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgray"),
        panel.grid.minor.x = element_line(colour = "lightgray"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none") +
  scale_x_continuous(labels = function(x){paste0(format(x, big.mark = '.', decimal.mark = ","), ' €')})

g_GM_pais <- ggplotly(g_GM_pais, tooltip = c("text")) %>%
  layout(hoverlabel = "", hovermode = 'y unified') %>%
  config(displaylogo = FALSE, modeBarButtons = list(list("zoom2d"),list("pan2d"),list("resetScale2d"),list("toImage"))) %>%
  style(hoverinfo = "skip", traces = c(5:8))
```


```{r Generación HTML GM, results="asis"}
# Función para los indicadores de los gastos medios por grupos de edad y situaciones laborales (modalidad, valor en el municipio y valor en Canarias).
get_indicator4s = function(title, label, value) {
  return(sprintf("<div class='indicator4s'><div class='title'>%s</div><hr class='separator'><p class='value'>%s</p><p class='label'>%s</p><p class='label2'>Canarias</p></div>", title, value, label))
}
```

<!-- HTML -->
<h2 style="color: #005980; margin-bottom: 0;">`r Gasto_por_turista` €</h2>

<div class="row" style="margin-top:10px;">
<div class="column-3">
  <div class="indicator-map map-canarias">
  <div class="image">
```{r} 
mapa_Canarias_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_canarias`º </span>en Canarias</p>
  <p class="label2">de `r num_mun_canarias` municipios (`r percent_canarias`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map">
  <div class="image">
```{r} 
mapa_isla_plot
```
</div>
  <div class="indicator-content">
  <p class="label"><span class="value">`r rk_isla`º </span>en `r municipio_actual$isla`</p>
  <p class="label2">de `r num_mun_isla` municipios (`r percent_isla`%)</p>
  </div>
</div>
</div>
<div class="column-3">
<div class="indicator-map" style="heigth: 300px;">
  <div class="indicator-content" style="margin-top: 10px;">
  <h3>Tipos de alojamientos</h3>
  <hr class='separator' style="margin: 14px;">
  <p class="label5"><span class="value3">`r paste0(Gasto_tur_ta_hot, " €")`</span>Hoteleros</p>
  <p class="label5"><span class="value3">`r paste0(Gasto_tur_ta_extr, " €")`</span>Extrahoteleros</p>
  <p class="label5"><span class="value3">`r paste0(Gasto_tur_ta_otr, " €")`</span>Otros</p>
  </div>
</div>
</div>
</div>


<div class="row">
<div class="column indicator-title">
  <h3>Países de residencia</h3>
</div>
<div class="column indicator-title">
  <h3>Niveles de ingresos</h3>
</div>
</div>

<div class="row">
<div class="column highlight">
<div class="piramide" style="height: 190px;">
`r g_GM_pais`
</div>

<div class="progressbar-legend-container">
<div class='progressbar-legend'>
  <div class='progress-bar-C-b' style='margin-top: -9px;'>|</div><div class='sp-content-b' style='margin-top: 4px;'>Canarias</div></div>
</div>

</div>

<div class="column highlight">
<div class="piramide" style="height: 190px;">
`r g_GM_ni`
</div>

<div class="progressbar-legend-container">
<div class='progressbar-legend'>
  <div class='progress-bar-C-b' style='margin-top: -9px;'>|</div><div class='sp-content-b' style='margin-top: 4px;'>Canarias</div></div>
</div>

</div>
</div>

<div class="row">
<div class="column indicator-title">
  <h3>Grupos de edad</h3>
</div>
<div class="column indicator-title">
  <h3>Situaciones laborales</h3>
</div>
</div>

<div class="row">
<div class="column highlight" style="margin-bottom: -18px;">
<div class="row" style="margin-top: 10px">
  <div class="column-2">`r get_indicator4s("16 - 44", paste0(Gasto_por_turista_menor_C, " €"), paste0(Gasto_por_turista_menor, " €"))`</div>
  <div class="column-2">`r get_indicator4s("&gt; 44", paste0(Gasto_por_turista_mayor_C, " €"), paste0(Gasto_por_turista_mayor, " €"))`</div>
</div>
</div>
<div class="column highlight" style="margin-bottom: -18px;">
<div class="row" style="margin-top: 10px">
  <div class="column-2">`r get_indicator4s("Activos", paste0(Gasto_tur_sl_Act_C, " €"), paste0(Gasto_tur_sl_Act, " €"))`</div>
  <div class="column-2">`r get_indicator4s("No activos", paste0(Gasto_tur_sl_NAct_C, " €"), paste0(Gasto_tur_sl_NAct, " €"))`</div>
</div>
</div>
</div>

<div class="row">
<div class="column-3">
<div class="indicator-title" style="width: 100% !important; padding: 5px;">
  <h3>Niveles educativos</h3>
</div>
</div>
<div class="column-3">
<div class="indicator-title" style="width: 100% !important; padding: 5px;">
  <h3>Paquetes turísticos</h3>
</div>
</div>
<div class="column-3">
<div class="indicator-title" style="width: 100% !important; padding: 5px;">
  <h3>Noches pernoctadas</h3>
</div>
</div>
</div>

<div class="row">
<div class="column-3">
<div class="column highlight" style="width: 100% !important; margin-top: -30px;">
  <div class="piramide" style="height: 152px;">
  `r g_GM_ne`
  </div>
  <div class="legend-vertical-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_ne_plot$estudios[3]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue3' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_ne_plot$estudios[2]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_ne_plot$estudios[1]`</div></div>
  <div class='progressbar-legend'>
  <div class='progress-bar-C-b' style="margin-top: 1px;">|</div><div class='sp-content-b'>Canarias</div></div>
  </div>
</div>
</div>
<div class="column-3">
<div class="column highlight" style="width: 100% !important; margin-top: -30px;">
  <div class="piramide" style="height: 152px;">
  `r g_GM_pt`
  </div>
  <div class="legend-vertical-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_pt_plot$paquete[1]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue3' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_pt_plot$paquete[2]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_pt_plot$paquete[3]`</div></div>
  <div class='progressbar-legend'>
  <div class='progress-bar-C-b' style="margin-top: 1px;">|</div><div class='sp-content-b'>Canarias</div></div>
  </div>
</div>
</div>
<div class="column-3">
<div class="column highlight" style="width: 100% !important; margin-top: -30px;">
  <div class="piramide" style="height: 152px;">
  `r g_GM_np`
  </div>
  <div class="legend-vertical-container">
  <div class='progressbar-legend'><div class='progress-bar-blue1' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_np_plot$noches[3]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue3' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_np_plot$noches[2]`</div></div>
  <div class='progressbar-legend'><div class='progress-bar-blue6' style='font-size: 11px;'></div><div class='sp-content'>`r df_GM_np_plot$noches[1]`</div></div>
  <div class='progressbar-legend'>
  <div class='progress-bar-C-b' style="margin-top: 1px;">|</div><div class='sp-content-b'>Canarias</div></div>
  </div>
</div>
</div>

</div>


<div class="row" style="margin-top: 20px;">
</div>
<div class="logo-fecam">
  <img src="img/fecam.jpeg" />
</div>
<div class="logo-istac"> 
  <img src="img/logo_istac.png" />
</div>

